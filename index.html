<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-TECH SOLUTIONS | Electronics & Computer Projects</title> 
     <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczNty6_2Cq0hySwk_JWjLVcINZz0lyqfq9BNLXjr9-qhG_94UV7oQLhTNB7VtAP8qM1G06Gj36pEqbZyvBWZlV4508OriC45KwQoabQ8qSRc5HHMGPVu=w2400?source=screenshot.guru">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- UPDATED: Added necessary Firebase Social Auth imports -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Load KaTeX for beautiful math/symbol rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" xintegrity="sha384-Gvr4iO9rQk5QxK3m1i5hI9jP5i5E6qE6kQ5A0tE4Q4p5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" xintegrity="sha384-6Xh5n0k2f/rJvC9g2z8tN7i5hE6qE6kQ5A0tE4Q4p5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" xintegrity="sha384-FpYtW5m3gT/4t7/p/K0m6p+g5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    <!-- NEW: Load D3.js for Skill Tree Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            /* DARK THEME VARIABLES */
            --primary: #121212; /* Deep Dark Background */
            --secondary: #00e5ff; /* Cyan Accent - Main highlight */
            --accent: #ff4081; /* Pink Accent - Secondary highlight/call-to-action */
            --text-light: #ffffff; /* White text for visibility */
            --text-mid: #a0a0a0; /* Gray text for body/subtext */
            --card-bg: #1e1e1e; /* Slightly lighter card background */
            --border-color: #333333; /* Dark border lines */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary);
            color: var(--text-light); /* Ensure all body text is light */
            scroll-behavior: smooth;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* High Visibility Text */
        .glow-text {
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.2), 0 0 10px rgba(0, 229, 255, 0.4);
            color: var(--text-light);
        }
        
        /* NEW: E-TECH SOLUTIONS Heading Hover Effect */
        .logo-text.glow-text:hover {
            background: linear-gradient(135deg, var(--secondary), var(--accent), var(--secondary));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-gradient-shift 1s linear infinite;
            text-shadow: 0 0 10px rgba(255, 64, 129, 0.8), 0 0 20px rgba(0, 229, 255, 0.5);
            transition: all 0.5s ease-in-out;
        }

        @keyframes text-gradient-shift {
            to {
                background-position: 200% center;
            }
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        header {
            background: rgba(18, 18, 18, 0.85); /* Semi-transparent dark header */
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out; /* Added transform transition */
        }
        
        /* NEW: Header Hiding Class */
        header.header-hidden {
            transform: translateY(-100%);
        }

        .header-container {
            display: flex;
            /* FIX: Ensure content does not wrap unnecessarily */
            flex-wrap: nowrap; 
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            white-space: nowrap; /* Prevent wrapping in desktop/tablet */
            min-width: 0;
        }
        .logo-text span {
            color: var(--accent);
        }
        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            position: relative;
        }
        nav a:hover {
            color: var(--secondary);
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
        }
        nav a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
        }

        .mobile-toggle {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .hero {
            padding: 10rem 0;
            text-align: center;
            position: relative;
            /* Added deep space background image */
            background-image: url('https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow: hidden;
        }
        
        /* Overlay for contrast */
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
        }

        .hero > .container {
            position: relative;
            z-index: 2;
        }
        
        .hero h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--secondary);
            text-shadow: 0 0 15px var(--secondary);
        }
        
        .section {
            padding: 8rem 0;
            position: relative;
        }

        .section-title h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            display: inline-block;
            margin-bottom: 2rem;
            /* Ensure the text is visible with gradient */
            background: linear-gradient(45deg, var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
        }
        
        /* Card Styles (Dark Mode, High Visibility) */
        .card-3d {
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        .card-3d:hover {
            transform: scale(1.05) translateZ(10px);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4);
            border-color: var(--secondary);
        }
        
        .glassmorphism {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .neon-glow {
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }
        
        .btn-3d {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            color: var(--text-light); /* Default button text color */
        }
        
        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        /* NEW: Box Style for Action Buttons */
        .btn-box {
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* Styling for the Primary Action Buttons (Add to Cart, Checkout) */
        .btn-primary-action {
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            color: var(--text-light);
            border: none;
        }
        .btn-primary-action:hover {
            opacity: 0.9;
            box-shadow: 0 0 15px var(--secondary);
            transform: scale(1.02);
        }
        
        /* NEW: Buy Now Button Styling - Slightly different from primary to distinguish */
        .btn-buy-now {
            background-color: var(--accent);
            color: var(--text-light);
            border: none;
        }
        .btn-buy-now:hover {
            opacity: 0.9;
            box-shadow: 0 0 15px var(--accent);
            transform: scale(1.02);
        }


        /* Styling for the Secondary/Disabled Buttons (Available Soon) */
        .btn-secondary-action {
            background-color: var(--card-bg);
            color: var(--text-mid);
            border: 1px solid var(--secondary);
        }
        .btn-secondary-action.disabled {
            background-color: #333333;
            border-color: #555555;
            color: #777777;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Floating Button Positioning & Styling */
        #techwhiz-fab {
            bottom: 2rem;
            right: 2rem;
            z-index: 1001;
            width: 64px;
            height: 64px;
            border-radius: 0.5rem; /* Box Type */
        }

        /* TechWhiz Voice Active Indicator */
        #techwhiz-fab.speech-active {
            animation: pulse-ring 1.5s infinite;
            box-shadow: 0 0 30px rgba(0, 229, 255, 1);
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 229, 255, 0); }
            100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); }
        }

        #cart-fab {
            /* Positioned 4rem (64px button height + 16px gap) above techwhiz-fab (2rem) */
            bottom: 6rem;
            right: 2rem;
            z-index: 1002; /* Above techwhiz */
            width: 60px;
            height: 60px;
            border-radius: 0.5rem; /* Box Type */
            background: linear-gradient(145deg, var(--secondary), var(--accent));
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed; /* Added to ensure it floats */
        }
        
        #cart-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.7);
        }

        #cart-fab:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        #cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 9999px;
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            line-height: 1;
        }

        /* Cart Modal Styling (Futuristic, Slides In) */
        #cart-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px; /* Enhanced max width */
            height: 100%;
            background: var(--card-bg);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.7);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1003;
            display: flex;
            flex-direction: column;
            border-left: 2px solid var(--secondary); /* Neon border */
        }
        
        #cart-modal.open {
            transform: translateX(0);
        }
        
        .cart-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary); /* Header contrast */
        }
        
        .cart-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        #close-cart-btn {
            font-size: 2rem;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }
        
        #cart-modal-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
            background: var(--card-bg);
        }

        .cart-modal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .cart-modal-item img {
            min-width: 48px;
            min-height: 48px;
        }
        
        /* NEW: Cart Item Controls Styling */
        .cart-controls button {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .cart-controls button:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .cart-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--primary);
        }
        
        .cart-total-display {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 1rem;
        }
        
        .cart-total-display span:last-child {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(255, 64, 129, 0.5);
        }
        
        /* Component Detail Modal Styling */
        #component-detail-modal {
            background: rgba(0, 0, 0, 0.9);
            /* Centering fix applied here */
            display: none; /* Hidden by default */
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1005;
        }
        
        #component-detail-content {
            background: var(--card-bg);
            border: 1px solid var(--secondary);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            color: var(--text-light);
            max-width: 800px;
            width: 100%;
            padding: 2rem;
            border-radius: 0.75rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #component-detail-content .detail-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        #component-detail-content .detail-info h4 {
            color: var(--secondary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-family: 'Orbitron', sans-serif;
        }

        /* NEW: Canvas for Sensor Mock Visualization */
        #sensor-viz-canvas {
            width: 100%;
            height: 150px;
            background-color: #0d0d0d;
            border: 1px solid var(--accent);
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        /* New Styles for Dynamic Suggestions Sidebar */
        .suggestions-sidebar {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 250px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(5px);
            border-right: 2px solid var(--accent);
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            padding: 1rem;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            z-index: 999;
            max-height: 60vh;
            overflow-y: auto;
        }
        .suggestions-sidebar a {
            text-decoration: none;
        }
        .progress-bar-container {
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--secondary);
            transition: width 0.5s ease-in-out;
        }
        
        /* D3 Skill Tree Container */
        #skill-tree-container {
            width: 100%;
            height: 600px;
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            margin-top: 3rem;
            border: 1px solid var(--border-color);
            overflow: auto; /* Ensure tree is viewable */
        }
        
        /* D3 Node Styles */
        .node circle {
            cursor: pointer;
            fill: #555;
            stroke: var(--secondary);
            stroke-width: 3px;
            transition: all 0.3s;
        }
        .node.completed circle {
            fill: var(--secondary);
            stroke: var(--accent);
        }
        .node text {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            fill: var(--text-light);
        }
        .link {
            fill: none;
            stroke: #555;
            stroke-width: 1.5px;
            transition: stroke 0.3s;
        }
        .link.completed {
            stroke: var(--secondary);
        }

        /* --- NEW/UPDATED RESPONSIVE LAYOUT STYLES --- */
        
        /* Mobile: Default is stack (col-span-1) */
        .responsive-grid-section {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 2rem;
            padding: 0 1rem;
        }

        /* Tablet/Desktop: 2 columns */
        @media (min-width: 768px) {
            .responsive-grid-section {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        /* Large Desktop: 3 columns for projects/components section */
        @media (min-width: 1024px) {
            /* Applies to the main sections with component cards */
            /* NOTE: Relying on HTML classes (lg:grid-cols-X) for fine-grained control now. */
            /* Ensure Microcontrollers uses 4 columns on large screens */
            #microcontrollers .responsive-card-grid {
                 grid-template-columns: repeat(4, minmax(0, 1fr)); 
            }
        }
        
        /* Overriding existing tailwind classes for consistency */
        #basics .grid, #microcontrollers .grid, #sensors .grid, #projects .grid {
            display: grid;
            gap: 2rem;
        }

        /* Mobile Responsive Nav Menu (Auto-Hides) */
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
                color: var(--text-light);
            }
            /* FIX: Ensure logo text shrinks on mobile for fit */
            .logo-text {
                font-size: 1.5rem; 
            }
            
            nav ul {
                display: flex; /* Kept display: flex here to enable positioning */
                flex-direction: column;
                width: 100%;
                
                /* FIX: Use fixed position for true overlay */
                position: fixed; 
                top: 65px; 
                left: 0;
                right: 0;
                min-height: calc(100vh - 65px); 
                background: rgba(18, 18, 18, 0.95); 
                backdrop-filter: blur(8px); 
                border-top: 1px solid var(--border-color);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
                
                /* 1. INITIAL HIDE: Move the menu completely off-screen to the left */
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out; /* Use ease-in-out for smooth slide */
                
                overflow-y: auto; 
                z-index: 999; 
                padding-bottom: 2rem; 
            }
            /* 2. SHOW MENU: Only move the menu back into view when the 'active' class is present */
            nav ul.active {
                transform: translateX(0);
            }

            nav ul li {
                width: 100%;
                text-align: center;
                border-bottom: 1px solid var(--border-color); /* Corrected variable name */
            }
            nav ul li:last-child {
                border-bottom: none;
            }
            nav a {
                display: block;
                padding: 1rem 0;
            }
            .user-status {
                display: none;
            }
            .about-content, .contact-container {
                flex-direction: column;
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2.2rem;
            }
            
            /* The projects-grid fix is removed here, relying on Tailwind classes */
            
            #cart-modal {
                max-width: 100%; /* Full width on mobile */
            }

            #techwhiz-fab, #cart-fab {
                right: 1rem;
                bottom: 1rem;
                width: 50px;
                height: 50px;
            }

            #cart-fab {
                bottom: 4.5rem; /* 50px + 10px gap */
            }

            #component-detail-content, #project-detail-content {
                max-width: 100%;
                padding: 1rem;
            }
            .detail-content {
                flex-direction: column;
            }
            .suggestions-sidebar {
                display: none; /* Hide sidebar on mobile for space */
            }
        }
        
        /* Project Detail Modal Fixes for visibility */
        #project-detail-modal {
            background: rgba(0, 0, 0, 0.9);
            /* FIX: Set a high Z-index to ensure it appears instantly and on top of everything */
            z-index: 9999; /* MAXIMUM Z-INDEX */
        }

        #project-detail-content {
            background: var(--card-bg);
            border: 1px solid var(--secondary);
            color: var(--text-light);
            /* Ensure it is scrollable and constrained */
            max-height: 95vh; 
            overflow-y: auto;
        }
        
        /* New Styles for Project Detail Info Tabs */
        .project-detail-tabs button {
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            color: var(--text-mid);
        }
        .project-detail-tabs button.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
        }
        .project-detail-tab-content {
            padding-top: 1rem;
        }

        .close-project-detail {
            color: var(--text-light);
        }
        
        .project-detail-meta {
            color: var(--secondary);
        }

        .project-detail-info {
            color: var(--text-mid);
        }
        
        /* Component Detail Modal Fixes (Targeted for high visibility) */
        .component-detail {
            /* This section is removed as it's now replaced by #component-detail-modal */
            display: none !important;
        }
        
        /* Form input color fix */
        input:not(.razorpay-payment-button), textarea {
            background-color: #333333 !important;
            border-color: #555555 !important;
            color: var(--text-light) !important;
        }

        /* Overriding tailwind classes for text visibility */
        .text-gray-700 {
            color: var(--text-mid);
        }
        .text-black {
            color: var(--text-light);
        }
        .bg-gray-800 {
            background-color: #333 !important;
        }
        .bg-gray-900 {
            background-color: #121212 !important;
        }
        
        /* KaTeX specific style override for dark mode */
        .katex {
            color: var(--secondary);
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* FIX: Center all Modals */
        .modal-overlay-center {
            position: fixed;
            inset: 0;
            display: none; /* Hidden by default */
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 1rem;
            z-index: 1005;
            overflow-y: auto; /* Allow scrolling if content is too large */
        }
        
        /* NEW: Image scaling fix for component detail modal */
        #component-detail-content img {
            object-fit: contain; /* Ensures the whole image is visible without cropping */
            max-height: 200px; /* Optional: Constrain max height for better layout on desktop */
        }
    </style>
</head>
<body>
    <header id="main-header"> <!-- Added ID for JS scroll functionality -->
        <div class="container header-container">
            <div class="logo flex items-center">
                <img src="https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400" alt="INDRA" class="w-12 h-12 rounded-full border-2 border-secondary">
                <div class="logo-text ml-4 glow-text">E-TECH <span>SOLUTIONS</span></div>
            </div>
            <div class="mobile-toggle"><i class="fas fa-bars"></i></div>
            <nav>
                <ul id="nav-menu" class="flex list-none gap-6 text-xl">
                    <li><a href="#home" class="nav-link-3d active mobile-nav-link">Home</a></li>
                    <li><a href="#about" class="nav-link-3d mobile-nav-link">About</a></li>
                    <li><a href="#basics" class="nav-link-3d mobile-nav-link">Basics</a></li>
                    <li><a href="#microcontrollers" class="nav-link-3d mobile-nav-link">Microcontrollers</a></li>
                    <li><a href="#sensors" class="nav-link-3d mobile-nav-link">Sensors</a></li>
                    <li><a href="#courses" class="nav-link-3d mobile-nav-link">Courses</a></li>
                    <li><a href="#projects" class="nav-link-3d mobile-nav-link">Projects</a></li>
                    <li><a href="https://forms.gle/ruvWdt6W2N5QmdRN6" class="nav-link-3d mobile-nav-link">Contact</a></li>
                    <li id="user-nav">
                        <a href="#" id="login-btn-nav" class="nav-link-3d">Login</a>
                        <!-- UPDATED: Added click event to user avatar for profile modal -->
                        <div class="user-status flex items-center hidden" id="user-status">
                            <div id="user-avatar" class="user-avatar w-10 h-10 rounded-lg bg-secondary text-white flex items-center justify-center font-bold cursor-pointer hover:ring-2 ring-accent transition-all"></div>
                            <span id="user-name" class="ml-2"></span>
                            <a href="#" id="logout-btn" class="ml-4 nav-link-3d">Logout</a>
                            <a href="#" id="order-history-btn" class="ml-4 nav-link-3d">Orders</a>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero" id="home">
        <div class="container">
            <h1>Electronics & Computer Science Projects</h1>
            <p class="mt-4 text-lg text-gray-400 relative z-20">Master electronics and computer science by building real-world projects with our comprehensive learning resources.</p>
            <div class="hero-btns mt-10 relative z-20">
                <a href="#projects" class="btn btn-3d bg-secondary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg transition-all">Explore Projects</a>
                <a href="#courses" class="btn btn-3d border-2 border-secondary text-secondary hover:text-white hover:bg-secondary font-bold py-3 px-6 rounded-lg transition-all ml-4">View Courses</a>
                <a href="https://forms.gle/fgiNbFHnNMYH2QqW8" class="btn btn-3d btn-primary-action btn-box text-white font-bold transition-all ml-4">
                    <i class="fas fa-shopping-cart"></i> Buy Kits
                </a>
            </div>
        </div>
    </section>

    <section class="section" id="about">
        <div class="container">
            <div class="section-title text-center">
                <h2>About Me</h2>
            </div>
            <!-- Using responsive-grid-section for dual column layout on desktop/tablet -->
            <div class="about-content responsive-grid-section items-center justify-center card-3d glassmorphism p-8 neon-border">
                <div class="profile-img transform hover:rotate-3 transition-transform duration-500">
                    <img src="https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400" alt="INDRA" class="rounded-xl shadow-xl transition-all duration-500 hover:shadow-2xl hover:scale-105 border-4 border-secondary/50">
                </div>
                <div class="profile-info text-center md:text-left">
                    <h3 class="text-3xl font-bold font-orbitron text-white">Hi, I'm INDRA</h3>
                    <p class="mt-4 text-lg text-gray-400">I'm an electronics engineer and educator with over 3 years of experience in the field. My passion is to make electronics and computer science education accessible to everyone, regardless of their background or experience level.</p>
                    <div class="qualifications mt-6">
                        <h4 class="text-xl font-orbitron font-bold text-secondary">Qualifications</h4>
                        <ul class="list-none mt-2 text-gray-400">
                            <li class="flex items-center mt-2"><i class="fas fa-graduation-cap mr-2 text-secondary"></i> DIPLOMA in Electronics And Communication Engineering</li>
                            <li class="flex items-center mt-2"><i class="fas fa-certificate mr-2 text-secondary"></i> Certified IoT Specialist</li>
                            <li class="flex items-center mt-2"><i class="fas fa-briefcase mr-2 text-secondary"></i> 2+ years of industry experience</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="basics">
        <div class="container">
            <div class="section-title text-center">
                <h2>Electronic Basics</h2>
                <p class="text-gray-400">Learn the fundamental components that form the building blocks of all electronic devices</p>
            </div>
            <!-- UPDATED: Added responsive-card-grid class for fine-grained mobile control -->
            <!-- ADDED: grid-cols-1 sm:grid-cols-2 for better mobile stacking -->
            <div class="responsive-card-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-8 mt-12">
                <!-- Component Cards (Click to show details instantly in modal) -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="resistor" data-concept-id="resistor-basics">
                    <div class="component-icon"><i class="fas fa-bolt"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Resistor</h4>
                    <p class="text-sm mt-2 text-gray-400">Limit and control the flow of electric current</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="capacitor" data-concept-id="capacitor-basics">
                    <div class="component-icon"><i class="fas fa-battery-half"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Capacitor</h4>
                    <p class="text-sm mt-2 text-gray-400">Store and release electrical energy</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="inductor" data-concept-id="inductor-basics">
                    <div class="component-icon"><i class="fas fa-magnet"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Inductor</h4>
                    <p class="text-sm mt-2 text-gray-400">Store energy in a magnetic field</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="diode" data-concept-id="diode-basics">
                    <div class="component-icon"><i class="fas fa-arrow-right"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Diode</h4>
                    <p class="text-sm mt-2 text-gray-400">Allow current to flow in one direction</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="transistor" data-concept-id="transistor-basics">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Transistor</h4>
                    <p class="text-sm mt-2 text-gray-400">Act as electronic switches or amplifiers</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="ic" data-concept-id="ic-basics">
                    <div class="component-icon"><i class="fas fa-braille"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Integrated Circuit (IC)</h4>
                    <p class="text-sm mt-2 text-gray-400">Miniaturized circuits on a single chip</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="microcontrollers">
        <div class="container">
            <div class="section-title text-center">
                <h2>Microcontrollers</h2>
                <p class="text-gray-400">Explore popular microcontroller platforms for embedded systems development</p>
            </div>
            <!-- UPDATED: Added grid-cols-1 sm:grid-cols-2 for better mobile stacking -->
            <div class="responsive-card-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-8">
                <!-- Microcontroller Cards (Click to show details instantly in modal) -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-uno" data-concept-id="mcu-arduino-uno">
                    <div class="component-icon"><i class="fas fa-bolt"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Uno</h4>
                    <p class="text-sm mt-2 text-gray-400">The most popular Arduino board for beginners</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-nano" data-concept-id="mcu-arduino-nano">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Nano</h4>
                    <p class="text-sm mt-2 text-gray-400">A compact and breadboard-friendly version</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-mega" data-concept-id="mcu-arduino-mega">
                    <div class="component-icon"><i class="fas fa-list-ol"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Mega</h4>
                    <p class="text-sm mt-2 text-gray-400">Ideal for complex projects with many I/O pins</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="esp32" data-concept-id="mcu-esp32">
                    <div class="component-icon"><i class="fas fa-wifi"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">ESP32</h4>
                    <p class="text-sm mt-2 text-gray-400">Wi-Fi and Bluetooth enabled MCU</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="raspberrypi" data-concept-id="mcu-rpi-pico">
                    <div class="component-icon"><i class="fas fa-computer"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Raspberry Pi Pico</h4>
                    <p class="text-sm mt-2 text-gray-400">Powerful, low-cost MCU</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="stm32" data-concept-id="mcu-stm32">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">STM32</h4>
                    <p class="text-sm mt-2 text-gray-400">High-performance ARM-based MCUs</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="avr" data-concept-id="mcu-avr">
                    <div class="component-icon"><i class="fas fa-desktop"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">AVR</h4>
                    <p class="text-sm mt-2 text-gray-400">Used in many hobbyist projects</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="pic" data-concept-id="mcu-pic">
                    <div class="component-icon"><i class="fas fa-gear"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">PIC</h4>
                    <p class="text-sm mt-2 text-gray-400">Simple and reliable MCUs</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="sensors">
        <div class="container">
            <div class="section-title text-center">
                <h2>Sensors</h2>
                <p class="text-gray-400">Discover various sensors that enable interaction between the physical and digital worlds</p>
            </div>
            <!-- UPDATED: Using grid-cols-2 sm:grid-cols-3 for dense sensor section, which is generally acceptable on mobile -->
            <div class="responsive-card-grid grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 xl:grid-cols-6 gap-8">
                <!-- Sensor Cards (Click to show details instantly in modal) -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="ultrasonic" data-concept-id="sensor-ultrasonic">
                    <div class="component-icon"><i class="fas fa-wave-square"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Ultrasonic</h4>
                    <p class="text-sm mt-2 text-gray-400">Distance measurement using sound waves</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="pir" data-concept-id="sensor-pir">
                    <div class="component-icon"><i class="fas fa-running"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">PIR Motion</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect human movement in an area</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="temperature" data-concept-id="sensor-temperature">
                    <div class="component-icon"><i class="fas fa-thermometer-half"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Temperature</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure ambient temperature</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="humidity" data-concept-id="sensor-humidity">
                    <div class="component-icon"><i class="fas fa-tint"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Humidity</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure moisture in the air</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="light" data-concept-id="sensor-ldr">
                    <div class="component-icon"><i class="fas fa-lightbulb"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Light (LDR)</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure light intensity</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="gas" data-concept-id="sensor-gas">
                    <div class="component-icon"><i class="fas fa-cloud"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Gas (MQ series)</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect specific gases</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="soilmoisture" data-concept-id="sensor-soil">
                    <div class="component-icon"><i class="fas fa-seedling"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Soil Moisture</h4>
                    <p class="text-sm mt-2 text-gray-400">Check moisture levels in soil</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="rfid" data-concept-id="sensor-rfid">
                    <div class="component-icon"><i class="fas fa-id-card"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">RFID</h4>
                    <p class="text-sm mt-2 text-gray-400">Radio frequency identification technology</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="accelerometer" data-concept-id="sensor-accelerometer">
                    <div class="component-icon"><i class="fas fa-arrows-up-down-left-right"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Accelerometer</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure acceleration and tilt</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="sound" data-concept-id="sensor-sound">
                    <div class="component-icon"><i class="fas fa-volume-up"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Sound</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect and measure sound levels</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="heartbeat" data-concept-id="sensor-heartbeat">
                    <div class="component-icon"><i class="fas fa-heartbeat"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Heartbeat</h4>
                    <p class="text-sm mt-2 text-gray-400">Monitor heart rate and pulse</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="gesture" data-concept-id="sensor-gesture">
                    <div class="component-icon"><i class="fas fa-hand-rock"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Gesture</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect and interpret hand movements</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="courses">
        <div class="container">
            <div class="section-title text-center">
                <h2>Our Premium Courses</h2>
                <p class="text-gray-400">Unlock in-depth knowledge and advanced project building with our specialized courses.</p>
            </div>
            <!-- Already defaults to grid-cols-1 on mobile, which is good -->
            <div class="responsive-card-grid grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-3 gap-8">
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://lh3.googleusercontent.com/pw/AP1GczPvtSebwcEAoTS8k-OCNn_xZnUKH5rZXKAI4jLois7jfNsvPT14A1m11ZxNc1OFk6QXgYjp9lHolvmOWD8YnrbuP2acdqCFe_XIolbmvWSOd38hTmc=w2400" alt="Arduino Master" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">Arduino Master Class</h3>
                        <p class="text-gray-400 mt-2">Become a master of Arduino programming and hardware. This course covers advanced topics, complex projects, and troubleshooting techniques.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80" alt="AI for Robotics" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">AI for Robotics</h3>
                        <p class="text-gray-400 mt-2">Dive into the world of Artificial Intelligence applied to robotics. Learn machine learning fundamentals, computer vision, and robot navigation.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80" alt="IoT Course" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">Advanced IoT Development</h3>
                        <p class="text-gray-400 mt-2">Master the Internet of Things with advanced development techniques, cloud integration, data analytics, and security best practices.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="projects">
        <div class="container">
            <div class="section-title text-center">
                <h2>Electronics & CSE Projects</h2>
                <p class="text-gray-400">Browse our collection of IoT, Arduino, and Computer Science projects with complete guides and code.</p>
            </div>
            <!-- RECTIFIED: Filter buttons unified to rely solely on JavaScript for active styling -->
            <div class="project-filters flex justify-center flex-wrap gap-4 mb-8">
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-secondary" data-filter="all">All</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-secondary" data-filter="iot">IoT</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-secondary" data-filter="arduino">Arduino</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-secondary" data-filter="cse">Computer Science</button>
            </div>
            <!-- UPDATED: Changed grid-cols-2 to grid-cols-1 sm:grid-cols-2 for better small-screen stacking -->
            <div class="projects-grid responsive-card-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-8" id="projects-grid">
                <!-- Projects will be dynamically rendered here -->
            </div>
        </div>
    </section>
    
    <section class="section" id="contact">
        <div class="container">
            <div class="section-title text-center">
                <h2>Contact Me</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="contact-info flex flex-col gap-6">
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Location</h4>
                            <p class="text-gray-400">Sri Sathya Sai, India</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-phone"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Phone</h4>
                            <!-- FIXED: Added break-words class to prevent text overflow on mobile -->
                            <p class="text-gray-400 break-words">+91 9392090575, +91 9618646604, +91 7619457762</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-envelope"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Email</h4>
                            <p class="text-gray-400">etechsolutions9392@gmail.com</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-globe"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Website</h4>
                            <p class="text-gray-400">etechsolutions.co.in</p>
                        </div>
                    </div>
                </div>
                <form id="contactForm" class="contact-form glassmorphism p-8 rounded-xl neon-border flex flex-col gap-4">
                    <div class="form-group">
                        <label for="name" class="block mb-2 font-bold text-gray-400">Your Name</label>
                        <input type="text" id="name" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors text-white">
                    </div>
                    <div class="form-group">
                        <label for="email" class="block mb-2 font-bold text-gray-400">Email Address</label>
                        <input type="email" id="email" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <label for="subject" class="block mb-2 font-bold text-gray-400">Subject</label>
                        <input type="text" id="subject" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-secondary transition-colors">
                    </div>
                    <div class="form-group">
                        <label for="message" class="block mb-2 font-bold text-gray-400">Message</label>
                        <textarea id="message" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors text-white"></textarea>
                    </div>
                    <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full mt-4">Send Message</button>
                </form>
            </div>
        </div>
    </section>

    <footer class="bg-card-bg p-8 border-t border-border-color">
        <div class="container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="footer-col">
                    <h4 class="font-orbitron text-xl font-bold text-white">E-TECH SOLUTIONS</h4>
                    <p class="text-sm mt-4 text-gray-400">Providing high-quality e-learning resources for electronics enthusiasts and students worldwide.</p>
                    <div class="social-links flex gap-4 mt-4">
                        <a href="https://www.facebook.com/share/1YqHbBfq8W/" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-secondary hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://www.instagram.com/e_techsolutions_?igsh=am0wa3ZoY2c5ZDE=" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-accent hover:text-white transition-colors"><i class="fab fab fa-instagram"></i></a>
                        <a href="https://youtube.com/@e-techsolutions-techwhiz?si=rWXLsO87Y93k34dF" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Learning Resources</h4>
                    <ul class="list-none mt-4 text-gray-400">
                        <li><a href="#basics" class="hover:text-secondary transition-colors">Electronics Basics</a></li>
                        <li><a href="#microcontrollers" class="hover:text-secondary transition-colors">Microcontrollers</a></li>
                        <li><a href="#sensors" class="hover:text-secondary transition-colors">Sensors</a></li>
                        <li><a href="#courses" class="hover:text-secondary transition-colors">Courses</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Quick Links</h4>
                    <ul class="list-none mt-4 text-gray-400">
                        <li><a href="#home" class="hover:text-secondary transition-colors">Home</a></li>
                        <li><a href="#about" class="hover:text-secondary transition-colors">About</a></li>
                        <li><a href="#projects" class="hover:text-secondary transition-colors">Projects</a></li>
                        <li><a href="https://forms.gle/ruvWdt6W2N5QmdRN6" class="hover:text-secondary transition-colors">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Newsletter</h4>
                    <p class="text-sm mt-4 text-gray-400">Subscribe for the latest tutorials and project ideas.</p>
                    <form>
                        <input type="email" placeholder="Your Email Address" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors mt-4 text-white">
                        <a href="https://forms.gle/ruvWdt6W2N5QmdRN6"><button type="submit" class="btn btn-3d btn-primary-action btn-box w-full mt-4">Subscribe</button></a>
                    </form>
                </div>
            </div>
            <div class="text-center mt-8 text-gray-500 text-sm border-t border-border-color pt-6">
                &copy; 2025 E-TECH SOLUTIONS. All Rights Reserved.
            </div>
        </div>
    </footer>

   
    <!-- Chatbot Button (Z-index 1001, bottom: 2rem) -->
    <button id="techwhiz-fab" class="btn btn-3d fixed w-16 h-16 flex items-center justify-center text-3xl text-white focus:outline-none focus:ring-4 focus:ring-secondary/50" style="background: linear-gradient(145deg, var(--secondary), var(--accent));">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- Floating Cart Button (Z-index 1002, bottom: 6rem, above TechWhiz) -->
    <button id="cart-fab" class="fixed text-xl text-white focus:outline-none">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count">0</span>
    </button>
    
    <!-- Cart Modal (Advanced Floating Panel) -->
    <div id="cart-modal">
        <div class="cart-header">
            <h3 class="text-white">Your Cart (<span id="cart-item-count-header">0</span>)</h3>
            <button id="close-cart-btn" class="text-white hover:text-accent">&times;</button>
        </div>
        <div id="cart-modal-items" class="bg-card-bg">
            <p class="cart-empty-msg text-gray-400 text-center p-8">Your cart is currently empty. Start exploring projects!</p>
        </div>
        <div class="cart-footer bg-card-bg">
            <div class="cart-total-display">
                <span class="text-white">Total:</span>
                <span id="cart-total-price">₹0</span>
            </div>
            <button id="cart-checkout-btn" class="btn btn-3d btn-primary-action btn-box w-full">Proceed to Checkout</button>
        </div>
    </div>
    
    <!-- Component Detail MODAL (Overlay component details here) -->
    <div id="component-detail-modal">
        <div id="component-detail-content" class="glassmorphism p-8 rounded-xl relative">
            <div class="detail-header flex justify-between items-center">
                <h3 class="font-orbitron text-2xl font-bold text-secondary" id="detail-title">Component Details</h3>
                <button class="close-detail absolute top-4 right-4 text-4xl text-gray-400 hover:text-accent transition-colors">&times;</button>
            </div>
            <div class="detail-content flex flex-col md:flex-row gap-8 mt-6">
                <!-- IMPORTANT: Removed object-cover and set max-height to 200px in CSS class above for object-fit: contain -->
                <img id="detail-img" src="https://via.placeholder.com/400x300" alt="Component" class="rounded-lg shadow-lg w-full md:w-1/3 object-cover border-2 border-secondary/50">
                <div class="detail-info flex-1">
                    <h4 class="font-bold text-lg text-secondary">Definition</h4>
                    <p id="detail-definition" class="text-gray-400"></p>
                    <h4 class="font-bold text-lg text-secondary mt-4">Symbol</h4>
                    <div id="detail-symbol" class="text-gray-400 p-2 border border-border-color rounded-lg mt-1"></div>
                    <!-- NEW: Sensor Visualization Container (only visible for sensor types) -->
                    <div id="sensor-visualization-area" class="mt-4 hidden">
                         <h4 class="font-bold text-lg text-accent">Live Data Mock-up</h4>
                         <canvas id="sensor-viz-canvas"></canvas>
                         <p id="sensor-data-readout" class="text-sm text-gray-500 mt-1 italic">Status: Idle</p>
                    </div>
                    <!-- END: Sensor Visualization Container -->
                    <h4 class="font-bold text-lg text-secondary mt-4">Characteristics</h4>
                    <ul id="detail-characteristics" class="list-disc ml-6 text-gray-400"></ul>
                    <h4 class="font-bold text-lg text-secondary mt-4">Applications</h4>
                    <p id="detail-applications" class="text-gray-400"></p>
                </div>
            </div>
            <div class="mt-8">
                <button id="ask-techwhiz-component-btn" class="btn btn-3d btn-secondary-action btn-box w-full">
                    <i class="fas fa-robot mr-2"></i> Ask TechWhiz About This Component
                </button>
            </div>
        </div>
    </div>
    <!-- END: Component Detail MODAL -->
    
    <!-- Chatbox Modal -->
    <div id="techwhiz-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div id="assistant-chat-modal-content" class="rounded-lg shadow-2xl max-w-lg w-full bg-gray-900 border border-secondary/20">
            <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center rounded-t-lg">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-robot mr-3 text-secondary"></i>TECHWHIZ Assistant</h3>
                <button id="close-techwhiz-modal" class="text-gray-400 hover:text-white text-4xl leading-none">&times;</button>
            </div>
            <div id="chat-history" class="p-4 overflow-y-auto h-[400px] flex flex-col-reverse gap-3">
                <div class="chat-message assistant p-3 rounded-lg rounded-bl-none self-start mr-auto bg-gray-800 text-white" style="font-size:15px; font-weight:normal; padding:10px; border-radius:10px; margin-right:auto;">Hello! How can I help you today with electronics and CSE concepts?</div>
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-900">
                <div class="flex items-center space-x-2">
                    <input type="text" id="techwhiz-input" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-secondary transition-colors" placeholder="Ask me anything...">
                    <button id="mic-btn" class="btn btn-3d bg-secondary hover:bg-accent text-white py-3 px-4 rounded-lg"><i class="fas fa-microphone"></i></button>
                    <button id="send-btn" class="btn btn-3d bg-secondary hover:bg-accent text-white py-3 px-4 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button id="stop-speech-btn" class="btn bg-accent hover:bg-red-700 py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-volume-mute mr-2"></i>Stop Voice Output
                    </button>
                    <span id="listening-status" class="text-sm text-gray-500 italic hidden">Listening...</span>
                    <span id="thinking-status" class="text-sm text-secondary italic hidden">Thinking...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="auth-modal" class="modal-overlay-center">
        <!-- LOGIN MODAL CONTAINER - Centered via items-center and justify-center -->
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-md w-full border border-secondary/20">
            <div class="flex justify-end"><button class="close-auth text-3xl text-gray-400 hover:text-white">&times;</button></div>
            <div class="auth-tabs flex justify-around mb-6 border-b border-gray-700">
                <div class="auth-tab text-xl font-bold py-2 px-4 cursor-pointer text-secondary active" data-tab="login">Login</div>
                <div class="auth-tab text-xl font-bold py-2 px-4 cursor-pointer text-gray-400" data-tab="register">Register</div>
            </div>
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Email" required>
                <input type="password" id="login-password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-6 focus:outline-none focus:border-secondary" placeholder="Password" required>
                <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full">Login</button>
            </form>
            
            <!-- Register Form -->
            <form id="register-form" class="auth-form hidden">
                <input type="text" id="register-name" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Full Name" required>
                <input type="email" id="register-email" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Email" required>
                <input type="password" id="register-password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-6 focus:outline-none focus:border-secondary" placeholder="Password" required>
                <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full">Register</button>
            </form>

            <!-- Social Login Options -->
            
        </div>
    </div>

    <!-- Order History Modal -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="order-history-modal" class="modal-overlay-center">
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-lg w-full border border-secondary/20">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold font-orbitron text-secondary">Your Order History</h2>
                <button class="close-history text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="order-history-list" class="mt-6 h-[400px] overflow-y-auto">
                <p class="text-center text-gray-500">You have no past orders.</p>
            </div>
        </div>
    </div>
    
    <!-- NEW: Profile Management Modal -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="profile-modal" class="modal-overlay-center">
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-xl w-full border border-accent/20">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold font-orbitron text-accent"><i class="fas fa-user-cog mr-2"></i> User Profile & Settings</h2>
                <button id="close-profile-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            
            <div class="mt-6 grid grid-cols-1 gap-6"> <!-- CHANGED: Removed unnecessary md:grid-cols-2 -->
                <!-- User Info -->
                <div class="glassmorphism p-4 rounded-lg border border-border-color">
                    <h3 class="text-xl font-bold text-secondary mb-3">Account Details</h3>
                    <p class="text-gray-400"><strong>Display Name:</strong> <span id="profile-display-name" class="text-white"></span></p>
                    <p class="text-gray-400"><strong>Email:</strong> <span id="profile-email" class="text-white"></span></p>
                    <p class="text-gray-400"><strong>User ID:</strong> <span id="profile-user-id" class="text-xs text-accent break-all"></span></p>
                    <button id="edit-profile-btn" class="btn btn-3d btn-secondary-action py-2 px-4 mt-4 w-full">Edit Name</button>
                </div>
                
            </div> <!-- CHANGED: Removed Project List Section here -->
            
            <div class="mt-6 border-t border-border-color pt-6 text-center">
                 <button id="profile-logout-btn" class="btn btn-3d bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg">Sign Out</button>
            </div>
        </div>
    </div>
    <!-- END: Profile Management Modal -->


    <!-- Project Detail Modal (FIXED: Ensuring immediate display on click) -->
    <!-- NOTE: #project-detail-modal Z-index is 9999 for maximum priority -->
    <div id="project-detail-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4" style="z-index: 9999;">
        <div id="project-detail-content" class="glassmorphism p-8 rounded-xl max-w-3xl w-full relative">
            <button class="close-project-detail absolute top-4 right-4 text-4xl text-white hover:text-secondary">&times;</button>
            <div class="text-xl font-orbitron font-bold text-secondary mb-3">E-TECH SOLUTIONS Project Details</div>
            
            <!-- Project Image & Quick Info -->
            <div class="flex flex-col md:flex-row gap-6">
                <img id="project-detail-image" src="" alt="Project Image" class="rounded-lg w-full md:w-1/3 h-48 object-cover border-2 border-secondary/50">
                <div class="flex-1">
                    <h3 class="text-3xl font-orbitron font-bold text-white" id="project-detail-title"></h3>
                    <div class="project-detail-meta flex flex-wrap gap-4 text-sm mt-2">
                        <span id="project-detail-time" class="text-white"><i class="fas fa-clock text-secondary"></i></span>
                        <span id="project-detail-chip" class="text-white"><i class="fas fa-microchip text-secondary"></i></span>
                        <span id="project-detail-theme" class="text-white"><i class="fas fa-lightbulb text-secondary"></i> Theme: <span id="theme-value">N/A</span></span>
                    </div>
                    <p class="mt-4 text-gray-400" id="project-detail-description"></p>
                </div>
            </div>
            
            <!-- NEW: Tabbed Content for Detailed Information -->
            <div class="mt-6">
                 <div class="project-detail-tabs flex border-b border-border-color gap-4 overflow-x-auto">
                    <button class="py-2 px-1 text-base active" data-tab-target="#tab-details">Details & Aim</button>
                    <button class="py-2 px-1 text-base" data-tab-target="#tab-features">Features & Uses</button>
                    <button class="py-2 px-1 text-base" data-tab-target="#tab-requirements">Requirements</button>
                    <button id="ask-techwhiz-detail-btn-tab" class="py-2 px-1 text-base text-accent hover:text-secondary" data-tab-target="#tab-techwhiz">Ask TechWhiz</button>
                 </div>
                 
                 <div id="project-detail-tab-wrapper" class="project-detail-tab-content">
                    <!-- Tab 1: Details & Aim -->
                    <div id="tab-details" data-tab-content class="active">
                        <h4 class="text-xl font-bold text-secondary mt-4">Project Aim</h4>
                        <p id="project-detail-aim" class="text-gray-400 mt-2 italic"></p>
                        
                        <h4 class="text-xl font-bold text-secondary mt-4">Applications & Uses</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-applications"><li>N/A</li></ul>
                        
                        <h4 class="text-xl font-bold text-secondary mt-4">E-TECH Advantages</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-advantages"><li>N/A</li></ul>
                        
                        <!-- NEW: Sensor View Section (Hidden if no relevant sensors) -->
                        <div id="project-sensor-view" class="mt-6 p-4 rounded-lg glassmorphism hidden">
                            <h4 class="text-xl font-bold text-accent"><i class="fas fa-satellite-dish mr-2"></i> Sensor View (Data Flow)</h4>
                            <ul class="flex flex-wrap gap-3 mt-3" id="project-detail-sensors-used"></ul>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Key Features -->
                    <div id="tab-features" data-tab-content class="hidden">
                        <h4 class="text-xl font-bold text-secondary mt-4">Key Features</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-features"><li>N/A</li></ul>
                    </div>
                    
                    <!-- Tab 3: Requirements -->
                    <div id="tab-requirements" data-tab-content class="hidden">
                         <h4 class="text-xl font-bold text-secondary mt-4">Required Components</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-components"><li>N/A</li></ul>
                    </div>
                    
                    <!-- Tab 4: AI Summary / TechWhiz Interaction -->
                    <div id="tab-techwhiz" data-tab-content class="hidden">
                        <h4 class="text-xl font-bold text-secondary mt-4">AI-Powered Overview</h4>
                        <button id="ai-summary-btn" class="btn btn-3d bg-accent text-white py-2 px-4 rounded-lg mt-2 w-full">AI-Powered Summary ✨</button>
                        <div id="ai-summary-container" class="glassmorphism p-4 mt-4 rounded-lg border border-accent/50">
                            <p id="ai-summary-text" class="text-sm italic text-gray-400">Click the button above for an intelligent summary...</p>
                        </div>
                        
                        <h4 class="text-xl font-bold text-secondary mt-6">Expert Q&A</h4>
                        <button id="ask-techwhiz-detail-btn" class="btn btn-3d btn-secondary-action btn-box w-full mt-2">
                             <i class="fas fa-robot mr-2"></i> Ask TechWhiz About This Project
                        </button>
                    </div>
                 </div>
            </div>

                <!-- Action Buttons: Buy Now and Add to Cart -->
                <div class="mt-8 flex gap-4 justify-between">
                    <a id="buy-now-from-detail" target="_blank" class="btn btn-3d btn-buy-now btn-box flex-1 text-lg">
                        <i class="fas fa-bolt mr-2"></i> Buy Kit Now
                    </a>
                    <button id="add-to-cart-from-detail" class="btn btn-3d btn-primary-action btn-box flex-1 text-lg">
                        <i class="fas fa-cart-plus mr-2"></i> Add to Cart
                    </button>
                </div>
                
                <button id="simulator-placeholder-btn" class="btn btn-3d bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded-lg mt-4 w-full">
                    <i class="fas fa-microchip mr-2"></i> Embedded Circuit Simulator (Coming Soon)
                </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Config & Setup ---
            const __app_id = "default-app-id";
            const __firebase_config = '{"apiKey": "AIzaSyCyk9Jg_FW7jbVFh5XasK1Vb8_sP8J4zSE", "authDomain": "etech-d39e5.firebaseapp.com", "projectId": "etech-d39e5", "storageBucket": "etech-d39e5.firebasestorage.app", "messagingSenderId": "323388421053", "appId": "1:323388421053:web:9057d22d4ee4b7450398d4", "measurementId": "G-EV7M78EBGC"}';
            
            const firebaseConfig = JSON.parse(__firebase_config);
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            firebase.firestore.setLogLevel('debug');

            // --- UI Elements ---
            const mainHeader = document.getElementById('main-header'); // Get the main header
            const authModal = document.getElementById('auth-modal');
            const loginBtnNav = document.getElementById('login-btn-nav');
            const closeAuthBtn = document.querySelector('.close-auth');
            const authTabs = document.querySelectorAll('.auth-tab');
            const authForms = document.querySelectorAll('.auth-form');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const userStatus = document.getElementById('user-status');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileToggle = document.querySelector('.mobile-toggle');
            const navMenu = document.getElementById('nav-menu');
            // NEW: Select all mobile nav links
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link'); 
            const techwhizFab = document.getElementById('techwhiz-fab');
            const techwhizModal = document.getElementById('techwhiz-modal');
            const closeTechwhizModalBtn = document.getElementById('close-techwhiz-modal');
            const chatHistory = document.getElementById('chat-history');
            const techwhizInput = document.getElementById('techwhiz-input');
            const micBtn = document.getElementById('mic-btn');
            const sendBtn = document.getElementById('send-btn');
            const stopSpeechBtn = document.getElementById('stop-speech-btn');
            const listeningStatus = document.getElementById('listening-status');
            const thinkingStatus = document.getElementById('thinking-status');
            const orderHistoryBtn = document.getElementById('order-history-btn');
            const orderHistoryModal = document.getElementById('order-history-modal');
            const closeHistoryBtn = document.querySelector('.close-history');
            const orderHistoryList = document.getElementById('order-history-list');
            const projectsGrid = document.getElementById('projects-grid');
            const filterBtns = document.querySelectorAll('.filter-btn');
            const projectDetailModal = document.getElementById('project-detail-modal');
            const closeProjectDetailBtn = document.querySelector('.close-project-detail');
            const projectDetailTitle = document.getElementById('project-detail-title');
            const projectDetailImage = document.getElementById('project-detail-image');
            const projectDetailDescription = document.getElementById('project-detail-description');
            const projectDetailTime = document.getElementById('project-detail-time');
            const projectDetailChip = document.getElementById('project-detail-chip');
            const projectDetailFeatures = document.getElementById('project-detail-features');
            const projectDetailComponents = document.getElementById('project-detail-components');
            
            // --- NEW Project Detail Elements ---
            const projectDetailApplications = document.getElementById('project-detail-applications');
            const projectDetailAdvantages = document.getElementById('project-detail-advantages');
            const projectDetailAim = document.getElementById('project-detail-aim'); // NEW
            const projectDetailThemeValue = document.getElementById('theme-value'); // NEW
            const projectSensorView = document.getElementById('project-sensor-view');
            const projectDetailSensorsUsed = document.getElementById('project-detail-sensors-used');

            const addToCartFromDetailBtn = document.getElementById('add-to-cart-from-detail');
            const buyNowFromDetailBtn = document.getElementById('buy-now-from-detail'); 
            
            const aiSummaryBtn = document.getElementById('ai-summary-btn');
            const aiSummaryContainer = document.getElementById('ai-summary-container');
            const aiSummaryText = document.getElementById('ai-summary-text');
            const simulatorPlaceholderBtn = document.getElementById('simulator-placeholder-btn');
            
            // NEW: Project Detail Tabs
            const projectDetailTabBtns = document.querySelectorAll('.project-detail-tabs button');
            const projectDetailTabWrapper = document.getElementById('project-detail-tab-wrapper');
            const askTechwhizDetailBtn = document.getElementById('ask-techwhiz-detail-btn'); // Button in the content pane
            const askTechwhizDetailBtnTab = document.getElementById('ask-techwhiz-detail-btn-tab'); // Button in the tab bar


            // --- Component Detail Modal Elements ---
            const componentCards = document.querySelectorAll('.component-card');
            const componentDetailModal = document.getElementById('component-detail-modal');
            const detailTitle = document.getElementById('detail-title');
            const detailImg = document.getElementById('detail-img');
            const detailDefinition = document.getElementById('detail-definition');
            const detailSymbol = document.getElementById('detail-symbol');
            const detailCharacteristics = document.getElementById('detail-characteristics');
            const detailApplications = document.getElementById('detail-applications');
            const closeDetailBtn = document.querySelector('#component-detail-modal .close-detail');
            const askTechwhizComponentBtn = document.getElementById('ask-techwhiz-component-btn');
            // NEW Sensor Visualization elements
            const sensorVizArea = document.getElementById('sensor-visualization-area');
            const sensorVizCanvas = document.getElementById('sensor-viz-canvas');
            const sensorDataReadout = document.getElementById('sensor-data-readout');
            let sensorVizInterval = null; // To hold the setInterval reference
            
            // --- Cart Elements ---
            const cartFab = document.getElementById('cart-fab');
            const cartModal = document.getElementById('cart-modal');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartModalItemsContainer = document.getElementById('cart-modal-items');
            const cartTotalPriceElement = document.getElementById('cart-total-price');
            const cartCountElement = document.getElementById('cart-count');
            const cartItemCountHeader = document.getElementById('cart-item-count-header');
            const cartCheckoutBtn = document.getElementById('cart-checkout-btn');

            // --- Profile Modal Elements ---
            const profileModal = document.getElementById('profile-modal');
            const closeProfileBtn = document.getElementById('close-profile-btn');
            const profileDisplayName = document.getElementById('profile-display-name');
            const profileEmail = document.getElementById('profile-email');
            const profileUserId = document.getElementById('profile-user-id');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const profileLogoutBtn = document.getElementById('profile-logout-btn');
            const profileConceptsCount = document.getElementById('profile-concepts-count');
            const profileProjectsCount = document.getElementById('profile-projects-count');
            const profileOverallProgressBar = document.getElementById('profile-overall-progress-bar');
            
            // --- Progress Elements ---
            const suggestionsSidebar = document.querySelector('.suggestions-sidebar');
            const dynamicSuggestionsContent = document.getElementById('dynamic-suggestions-content');
            const overallProgressBar = document.getElementById('overall-progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            
            let cart = [];
            let userProgress = {}; // Stores { conceptId: true/false }
            let allConcepts = []; // Array of all concepts from Skill Tree data
            let userId = null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const progressCollectionPath = () => `artifacts/${appId}/users/${userId}/progress`;

            // --- Skill Tree Data Structure (Unchanged) ---
            const skillTreeData = {
                id: "root",
                name: "E-TECH Path",
                children: [
                    {
                        id: "level1-basics",
                        name: "Level 1: Electronics Fundamentals",
                        children: [
                            { id: "resistor-basics", name: "Resistor", type: "concept" },
                            { id: "capacitor-basics", name: "Capacitor", type: "concept", parentId: "resistor-basics" },
                            { id: "diode-basics", name: "Diode", type: "concept", parentId: "capacitor-basics" },
                            { id: "project-blinking-led", name: "Project: Blinking LED", type: "project", parentId: "diode-basics" }
                        ]
                    },
                    {
                        id: "level2-microcontrollers",
                        name: "Level 2: MCUs & Logic",
                        parentId: "project-blinking-led",
                        children: [
                            { id: "mcu-arduino-uno", name: "Arduino Uno", type: "concept" },
                            { id: "transistor-basics", name: "Transistor", type: "concept", parentId: "mcu-arduino-uno" },
                            { id: "project-traffic-light", name: "Project: Traffic Light", type: "project", parentId: "transistor-basics" },
                            { id: "mcu-esp32", name: "ESP32 & WiFi", type: "concept", parentId: "project-traffic-light" }
                        ]
                    },
                    {
                         id: "level3-sensing",
                         name: "Level 3: Sensing & IoT",
                         parentId: "mcu-esp32",
                         children: [
                             { id: "sensor-ultrasonic", name: "Ultrasonic Sensor", type: "concept" },
                             { id: "sensor-pir", name: "PIR Motion Sensor", type: "concept" },
                             { id: "project-smart-alarm", name: "Project: Smart Alarm", type: "project", parentId: "sensor-ultrasonic" },
                             { id: "project-smart-alarm-iot", name: "Project: IoT Alarm", type: "project", parentId: "project-smart-alarm" }
                         ]
                    }
                ]
            };
            
            function extractAllConcepts(node) {
                if (node.type === 'concept' || node.type === 'project') {
                    allConcepts.push(node.id);
                }
                if (node.children) {
                    node.children.forEach(extractAllConcepts);
                }
            }
            extractAllConcepts(skillTreeData);
            const totalConcepts = allConcepts.length;
            
            // --- D3.js Skill Tree Rendering (Unchanged) ---
            function renderSkillTree(progress) {
                const container = document.getElementById('skill-tree-container');
                container.innerHTML = ''; // Clear previous tree
                
                const width = container.clientWidth;
                const height = 600;
                
                const svg = d3.select("#skill-tree-container").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .style("overflow", "visible")
                    .append("g")
                    .attr("transform", `translate(40, 0)`); // Shift tree right for nodes

                const treeLayout = d3.tree()
                    .size([height, width - 160]); // Size of the drawing area

                // Define links based on parentId for non-nested children
                function restructureData(data) {
                    const nodesMap = new Map();
                    const process = (node) => {
                        nodesMap.set(node.id, node);
                        if (node.children) {
                            node.children.forEach(process);
                        }
                    };
                    process(data);

                    // Manually assign children based on parentId fields
                    const rootNode = nodesMap.get("root");
                    const level1 = rootNode.children[0];
                    const level2 = rootNode.children[1];
                    const level3 = rootNode.children[2];
                    
                    // Clear default hierarchy structure for flat/linear linking
                    rootNode.children = [level1, level2, level3]; 

                    // Define sequential links within levels
                    level1.children[0].children = [level1.children[1]]; // Resistor -> Capacitor
                    level1.children[1].children = [level1.children[2]]; // Capacitor -> Diode
                    level1.children[2].children = [level1.children[3]]; // Diode -> Blinking LED

                    level2.children[0].children = [level2.children[1]]; // Arduino Uno -> Transistor
                    level2.children[1].children = [level2.children[2]]; // Transistor -> Traffic Light
                    level2.children[2].children = [level2.children[3]]; // Traffic Light -> ESP32

                    level3.children[0].children = [level3.children[2]]; // Ultrasonic -> Smart Alarm
                    level3.children[1].children = []; // PIR is a parallel path
                    level3.children[2].children = [level3.children[3]]; // Smart Alarm -> IoT Alarm
                    
                    // Link between levels
                    level1.children[3].children = [level2]; // Blinking LED -> Level 2
                    level2.children[3].children = [level3]; // ESP32 -> Level 3

                    return d3.hierarchy(rootNode);
                }

                const root = restructureData(JSON.parse(JSON.stringify(skillTreeData))); // Deep clone for modification
                
                // Set custom node depths for better horizontal flow
                root.each(d => {
                    const nodesMap = new Map(root.descendants().map(d => [d.data.id, d]));
                    if (d.data.id.includes('level1')) d.depth = 1;
                    else if (d.data.id.includes('level2')) d.depth = 2;
                    else if (d.data.id.includes('level3')) d.depth = 3;
                    else if (d.data.parentId && nodesMap.get(d.data.parentId)) {
                        d.depth = nodesMap.get(d.data.parentId).depth + 1;
                    } else if (d.data.parentId) {
                         // Fallback for nodes like 'resistor-basics' that are first in their level
                        d.depth = d.data.id.includes('basics') ? 2 : (d.data.id.includes('mcu') ? 3 : 4);
                    }
                });

                treeLayout(root);

                const nodesMap = new Map(root.descendants().map(d => [d.data.id, d]));

                // 1. Draw Links
                const link = svg.selectAll(".link")
                    .data(root.links())
                    .enter().append("path")
                    .attr("class", d => `link ${progress[d.target.data.parentId] ? 'completed' : ''}`)
                    .attr("d", d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                    );

                // 2. Draw Nodes
                const node = svg.selectAll(".node")
                    .data(root.descendants())
                    .enter().append("g")
                    .attr("class", d => `node ${d.children ? 'internal' : 'leaf'} ${progress[d.data.id] ? 'completed' : ''}`)
                    .attr("transform", d => `translate(${d.y},${d.x})`);

                // Add circles
                node.append("circle")
                    .attr("r", d => d.data.id === 'root' ? 0 : (d.children ? 6 : 10))
                    .attr("stroke-width", d => d.data.id === 'root' ? 0 : 3)
                    .on("click", (event, d) => {
                        if (d.data.type === 'concept' || d.data.type === 'project') {
                             handleConceptClick(d.data.id, progress);
                        }
                    })
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr('r', d.children ? 8 : 12).style("fill", varFromTailwind('--accent'));
                        showToast(d.data.name + (progress[d.data.id] ? ' (Completed)' : ' (Pending)'), 'secondary');
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this).attr('r', d.children ? 6 : 10).style("fill", progress[d.data.id] ? varFromTailwind('--secondary') : '#555');
                    });

                // Add text labels
                node.append("text")
                    .attr("dy", d => d.children ? 20 : 15)
                    .attr("text-anchor", "middle")
                    .text(d => d.data.name)
                    .style("fill", varFromTailwind('--text-light'));
                    
                // Add icons for completed nodes
                node.filter(d => progress[d.data.id] && (d.data.type === 'concept' || d.data.type === 'project'))
                    .append("text")
                    .attr("dy", 4)
                    .attr("text-anchor", "middle")
                    .attr("class", "fas text-lg")
                    .style("font-family", "FontAwesome")
                    .style("fill", varFromTailwind('--primary'))
                    .text('\uf058'); // Checkmark icon
            }

            function handleConceptClick(conceptId, progress) {
                 if (userId) {
                    if (progress[conceptId]) {
                        showToast(`${conceptId} already completed!`, 'secondary');
                    } else {
                        // Check dependencies (simplified mock check)
                        let isDependencyComplete = true;
                        // Simplified check: allow completion if a dependency is marked as 'completed'
                        // In a real app, this would require traversing the dependency chain.
                        // For the purpose of this demo, we'll keep the mock simple.
                        
                        if (isDependencyComplete) {
                            toggleConceptCompletion(conceptId, true);
                        } else {
                             showToast(`Must complete prerequisite before starting ${conceptId}.`, 'accent');
                        }
                    }
                } else {
                    showToast("Please log in to track your progress.", 'accent');
                }
            }
            
            // --- Progress Tracking (Firestore) (Unchanged) ---
            
            async function toggleConceptCompletion(conceptId, isComplete) {
                if (!userId) return;
                const docRef = db.collection(progressCollectionPath()).doc(conceptId);

                try {
                    await docRef.set({ completed: isComplete, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    showToast(`${conceptId} marked as ${isComplete ? 'completed' : 'incomplete'}.`, isComplete ? 'secondary' : 'accent');
                } catch (error) {
                    console.error("Error writing progress: ", error);
                    showToast("Failed to update progress.", 'accent');
                }
            }

            function updateLearningProgress(progressData) {
                userProgress = progressData;
                const completedCount = Object.keys(progressData).length;
                const percentage = totalConcepts > 0 ? Math.round((completedCount / totalConcepts) * 100) : 0;
                
                // Update Skill Tree
                renderSkillTree(progressData);
                
                // Update Component Card borders
                document.querySelectorAll('.component-card').forEach(card => {
                    const conceptId = card.dataset.conceptId;
                    card.classList.remove('border-green-500', 'ring-2', 'ring-green-500');
                    if (progressData[conceptId]) {
                        card.classList.add('border-green-500', 'ring-2', 'ring-green-500');
                    } else {
                        card.classList.remove('ring-2', 'ring-green-500');
                    }
                });
            }
            
            function generateDynamicSuggestions(progressData) {
                // NOTE: This function is simplified due to dependency on missing elements
                // dynamicSuggestionsContent.innerHTML = '';
                // ... (logic remains the same)
            }
            
            // --- Component Completion Mock Button (Unchanged) ---
            document.querySelectorAll('.component-card').forEach(card => {
                card.addEventListener('dblclick', () => {
                    if (userId) {
                        const conceptId = card.dataset.conceptId;
                        const isCompleted = userProgress[conceptId] === true;
                        toggleConceptCompletion(conceptId, !isCompleted);
                    } else {
                        showToast("Please log in to track your progress.", 'accent');
                    }
                });
            });

            // --- Real-time Firestore Progress Listener (Unchanged) ---
            function setupProgressListener(currentUserId) {
                if (window.unsubscribeProgress) {
                    window.unsubscribeProgress(); // Unsubscribe from previous user's listener
                }
                
                if (!currentUserId) {
                    updateLearningProgress({}); // Clear progress if logged out
                    return;
                }
                
                const q = db.collection(progressCollectionPath());
                
                // Listen for changes
                window.unsubscribeProgress = q.onSnapshot(snapshot => {
                    const progressData = {};
                    snapshot.forEach(doc => {
                        if (doc.data().completed) {
                            progressData[doc.id] = true;
                        }
                    });
                    updateLearningProgress(progressData);
                }, error => {
                    console.error("Firestore Progress Listener Error:", error);
                    showToast("Error loading learning progress.", 'accent');
                });
            }


            // --- Sensor Visualization Mock Logic (Unchanged) ---
            const sensorData = {
                ultrasonic: { unit: 'cm', min: 2, max: 200, value: 50, update: 100 },
            };

            function startSensorVisualization(type) {
                if (sensorVizInterval) clearInterval(sensorVizInterval);

                const data = sensorData[type];
                if (!data) return;

                const ctx = sensorVizCanvas.getContext('2d');
                let width = sensorVizCanvas.width = sensorVizCanvas.clientWidth;
                let height = sensorVizCanvas.height = sensorVizCanvas.clientHeight;
                
                // Gauge drawing function
                const drawGauge = () => {
                    ctx.clearRect(0, 0, width, height);

                    const centerX = width / 2;
                    const centerY = height; // Draw from the bottom
                    const radius = height * 0.9;
                    const startAngle = Math.PI; // 180 degrees
                    const endAngle = 2 * Math.PI; // 360 degrees

                    // Scale the value to the angle range (180 to 360 degrees)
                    const range = data.max - data.min;
                    const angleRatio = (data.value - data.min) / range;
                    const needleAngle = startAngle + (endAngle - startAngle) * angleRatio;
                    
                    // Background Arc
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = varFromTailwind('--border-color');
                    ctx.stroke();

                    // Fill Arc (Progress)
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, startAngle, needleAngle, false);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = varFromTailwind('--secondary');
                    ctx.stroke();

                    // Needle
                    ctx.beginPath();
                    ctx.strokeStyle = varFromTailwind('--accent');
                    ctx.lineWidth = 3;
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(
                        centerX + radius * Math.cos(needleAngle),
                        centerY + radius * Math.sin(needleAngle)
                    );
                    ctx.stroke();
                    
                    // Center Dot
                    ctx.fillStyle = varFromTailwind('--accent');
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // Text Readout
                    ctx.fillStyle = varFromTailwind('--text-light');
                    ctx.font = '24px Orbitron';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${data.value}${data.unit}`, centerX, centerY - radius / 3);
                };
                
                // Mock data generation loop
                sensorVizInterval = setInterval(() => {
                    // Simulate random fluctuation
                    const delta = (Math.random() * 20) - 10;
                    let newValue = data.value + delta;
                    
                    // Clamp value within min/max
                    if (newValue < data.min) newValue = data.min;
                    if (newValue > data.max) newValue = data.max;

                    data.value = Math.round(newValue);
                    sensorDataReadout.textContent = `Reading: ${data.value} ${data.unit} (Mock Data)`;
                    drawGauge();
                }, data.update);

                // Initial draw and resize handler
                drawGauge();
                window.addEventListener('resize', () => {
                    width = sensorVizCanvas.width = sensorVizCanvas.clientWidth;
                    height = sensorVizCanvas.height = sensorVizCanvas.clientHeight;
                    drawGauge();
                });
            }

            function stopSensorVisualization() {
                if (sensorVizInterval) {
                    clearInterval(sensorVizInterval);
                    sensorVizInterval = null;
                }
                sensorVizArea.classList.add('hidden');
                sensorDataReadout.textContent = 'Status: Idle';
            }
            
            // Helper function to get Tailwind colors
            function varFromTailwind(varName) {
                return getComputedStyle(document.documentElement).getPropertyValue(varName) || '#ffffff';
            }


            // --- Consolidated Project Data (EXPANDED with two new projects) ---
            const projectsList = [
                { 
                    id: 'iot1', 
                    name: 'Smart Home Automation System', 
                    theme: 'IoT & Remote Control', // NEW FIELD
                    aim: 'To develop a comprehensive, wireless system capable of controlling household appliances securely over the internet.', // NEW FIELD
                    description: 'Build a system to control lights, fans, and appliances remotely using ESP32 and a secure cloud platform.', 
                    image: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80', 
                    price: 4500, 
                    time: '4 hours', 
                    chip: 'ESP32', 
                    type: 'iot',
                    applications: ['Residential automation', 'Remote device management', 'Energy optimization'],
                    advantages: ['Wireless control via Wi-Fi.', 'Scalable design for adding more devices.', 'Learning cloud integration basics (MQTT/HTTP).'],
                    features: ['Remote control via app', 'Scheduler functions', 'Voice command integration', 'Over-The-Air (OTA) updates'], // EXPANDED
                    requirements: ['ESP32 board', '2-channel Relay module', 'LEDs', 'Solid internet connection', 'Breadboard and Jumper Wires'], // EXPANDED
                    sensorsUsed: ['None (Actuator focus)'],
                    buyLink: 'https://rzp.io/rzp/smarthomeautomations',
                
                    aiSummary: "This core IoT project teaches you how to bridge hardware (relays, lights) and software (cloud platform, Wi-Fi) to create a controllable home environment. The key learning outcome is **secure device control over the internet**, foundational for any smart device career."
                },
                { 
                    id: 'ard1', 
                    name: 'Automatic Irrigation System', 
                    theme: 'Agriculture & Environmental Monitoring', // NEW FIELD
                    aim: 'To design and implement an automated watering system for plants based on real-time soil moisture data, saving water and improving plant health.', // NEW FIELD
                    description: 'A project using Arduino Uno to measure soil moisture and automatically water plants using a small pump.', 
                    image: 'https://images.unsplash.com/photo-1594803986683-12a81878d655?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80', 
                    price: 899, 
                    time: '3 hours', 
                    chip: 'Arduino Uno', 
                    type: 'arduino',
                    applications: ['Small home gardens', 'Vertical farming setups', 'Educational tool for sensors'],
                    advantages: ['Simple to build and program.', 'Excellent introduction to analog inputs and DC motors.', 'Efficient water usage.'],
                    features: ['Soil moisture level display (LCD)', 'Automatic pump activation', 'Adjustable moisture threshold', 'Manual override button'], // EXPANDED
                    requirements: ['Arduino Uno', 'Soil Moisture Sensor', 'DC Water Pump', 'Relay Module', 'LCD Display (16x2)', 'Hoses and Water Supply'], // EXPANDED
                    sensorsUsed: ['Soil Moisture Sensor'],
                    buyLink: 'https://forms.gle/buy-arduino-irrigation-kit',
                    aiSummary: "This project provides a perfect introduction to closed-loop control systems. You'll learn how to interpret analog data from a **Soil Moisture Sensor** and use an **Arduino** to trigger an actuator (water pump) to maintain optimal conditions. It's practical and a great resume builder."
                },
  ];
            // --- END Consolidated Project Data ---

            
            function renderProjects(filter = 'all') {
                projectsGrid.innerHTML = '';
                const allProjects = projectsList;
                let filteredProjects;
                if (filter === 'iot') {
                    filteredProjects = allProjects.filter(p => p.type === 'iot');
                } else if (filter === 'arduino') {
                    filteredProjects = allProjects.filter(p => p.type === 'arduino');
                } else if (filter === 'cse') {
                    filteredProjects = allProjects.filter(p => p.type === 'cse');
                } else {
                    filteredProjects = allProjects;
                }

                filteredProjects.forEach(p => {
                    const projectType = p.type;
                    const tagClass = projectType === 'iot' ? 'bg-secondary' : (projectType === 'arduino' ? 'bg-accent' : 'bg-green-500');
                    const tagText = projectType === 'iot' ? 'IoT' : (projectType === 'arduino' ? 'Arduino' : 'CSE');

                    // NOTE: Project card must contain the project ID to track completion (mock project IDs used for simplicity)
                    const conceptId = p.id;
                    const completedClass = userProgress[conceptId] ? 'border-green-500 ring-2 ring-green-500' : 'border-secondary/50';

                    projectsGrid.innerHTML += `
                        <div class="project-card card-3d glassmorphism p-6 rounded-lg overflow-hidden neon-border cursor-pointer relative ${completedClass}" 
                             data-project-type="${projectType}" 
                             data-id="${p.id}" 
                             data-price="${p.price}" 
                             data-name="${p.name}" 
                             data-image="${p.image}"
                             data-description="${p.description}"
                             data-time="${p.time}"
                             data-chip="${p.chip}"
                             data-concept-id="${conceptId}"
                             data-theme="${p.theme}"
                             data-aim="${p.aim}"
                             data-features='${JSON.stringify(p.features)}'
                             data-applications='${JSON.stringify(p.applications)}'
                             data-advantages='${JSON.stringify(p.advantages)}'
                             data-requirements='${JSON.stringify(p.requirements)}'
                             data-sensors='${JSON.stringify(p.sensorsUsed)}'
                             data-buy-link="${p.buyLink}"
                             data-ai-summary="${p.aiSummary || 'No intelligent summary available for this project yet.'}">
                            <div class="absolute top-3 right-3 ${tagClass} text-white text-xs font-bold px-3 py-1 rounded-lg z-10">${tagText}</div>
                            <img src="${p.image}" alt="${p.name}" class="rounded-lg w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                            <div class="mt-4">
                                <h3 class="font-orbitron text-2xl font-bold text-white">${p.name}</h3>
                                <p class="text-gray-400 mt-2 text-sm">${p.description.substring(0, 100)}...</p>
                                <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹${p.price}</div>
                                <button class="add-to-cart-btn btn-3d btn-primary-action btn-box mt-4">Add to Cart</button>
                                
                                <div class="project-meta flex justify-between text-sm text-gray-400 mt-4 border-t border-border-color pt-2">
                                    <span><i class="fas fa-clock text-secondary mr-1"></i> ${p.time}</span>
                                    <span><i class="fas fa-microchip text-secondary mr-1"></i> ${p.chip}</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                document.querySelectorAll('.project-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Check if the click was on the cart button, if so, do nothing here
                        if (e.target.classList.contains('add-to-cart-btn')) {
                            return;
                        }
                        const data = card.dataset;
                        const defaultError = '<li>Data not specified.</li>';
                        
                        // Set the current project ID for TechWhiz button
                        askTechwhizDetailBtn.dataset.projectId = data.id;
                        askTechwhizDetailBtnTab.dataset.projectId = data.id;


                        // --- CRITICAL FIX: AGGRESSIVELY FORCE-CLOSE ALL OTHER MODALS AND CLEAR DISPLAY STATE ---
                        // Ensure all modals are closed before opening the project detail modal
                        if (profileModal) profileModal.style.display = 'none';
                        if (authModal) authModal.style.display = 'none';
                        if (cartModal) cartModal.classList.remove('open');
                        if (componentDetailModal) componentDetailModal.style.display = 'none';
                        if (orderHistoryModal) orderHistoryModal.style.display = 'none';
                        if (techwhizModal) techwhizModal.style.display = 'none';
                        // --- END FIX ---

                        // Clear previous content and hide sections
                        projectDetailFeatures.innerHTML = '';
                        projectDetailComponents.innerHTML = '';
                        projectDetailApplications.innerHTML = '';
                        projectDetailAdvantages.innerHTML = '';
                        projectDetailAim.textContent = 'N/A'; // Clear Aim
                        projectDetailThemeValue.textContent = 'N/A'; // Clear Theme
                        projectDetailSensorsUsed.innerHTML = '';
                        projectSensorView.classList.add('hidden'); 
                        
                        // Reset AI Summary view
                        aiSummaryContainer.classList.add('hidden'); 
                        aiSummaryText.textContent = 'Click the button above for an intelligent summary...'; 
                        aiSummaryBtn.dataset.summaryText = data.aiSummary;
                        
                        // Set Core Details
                        projectDetailTitle.textContent = data.name;
                        projectDetailImage.src = data.image;
                        projectDetailDescription.textContent = data.description;
                        projectDetailTime.innerHTML = `<i class="fas fa-clock text-secondary"></i> ${data.time}`;
                        projectDetailChip.innerHTML = `<i class="fas fa-microchip text-secondary"></i> ${data.chip}`;
                        projectDetailAim.textContent = data.aim || 'Project aim not explicitly defined.'; // NEW AIM
                        projectDetailThemeValue.textContent = data.theme || 'General'; // NEW THEME

                        
                        // --- FIX: ROBUST JSON PARSING FOR PROJECT LISTS ---
                        const listSections = {
                            applications: projectDetailApplications,
                            advantages: projectDetailAdvantages,
                            features: projectDetailFeatures,
                            requirements: projectDetailComponents,
                            sensors: projectDetailSensorsUsed 
                        };

                        for (const key in listSections) {
                            try {
                                const listData = data[key] ? JSON.parse(data[key]) : [];
                                
                                // Check if listData is an array and has content
                                if (Array.isArray(listData) && listData.length > 0) {
                                    // If it's the sensors list, use the special tag formatting
                                    if (key === 'sensors') {
                                         // The sensor rendering logic is slightly different (pills, not list items)
                                         listSections[key].innerHTML = listData.map(s => 
                                            `<li class="bg-accent/20 text-accent font-semibold px-3 py-1 rounded-full text-sm flex items-center">
                                                <i class="fas fa-cube mr-2"></i> ${s}
                                             </li>`
                                        ).join('');
                                    } else {
                                        // Standard list item formatting
                                        listSections[key].innerHTML = listData.map(item => `<li>${item}</li>`).join('');
                                    }
                                } else {
                                    // Handle cases where the array is empty or null
                                    listSections[key].innerHTML = defaultError;
                                }
                            } catch (error) {
                                // This catches JSON parsing errors and outputs to console
                                console.error(`E-TECH DATA ERROR: Failed to parse project data for key: ${key}`, error);
                                // Display a clear error message on the UI element
                                listSections[key].innerHTML = '<li>Error: Failed to load list data.</li>';
                            }
                        }
                        
                        // Special handling for sensors visibility
                        const sensorsList = JSON.parse(data.sensors);
                        if (sensorsList && sensorsList.length > 0 && sensorsList[0] !== 'None (Actuator focus)') {
                            projectSensorView.classList.remove('hidden');
                        } else {
                            projectSensorView.classList.add('hidden');
                        }
                        // --- END FIX ---
                        
                        // Set data for action buttons
                        addToCartFromDetailBtn.dataset.id = data.id;
                        addToCartFromDetailBtn.dataset.name = data.name;
                        addToCartFromDetailBtn.dataset.price = data.price;
                        addToCartFromDetailBtn.dataset.image = data.image;
                        
                        // Set Buy Now Link
                        buyNowFromDetailBtn.href = data.buyLink;
                        
                        // Reset to the first tab (Details & Aim)
                        activateProjectDetailTab(document.querySelector('.project-detail-tabs button[data-tab-target="#tab-details"]'));

                        // Show the modal immediately (FIX: This is the critical line to show the modal)
                        projectDetailModal.style.display = 'flex';
                    });
                });
                
                document.querySelectorAll('.project-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Check if the click was on the cart button, if so, do nothing here
                        if (e.target.classList.contains('add-to-cart-btn')) {
                            return;
                        }
                        const data = card.dataset;
                        const defaultError = '<li>Data not specified.</li>';
                        
                        // Set the current project ID for TechWhiz button
                        askTechwhizDetailBtn.dataset.projectId = data.id;
                        askTechwhizDetailBtnTab.dataset.projectId = data.id;


                        // --- CRITICAL FIX: AGGRESSIVELY FORCE-CLOSE ALL OTHER MODALS AND CLEAR DISPLAY STATE ---
                        // Ensure all modals are closed before opening the project detail modal
                        if (profileModal) profileModal.style.display = 'none';
                        if (authModal) authModal.style.display = 'none';
                        if (cartModal) cartModal.classList.remove('open');
                        if (componentDetailModal) componentDetailModal.style.display = 'none';
                        if (orderHistoryModal) orderHistoryModal.style.display = 'none';
                        if (techwhizModal) techwhizModal.style.display = 'none';
                        // --- END FIX ---

                        // Clear previous content and hide sections
                        projectDetailFeatures.innerHTML = '';
                        projectDetailComponents.innerHTML = '';
                        projectDetailApplications.innerHTML = '';
                        projectDetailAdvantages.innerHTML = '';
                        projectDetailAim.textContent = 'N/A'; // Clear Aim
                        projectDetailThemeValue.textContent = 'N/A'; // Clear Theme
                        projectDetailSensorsUsed.innerHTML = '';
                        projectSensorView.classList.add('hidden'); 
                        
                        // Reset AI Summary view
                        aiSummaryContainer.classList.add('hidden'); 
                        aiSummaryText.textContent = 'Click the button above for an intelligent summary...'; 
                        aiSummaryBtn.dataset.summaryText = data.aiSummary;
                        
                        // Set Core Details
                        projectDetailTitle.textContent = data.name;
                        projectDetailImage.src = data.image;
                        projectDetailDescription.textContent = data.description;
                        projectDetailTime.innerHTML = `<i class="fas fa-clock text-secondary"></i> ${data.time}`;
                        projectDetailChip.innerHTML = `<i class="fas fa-microchip text-secondary"></i> ${data.chip}`;
                        projectDetailAim.textContent = data.aim || 'Project aim not explicitly defined.'; // NEW AIM
                        projectDetailThemeValue.textContent = data.theme || 'General'; // NEW THEME

                        
                        // --- FIX: ROBUST JSON PARSING FOR PROJECT LISTS ---
                        const listSections = {
                            applications: projectDetailApplications,
                            advantages: projectDetailAdvantages,
                            features: projectDetailFeatures,
                            requirements: projectDetailComponents,
                            sensors: projectDetailSensorsUsed 
                        };

                        for (const key in listSections) {
                            try {
                                const listData = data[key] ? JSON.parse(data[key]) : [];
                                
                                // Check if listData is an array and has content
                                if (Array.isArray(listData) && listData.length > 0) {
                                    // If it's the sensors list, use the special tag formatting
                                    if (key === 'sensors') {
                                         // The sensor rendering logic is slightly different (pills, not list items)
                                         listSections[key].innerHTML = listData.map(s => 
                                            `<li class="bg-accent/20 text-accent font-semibold px-3 py-1 rounded-full text-sm flex items-center">
                                                <i class="fas fa-cube mr-2"></i> ${s}
                                             </li>`
                                        ).join('');
                                    } else {
                                        // Standard list item formatting
                                        listSections[key].innerHTML = listData.map(item => `<li>${item}</li>`).join('');
                                    }
                                } else {
                                    // Handle cases where the array is empty or null
                                    listSections[key].innerHTML = defaultError;
                                }
                            } catch (error) {
                                // This catches JSON parsing errors and outputs to console
                                console.error(`E-TECH DATA ERROR: Failed to parse project data for key: ${key}`, error);
                                // Display a clear error message on the UI element
                                listSections[key].innerHTML = '<li>Error: Failed to load list data.</li>';
                            }
                        }
                        
                        // Special handling for sensors visibility
                        const sensorsList = JSON.parse(data.sensors);
                        if (sensorsList && sensorsList.length > 0 && sensorsList[0] !== 'None (Actuator focus)') {
                            projectSensorView.classList.remove('hidden');
                        } else {
                            projectSensorView.classList.add('hidden');
                        }
                        // --- END FIX ---
                        
                        // Set data for action buttons
                        addToCartFromDetailBtn.dataset.id = data.id;
                        addToCartFromDetailBtn.dataset.name = data.name;
                        addToCartFromDetailBtn.dataset.price = data.price;
                        addToCartFromDetailBtn.dataset.image = data.image;
                        
                        // Set Buy Now Link
                        buyNowFromDetailBtn.href = data.buyLink;
                        
                        // Reset to the first tab (Details & Aim)
                        activateProjectDetailTab(document.querySelector('.project-detail-tabs button[data-tab-target="#tab-details"]'));

                        // Show the modal immediately (FIX: This is the critical line to show the modal)
                        projectDetailModal.style.display = 'flex';
                    });
                });
                
                document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const card = e.target.closest('.project-card');
                        const price = parseFloat(card.dataset.price);
                        addToCart(card.dataset.id, card.dataset.name, price, card.dataset.image);
                        e.stopPropagation();
                    });
                });
                
                // Re-render KaTeX after injecting new HTML content
                if (window.renderMathInElement) {
                    renderMathInElement(projectsGrid);
                }
            }
            
            // NEW: Project Detail Tab Logic
            function activateProjectDetailTab(clickedButton) {
                // Deactivate all buttons and hide all content
                projectDetailTabBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('[data-tab-content]').forEach(content => content.classList.add('hidden'));
                
                // Activate the clicked button
                clickedButton.classList.add('active');
                
                // Show the target content
                const targetId = clickedButton.dataset.tabTarget;
                const targetContent = document.querySelector(targetId);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }

            projectDetailTabBtns.forEach(button => {
                button.addEventListener('click', () => activateProjectDetailTab(button));
            });

            // NEW: AI Summary Button Handler
            aiSummaryBtn.addEventListener('click', () => {
                const summaryText = aiSummaryBtn.dataset.summaryText;
                
                if (summaryText) {
                    // Simulate loading state
                    aiSummaryText.textContent = "Generating intelligent summary... one moment...";
                    aiSummaryContainer.classList.remove('hidden');

                    // Simulate API response delay (using setTimeout instead of actual API call for demo speed)
                    setTimeout(() => {
                        aiSummaryText.textContent = summaryText;
                    }, 800); 

                } else {
                    aiSummaryText.textContent = "No detailed AI summary available for this project.";
                    aiSummaryContainer.classList.remove('hidden');
                }
            });
            
            // NEW: Ask TechWhiz button handler inside the Project Detail Modal
            const askTechwhizProjectHandler = (e) => {
                const projectId = e.currentTarget.dataset.projectId;
                const project = projectsList.find(p => p.id === projectId);
                
                if (!project) return;
                
                const prompt = `Tell me more about the project, "${project.name}", specifically focusing on its main theme, purpose (aim), and unique features. Assume I am a student ready to start building it.`;
                
                // Close project modal and open TechWhiz modal
                projectDetailModal.style.display = 'none';
                techwhizModal.style.display = 'flex';
                
                // Inject prompt into chat input and trigger submission
                techwhizInput.value = prompt;
                sendBtn.click();
            };

            askTechwhizDetailBtn.addEventListener('click', askTechwhizProjectHandler);
            askTechwhizDetailBtnTab.addEventListener('click', askTechwhizProjectHandler); // Tab bar click should also trigger this
            
            // FIX: Close Modal Functionality (Ensuring this still works)
            closeProjectDetailBtn.addEventListener('click', () => {
                projectDetailModal.style.display = 'none';
            });
            
            // Close modal when clicking outside of the content area
            projectDetailModal.addEventListener('click', (e) => {
                // Only close if the click target is the modal overlay itself
                if (e.target === projectDetailModal) {
                    projectDetailModal.style.display = 'none';
                }
            });


            // --- Consolidated Function to Apply Filter and Update UI (Addressing User's Filter Issue) ---
            function applyProjectFilter(filter) {
                // 1. Update Active State UI for buttons
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-secondary', 'hover:bg-accent');
                    // Ensure the default look is applied before checking for active state
                    b.classList.add('bg-gray-800', 'hover:bg-secondary'); 

                    if (b.dataset.filter === filter) {
                        // Apply active styling
                        b.classList.add('bg-secondary', 'hover:bg-accent');
                        b.classList.remove('bg-gray-800', 'hover:bg-secondary');
                    }
                });

                // 2. Render the filtered projects
                renderProjects(filter);
            }
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    applyProjectFilter(btn.dataset.filter);
                });
            });
            // --- END NEW: Consolidated Filter Function ---


            // --- Cart Logic Implementation (Unchanged) ---
            async function addToCart(id, name, price, image) {
                // Check Inventory (Mock Firestore check)
                try {
                    const inventoryRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory').doc(id);
                    const doc = await inventoryRef.get();
                    let currentStock = 10; // Default mock stock
                    
                    if (doc.exists) {
                        currentStock = doc.data().stock;
                    } 
                    // To simulate low/zero stock for testing:
                    if (id === 'iot2') { currentStock = 0; } // Mock Sold Out for Weather Station

                    const existingItem = cart.find(item => item.id === id);
                    const quantityInCart = existingItem ? existingItem.quantity : 0;
                    
                    if (quantityInCart >= currentStock && currentStock > 0) {
                         showToast(`${name} is low stock! Max ${currentStock} allowed.`, 'accent');
                         return;
                    }
                    
                    if (currentStock <= 0) {
                         showToast(`${name} is currently Sold Out.`, 'accent');
                         return;
                    }

                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        cart.push({ id, name, price, image, quantity: 1, maxStock: currentStock });
                    }
                    updateCart();
                    showToast(`${name} added to cart!`);

                } catch (error) {
                    console.error("Error checking inventory: ", error);
                    showToast(`Inventory check failed. Adding to cart anyway.`, 'secondary');
                    
                    // Fallback to adding without inventory check
                    const existingItem = cart.find(item => item.id === id);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        cart.push({ id, name, price, image, quantity: 1 });
                    }
                    updateCart();
                }
            }
            
            function changeCartQuantity(id, change) {
                const item = cart.find(item => item.id === id);
                if (item) {
                    const newQuantity = item.quantity + change;
                    
                    if (newQuantity <= 0) {
                        removeFromCart(id);
                        return;
                    }
                    
                    // Check max stock if available
                    if (item.maxStock !== undefined && newQuantity > item.maxStock) {
                        showToast(`Max stock reached for ${item.name}!`, 'accent');
                        return;
                    }
                    
                    item.quantity = newQuantity;
                    updateCart();
                }
            }

            function removeFromCart(id) {
                const itemIndex = cart.findIndex(item => item.id === id);
                if (itemIndex > -1) {
                    cart.splice(itemIndex, 1);
                    showToast(`Item removed from cart.`, 'accent');
                }
                updateCart();
            }

            function updateCart() {
                cartModalItemsContainer.innerHTML = '';
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                
                cartCountElement.textContent = totalItems;
                cartItemCountHeader.textContent = totalItems;

                if (cart.length === 0) {
                    cartModalItemsContainer.innerHTML = '<p class="cart-empty-msg text-gray-400 text-center p-8">Your cart is currently empty. Start exploring projects!</p>';
                    cartCheckoutBtn.disabled = true;
                    cartCheckoutBtn.classList.remove('btn-primary-action', 'hover:bg-secondary'); // Use new classes
                    cartCheckoutBtn.classList.add('bg-gray-700', 'cursor-not-allowed');
                } else {
                    cartCheckoutBtn.disabled = false;
                    cartCheckoutBtn.classList.add('btn-primary-action', 'hover:bg-secondary'); // Use new classes
                    cartCheckoutBtn.classList.remove('bg-gray-700', 'cursor-not-allowed');

                    cart.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.classList.add('cart-modal-item');
                        itemElement.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg mr-4 border border-secondary/50">
                            <div class="flex-1">
                                <h4 class="font-bold text-white">${item.name}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-sm text-gray-400">Qty:</span>
                                    <div class="cart-controls flex items-center">
                                        <button class="qty-minus" data-id="${item.id}" data-change="-1">-</button>
                                        <span class="px-2 text-white">${item.quantity}</span>
                                        <button class="qty-plus" data-id="${item.id}" data-change="1">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-lg font-orbitron text-accent mr-4">₹${(item.price * item.quantity).toFixed(0)}</div>
                            <button class="cart-item-remove text-gray-500 hover:text-accent text-xl transition-colors" data-id="${item.id}">&times;</button>
                        `;
                        itemElement.querySelector('.cart-item-remove').addEventListener('click', (e) => removeFromCart(e.target.dataset.id));
                        itemElement.querySelector('.qty-minus').addEventListener('click', (e) => changeCartQuantity(e.target.dataset.id, -1));
                        itemElement.querySelector('.qty-plus').addEventListener('click', (e) => changeCartQuantity(e.target.dataset.id, 1));
                        cartModalItemsContainer.appendChild(itemElement);
                    });
                }
                const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                cartTotalPriceElement.textContent = `₹${total}`;
            }
            
            function showToast(message, color = 'secondary') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed; 
                    top: 20px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: var(--${color}); 
                    color: white; 
                    padding: 10px 20px; 
                    border-radius: 8px; 
                    z-index: 9999; 
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
                    font-family: 'Orbitron', sans-serif;
                    opacity: 0;
                    transition: opacity 0.5s ease-in-out;
                `;
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = 1; }, 10);
                setTimeout(() => { toast.style.opacity = 0; }, 2500);
                setTimeout(() => toast.remove(), 3000);
            }

            cartFab.addEventListener('click', () => cartModal.classList.toggle('open'));
            closeCartBtn.addEventListener('click', () => cartModal.classList.remove('open'));

            addToCartFromDetailBtn.addEventListener('click', () => {
                const id = addToCartFromDetailBtn.dataset.id;
                const name = addToCartFromDetailBtn.dataset.name;
                const price = parseFloat(addToCartFromDetailBtn.dataset.price);
                const image = addToCartFromDetailBtn.dataset.image;
                addToCart(id, name, price, image);
                projectDetailModal.style.display = 'none';
            });
            
            // NOTE: The 'Buy Kit Now' button uses the `buyLink` data attribute
            // and opens it in a new tab for an immediate purchase flow.
            buyNowFromDetailBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const link = buyNowFromDetailBtn.getAttribute('href');
                if (link) {
                    window.open(link, '_blank');
                } else {
                    showToast("No direct purchase link available for this project yet.", 'accent');
                }
            });


            cartCheckoutBtn.addEventListener('click', () => {
                const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                if (totalAmount === 0) {
                    showToast("Your cart is empty!", 'accent');
                    return;
                }
                if (!auth.currentUser) {
                    showToast("Please login to proceed to checkout.", 'accent');
                    authModal.style.display = 'flex'; // Use flex to match modal-overlay-center
                    return;
                }
                const options = {
                    key: "rzp_live_4cpkH5xviXonf3",
                    amount: totalAmount * 100,
                    currency: "INR",
                    name: "E-TECH SOLUTIONS",
                    description: "Project Purchase",
                    image: "https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400",
                    handler: (response) => {
                        const orderData = {
                            userId: auth.currentUser.uid,
                            orderId: response.razorpay_payment_id,
                            items: JSON.stringify(cart),
                            totalAmount: totalAmount,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        const userId = auth.currentUser?.uid || crypto.randomUUID();
                        db.collection(`artifacts/${appId}/users/${userId}/orders`).add(orderData)
                            .then(() => {
                                showToast(`Payment Successful! Order ID: ${response.razorpay_payment_id}`, 'secondary');
                                cart = [];
                                updateCart();
                                cartModal.classList.remove('open');
                            })
                            .catch((error) => {
                                console.error("Error adding document: ", error);
                                showToast("Error saving order details.", 'accent');
                            });
                    },
                    prefill: { name: auth.currentUser.displayName, email: auth.currentUser.email },
                    theme: { color: "#00e5ff" }
                };
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', (response) => {
                    showToast(`Payment Failed: ${response.error.description}`, 'accent');
                });
                rzp.open();
            });

            // --- Order History Logic (Unchanged) ---
            orderHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (auth.currentUser) {
                    fetchOrderHistory(auth.currentUser.uid);
                } else {
                    authModal.style.display = 'flex';
                }
            });

            closeHistoryBtn.addEventListener('click', () => {
                orderHistoryModal.style.display = 'none';
            });

            async function fetchOrderHistory(currentUserId) {
                orderHistoryList.innerHTML = '<p class="text-center text-gray-500">Loading order history...</p>';
                orderHistoryModal.style.display = 'flex';
                try {
                    const querySnapshot = await db.collection(`artifacts/${appId}/users/${currentUserId}/orders`)
                        .orderBy("timestamp", "desc")
                        .get();
                    
                    if (querySnapshot.empty) {
                        orderHistoryList.innerHTML = '<p class="text-center text-gray-400">You have no past orders.</p>';
                        return;
                    }

                    let ordersHtml = '';
                    querySnapshot.forEach(doc => {
                        const order = doc.data();
                        const orderDate = order.timestamp ? new Date(order.timestamp.seconds * 1000).toLocaleString() : 'Date not available';
                        
                        let itemsHtml = '<ul class="list-disc ml-6 text-gray-400 text-sm">';
                        const items = JSON.parse(order.items);
                        items.forEach(item => {
                            itemsHtml += `<li>${item.name} (x${item.quantity}) - ₹${item.price}</li>`;
                        });
                        itemsHtml += '</ul>';

                        ordersHtml += `
                            <div class="glassmorphism p-4 rounded-lg neon-border mb-4 border-secondary/50">
                                <div class="flex justify-between items-center text-sm mb-2 text-gray-500">
                                    <span>${orderDate}</span>
                                    <span class="truncate ml-2">ID: ${order.orderId.substring(0, 10)}...</span>
                                </div>
                                ${itemsHtml}
                                <div class="text-right font-bold mt-2 text-secondary">
                                    Total: ₹${order.totalAmount}
                                </div>
                            </div>
                        `;
                    });
                    orderHistoryList.innerHTML = ordersHtml;

                } catch (error) {
                    console.error("Error fetching order history: ", error);
                    orderHistoryList.innerHTML = '<p class="text-center text-accent">Could not load order history. Please try again later.</p>';
                }
            }


            // --- Parallax Scrolling Effect (Unchanged) ---
            const sections = document.querySelectorAll('.section');
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset;
                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const offset = rect.top + scrollTop;
                    const parallaxFactor = (scrollTop - offset) * 0.05;
                    section.style.transform = `translateY(${parallaxFactor}px)`;
                });
            });
            
            // --- NEW: Scroll-to-Hide Header Logic ---
            let lastScrollTop = 0;
            const scrollThreshold = 50; 
            
            window.addEventListener('scroll', () => {
                const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Only hide/show if the scroll movement is significant and the mobile menu is closed
                if (window.innerWidth <= 768 && !navMenu.classList.contains('active')) {
                    if (currentScrollTop > lastScrollTop && currentScrollTop > scrollThreshold) {
                        // Scrolling down
                        mainHeader.classList.add('header-hidden');
                    } else if (currentScrollTop < lastScrollTop) {
                        // Scrolling up
                        mainHeader.classList.remove('header-hidden');
                    }
                } else if (window.innerWidth > 768) {
                    // Always show header on desktop
                    mainHeader.classList.remove('header-hidden');
                }
                
                lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop; // For Mobile or negative scrolling
            });

            // --- Mobile Menu Toggle and Auto-Hide Logic (Modified) ---
            mobileToggle.addEventListener('click', () => navMenu.classList.toggle('active'));

            // Auto-hide when a link is clicked (on mobile only)
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        navMenu.classList.remove('active');
                        // Ensure header becomes visible if navigation is used
                        mainHeader.classList.remove('header-hidden'); 
                    }
                });
            });

            // --- Auth Modal Logic (Unchanged) ---
            // NOTE: Changing classList.remove/add('hidden') to element.style.display for centering consistency
            loginBtnNav.addEventListener('click', (e) => { e.preventDefault(); authModal.style.display = 'flex'; });
            closeAuthBtn.addEventListener('click', () => authModal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target == authModal) authModal.style.display = 'none'; });
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    authTabs.forEach(item => item.classList.remove('active', 'text-secondary'));
                    tab.classList.add('active', 'text-secondary');
                    authForms.forEach(form => form.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab + '-form').classList.remove('hidden');
                });
            });
            
            // --- FIX: Google Sign-In Function using signInWithRedirect (Unchanged) ---
            googleLoginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    // Use signInWithRedirect instead of signInWithPopup to avoid environment security restrictions
                    await auth.signInWithRedirect(provider); 
                    // Note: Execution stops here as the page redirects.
                } catch (error) {
                    console.error("Google Sign-In Error (Pre-Redirect):", error);
                    showToast(`Google Sign-In Failed: ${error.message.split(' (')[0]}`, 'accent');
                }
            });
            // --- END FIX: Google Sign-In Function ---

            // --- Firebase Auth Listener & Profile Setup (Unchanged) ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    loginBtnNav.classList.add('hidden');
                    userStatus.classList.remove('hidden');
                    userName.textContent = user.displayName || user.email;
                    userAvatar.textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                    
                    // Set up Firestore listener for the current user's progress
                    setupProgressListener(user.uid);
                    // document.getElementById('skill-tree-status').textContent = "Double-click a node to mark as complete/incomplete!";
                    // suggestionsSidebar.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    userId = null;
                    loginBtnNav.classList.remove('hidden');
                    userStatus.classList.add('hidden');
                    setupProgressListener(null); // Stop listener and clear progress
                    // document.getElementById('skill-tree-status').textContent = "Log in to view your personalized progress.";
                    // suggestionsSidebar.classList.add('opacity-50', 'pointer-events-none');
                }
            });
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                auth.signInWithEmailAndPassword(loginForm['login-email'].value, loginForm['login-password'].value)
                    .then(() => { 
                        authModal.style.display = 'none'; 
                    })
                    .catch(error => console.error(error.message));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                auth.createUserWithEmailAndPassword(registerForm['register-email'].value, registerForm['register-password'].value)
                    .then(cred => cred.user.updateProfile({ displayName: registerForm['register-name'].value }))
                    .then(() => { 
                        authModal.style.display = 'none'; 
                    })
                    .catch(error => console.error(error.message));
            });
            
            // Update the general logout button and add profile modal logic
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    profileModal.style.display = 'none';
                    showToast("Signed out successfully.");
                });
            });
            profileLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    profileModal.style.display = 'none';
                    showToast("Signed out successfully.");
                });
            });

            // --- Profile Modal Logic (Unchanged) ---
            userAvatar.addEventListener('click', () => {
                const user = auth.currentUser;
                if (!user) return;
                
                profileDisplayName.textContent = user.displayName || 'N/A';
                profileEmail.textContent = user.email || 'N/A';
                profileUserId.textContent = user.uid;
                
                profileModal.style.display = 'flex';
            });

            closeProfileBtn.addEventListener('click', () => profileModal.style.display = 'none');

            editProfileBtn.addEventListener('click', () => {
                 const newName = prompt("Enter your new display name:");
                 if (newName && newName.trim()) {
                     auth.currentUser.updateProfile({ displayName: newName.trim() })
                        .then(() => {
                            showToast("Display name updated!", 'secondary');
                            profileDisplayName.textContent = newName.trim();
                            userName.textContent = newName.trim();
                            userAvatar.textContent = newName.trim().charAt(0).toUpperCase();
                        })
                        .catch(error => showToast(`Error updating name: ${error.message}`, 'accent'));
                 }
            });

            // --- START: Component Data Source (Expanded Content) ---
            const componentsData = {
                resistor: { 
                    title: "Resistor", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczM5DWsnmgZvpw6xGHEEEktIuWpG_2IgRAkg3UqDhJhLkhTGR-qN4sKz5KJGk59I7DljumSSSTUMvkmU1TBUu0ZcFo8Px9_2-Lbc3U5aFi3EHs1lw4w=w2400", 
                    definition: "A resistor is a passive two-terminal electrical component that implements electrical resistance as a circuit element. It opposes the flow of electric current.", 
                    symbol: "American-style: zigzag line (\\text{⏚}), International Standard: rectangular box (\\text{□}).", 
                    characteristics: ["Opposes the flow of electric current", "Measured in Ohms (\\Omega)", "Power rating determines how much heat it can dissipate", "Available in fixed and variable (potentiometer) types"], 
                    applications: "Used to reduce current flow, adjust signal levels, divide voltages, and terminate transmission lines." 
                },
               
              
            };
            // --- END: Component Data Source (Expanded Content) ---


            // FIX: Component Data Display Logic
            componentCards.forEach(card => {
                card.addEventListener('click', () => {
                    const componentType = card.dataset.component;
                    const compData = componentsData[componentType];
                    
                    // Close other modals before opening component modal
                    if (projectDetailModal) projectDetailModal.style.display = 'none';
                    
                    stopSensorVisualization(); // Stop any existing visualization

                    if (compData) {
                        detailTitle.textContent = compData.title;
                        detailImg.src = compData.img;
                        detailDefinition.textContent = compData.definition;
                        
                        // Show/Hide Sensor Visualization Area
                        if (compData.isSensor) {
                            sensorVizArea.classList.remove('hidden');
                            if (compData.sensorType === 'ultrasonic') {
                                // Only start the complex mock for the specified Ultrasonic Sensor
                                startSensorVisualization('ultrasonic');
                            } else {
                                sensorDataReadout.textContent = `Live Mock unavailable for ${compData.title}.`;
                            }
                        } else {
                            sensorVizArea.classList.add('hidden'); // Ensure it's hidden for non-sensors
                        }
                        
                        try {
                            const tempDiv = document.createElement('div');
                            const latexString = compData.symbol.replace(/\\text\{/g, '\\text{').replace(/}/g, '}');
                            
                            if (latexString.includes('\\Omega') || latexString.includes('\\text{') || latexString.includes('}')) {
                                katex.render(latexString, detailSymbol, { displayMode: false, throwOnError: true });
                            } else {
                                detailSymbol.textContent = compData.symbol;
                            }
                        } catch (e) {
                             console.error("KaTeX rendering failed:", e);
                             detailSymbol.textContent = compData.symbol; 
                        }

                        detailCharacteristics.innerHTML = compData.characteristics.map(char => `<li>${char}</li>`).join('');
                        
                        detailCharacteristics.querySelectorAll('li').forEach(li => {
                            if (window.renderMathInElement) {
                                renderMathInElement(li);
                            }
                        });
                        
                        detailApplications.textContent = compData.applications;
                        
                        askTechwhizComponentBtn.dataset.componentName = compData.title;

                        componentDetailModal.style.display = 'flex'; // This line ensures immediate display
                    } else {
                        // Fallback if data is missing
                        detailTitle.textContent = "Data Unavailable";
                        detailImg.src = "https://via.placeholder.com/400x300/333333/ffffff?text=No+Image";
                        detailDefinition.textContent = "Detailed information for this component is currently under construction.";
                        detailSymbol.textContent = "N/A";
                        detailCharacteristics.innerHTML = '<li>Check back soon!</li>';
                        detailApplications.textContent = "N/A";
                        askTechwhizComponentBtn.dataset.componentName = componentType;
                        componentDetailModal.style.display = 'flex'; // This line ensures immediate display
                    }
                });
            });

            closeDetailBtn.addEventListener('click', () => { 
                componentDetailModal.style.display = 'none'; 
                stopSensorVisualization(); // Stop visualization when closing
            });
            
            // Close component modal if clicking outside
            componentDetailModal.addEventListener('click', (e) => {
                if (e.target === componentDetailModal) {
                    componentDetailModal.style.display = 'none';
                    stopSensorVisualization(); // Stop visualization when closing
                }
            });

            // NEW: Contextual AI button handler (Unchanged)
            askTechwhizComponentBtn.addEventListener('click', () => {
                const componentName = askTechwhizComponentBtn.dataset.componentName || 'this component';
                const prompt = `Explain the key function and most common applications of the ${componentName} for a beginner in electronics.`;
                
                // Close component modal and open TechWhiz modal
                componentDetailModal.style.display = 'none';
                stopSensorVisualization(); // Stop visualization before moving
                techwhizModal.style.display = 'flex';
                
                // Inject prompt into chat input and trigger submission
                techwhizInput.value = prompt;
                sendBtn.click();
            });

            // --- TechWhiz Assistant Logic (Updated for full functionality) ---
            let recognition;
            let isListening = false;
            const synth = window.speechSynthesis;
            let currentUtterance = null;
            const geminiApiKey = "AIzaSyCODRIZL8mNqWpUf0HdWcoCedimZM_0G5E"; // Using empty string for auto-injection

            techwhizFab.addEventListener('click', () => techwhizModal.style.display = 'flex');
            closeTechwhizModalBtn.addEventListener('click', () => {
                techwhizModal.style.display = 'none';
                if (synth.speaking) synth.cancel();
                if (isListening) recognition.stop();
            });

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    micBtn.classList.add('speech-active');
                    listeningStatus.classList.remove('hidden');
                };
                
                recognition.onresult = (event) => { 
                    const transcript = event.results[0][0].transcript;
                    techwhizInput.value = transcript;
                    // Automatically process the command once transcribed
                    processCommand(transcript);
                };

                recognition.onerror = (event) => {
                    console.error('Speech Recognition Error:', event.error);
                    showToast(`Voice command error: ${event.error}`, 'accent');
                    isListening = false;
                    micBtn.classList.remove('speech-active');
                    listeningStatus.classList.add('hidden');
                    techwhizInput.disabled = false;
                    sendBtn.disabled = false;
                    micBtn.disabled = false;
                    thinkingStatus.classList.add('hidden');
                };

                recognition.onend = () => {
                    // Only perform cleanup if recognition stops naturally or by error, 
                    // but not if it stops because a command was successfully processed (which calls processCommand)
                    if (isListening) { 
                        isListening = false;
                        micBtn.classList.remove('speech-active');
                        listeningStatus.classList.add('hidden');
                        // No need to re-enable mic/input here as processCommand's finally block handles it.
                    }
                };
            } else {
                micBtn.disabled = true;
                showToast("Speech recognition not supported in this browser.", 'accent');
            }

            micBtn.addEventListener('click', () => { 
                if (isListening) { 
                    recognition.stop(); 
                } else { 
                    techwhizInput.value = ''; 
                    recognition.start(); 
                } 
            });

            sendBtn.addEventListener('click', () => { 
                if (isListening) {
                    recognition.stop();
                } 
                const command = techwhizInput.value.trim(); 
                if (command) processCommand(command); 
            });
            
            techwhizInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendBtn.click(); });
            stopSpeechBtn.addEventListener('click', () => { if (synth.speaking) synth.cancel(); });

            function appendMessage(message, sender) { 
                const msgDiv = document.createElement('div'); 
                msgDiv.className = `chat-message p-3 rounded-lg max-w-[85%] w-fit ${sender === 'user' ? 'bg-secondary text-white rounded-br-none self-end ml-auto' : 'bg-gray-800 text-white rounded-bl-none self-start mr-auto'}`; 
                msgDiv.textContent = message; 
                chatHistory.prepend(msgDiv);
                if(chatHistory.childElementCount > 10) {
                  chatHistory.removeChild(chatHistory.lastChild);
                }
            }

            function readAloud(text) { 
                if (synth.speaking) synth.cancel(); 
                currentUtterance = new SpeechSynthesisUtterance(text); 
                currentUtterance.onend = () => currentUtterance = null; 
                synth.speak(currentUtterance); 
            }

            // --- NEW: Handle UI and Predefined Commands
            function handleUICommand(lowerCommand) {
                let action = { executed: false, response: '' };

                // 1. Greetings / Simple Predefined Responses
                if (lowerCommand.includes('hello') || lowerCommand.includes('hi') || lowerCommand.includes('what up')) {
                    action.executed = true;
                    action.response = "Hello! I am TechWhiz, your electronics and CSE assistant. How can I assist you with your learning today?";
                } else if (lowerCommand.includes('your name') || lowerCommand.includes('who are you')) {
                    action.executed = true;
                    action.response = "I am TECHWHIZ, a helpful assistant powered by Google's Gemini API, designed to assist you with electronics and computer science projects.";
                } else if (lowerCommand.includes('what can you do') || lowerCommand.includes('your capabilities')) {
                    action.executed = true;
                    action.response = "I can help you with electronics and computer science concepts, suggest projects, provide career advice, and even help with debugging and code explanation. Just ask!";
                } else if (lowerCommand.includes('about this website') || lowerCommand.includes('about this html file')) {
                    action.executed = true;
                    action.response = "This is the E-TECH SOLUTIONS dynamic e-learning portal. It offers various courses in electronics and computer science, features user authentication, tracks course progress, and integrates payment options.";
                }

               

                
                // 2. Open/Close Application (Modals)
                else if (lowerCommand.includes('open cart') || lowerCommand.includes('show cart')) {
                    cartModal.classList.add('open');
                    action.executed = true;
                    action.response = "Opening the shopping cart for you now.";
                } else if (lowerCommand.includes('close cart') || lowerCommand.includes('hide cart')) {
                    cartModal.classList.remove('open');
                    action.executed = true;
                    action.response = "Closing the shopping cart.";
                } else if (lowerCommand.includes('close assistant') || lowerCommand.includes('close chat')) {
                    techwhizModal.style.display = 'none';
                    if (synth.speaking) synth.cancel();
                    action.executed = true;
                    action.response = "Closing the assistant. Click the robot icon if you need me again!";
                } else if (lowerCommand.includes('show login') || lowerCommand.includes('open login')) {
                    authModal.style.display = 'flex';
                    action.executed = true;
                    action.response = "Opening the login/register module for you.";
                }

                // 3. Spontaneous Actions (Navigation within the app)
                else if (lowerCommand.includes('go to projects') || lowerCommand.includes('show me projects')) {
                    document.getElementById('projects').scrollIntoView({ behavior: 'smooth' });
                    action.executed = true;
                    action.response = "Scrolling down to the projects section now.";
                } else if (lowerCommand.includes('go to courses') || lowerCommand.includes('view courses')) {
                    document.getElementById('courses').scrollIntoView({ behavior: 'smooth' });
                    action.executed = true;
                    action.response = "Taking you to the available courses.";
                } else if (lowerCommand.includes('go to basics') || lowerCommand.includes('show basics')) {
                    document.getElementById('basics').scrollIntoView({ behavior: 'smooth' });
                    action.executed = true;
                    action.response = "Navigating to the Electronic Basics section.";
                }
                
                // 4. External Application Launches (New functionality)
                else if (lowerCommand.includes('open google')) {
                    window.open('https://www.google.com', '_blank');
                    action.executed = true;
                    action.response = "Opening Google in a new tab.";
                }
                else if (lowerCommand.includes('open instagram')) {
                    window.open('https://www.instagram.com', '_blank');
                    action.executed = true;
                    action.response = "Opening Instagram in a new tab.";
                } else if (lowerCommand.includes('open facebook')) {
                    window.open('https://www.facebook.com', '_blank');
                    action.executed = true;
                    action.response = "Opening Facebook in a new tab.";
                }
                 else if (lowerCommand.includes('open youtube')) {
                    window.open('https://www.youtube.com', '_blank');
                    action.executed = true;
                    action.response = "Opening YouTube in a new tab.";
                } else if (lowerCommand.includes('open calculator')) {
                    window.open('https://www.google.com/search?q=calculator', '_blank');
                    action.executed = true;
                    action.response = "Opening a calculator in a new tab.";
                } else if (lowerCommand.includes('open whatsapp')) {
                    window.open('https://web.whatsapp.com', '_blank');
                    action.executed = true;
                    action.response = "Opening WhatsApp Web in a new tab.";
                } else if (lowerCommand.includes('open email') || lowerCommand.includes('open gmail')) {
                    window.open('https://mail.google.com', '_blank');
                    action.executed = true;
                    action.response = "Opening Gmail in a new tab.";
                }
               
                else if (lowerCommand.includes('open twitter')) {
                    window.open('https://www.twitter.com', '_blank');
                    action.executed = true;
                    action.response = "Opening Twitter in a new tab.";
                }
                else if (lowerCommand.includes('open linkedin')) {
                    window.open('https://www.linkedin.com', '_blank');
                    action.executed = true;
                    action.response = "Opening LinkedIn in a new tab.";
                }
                // 5. Status Check
                else if (lowerCommand.includes('what is my progress') || lowerCommand.includes('my completion status')) {
                    const completed = Object.keys(userProgress).length;
                    const total = allConcepts.length;
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    if (!userId) {
                        action.response = "Please log in first to track your personalized learning progress.";
                    } else if (total === 0) {
                        action.response = "The learning path data is currently loading. Please try again in a moment.";
                    } else {
                        action.response = `You have completed ${completed} out of ${total} concepts, which is ${percentage} percent completion! Keep up the great work.`;
                    }
                    action.executed = true;
                }

                return action;
            }
            // --- END: Handle UI and Predefined Commands

            async function callGeminiApi(prompt, systemInstruction = null) {
                if (geminiApiKey === "") {
                    // This logic assumes the environment will inject the key, if not, it will fail gracefully.
                }
                
                let backoff = 1000;
                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        let chatHistoryForApi = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = {
                            contents: chatHistoryForApi,
                            systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined
                        };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                await new Promise(resolve => setTimeout(resolve, backoff));
                                backoff *= 2;
                                continue;
                            }
                            const errorBody = await response.json();
                            throw new Error(`API error: ${response.status} - ${errorBody.error.message}`);
                        }
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure how to respond to that.";
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        if (i === maxRetries - 1) throw error;
                    }
                }
            }

            // --- MODIFIED: processCommand to include predefined answers and spontaneous actions
            async function processCommand(command) {
                if (!command || techwhizInput.disabled) return;
                
                // Clear input only if it's not a voice command that populated it (recognition.onresult clears it)
                if (techwhizInput.value.trim() === command) {
                    techwhizInput.value = '';
                }

                // Show user message immediately
                appendMessage(command, 'user');
                
                techwhizInput.disabled = true;
                sendBtn.disabled = true;
                micBtn.disabled = true;
                thinkingStatus.classList.remove('hidden');

                try {
                    const lowerCommand = command.toLowerCase();
                    let responseText = '';
                    
                    // 1. Check for predefined UI/Action commands
                    const uiAction = handleUICommand(lowerCommand);

                    if (uiAction.executed) {
                        responseText = uiAction.response;
                    } else {
                        // 2. If not a predefined action, use Gemini API
                        let baseSystemInstruction = "You are a professional and helpful electronics and computer science assistant. Provide a friendly and concise answer. Respond exclusively in the language of the user's query. Do not refer to yourself as an AI or a language model.";

                        // Contextual hint for common electronics questions
                        if (lowerCommand.includes('arduino') || lowerCommand.includes('esp32') || lowerCommand.includes('resistor') || lowerCommand.includes('sensor')) {
                             baseSystemInstruction += " Provide a simple, clear explanation suitable for a beginner or hobbyist.";
                        }

                        responseText = await callGeminiApi(command, baseSystemInstruction);
                    }
                    
                    appendMessage(responseText, 'assistant');
                    readAloud(responseText);
                } catch (error) {
                    const errorMsg = "Sorry, I'm having trouble connecting to my brain right now. The API request failed.";
                    appendMessage(errorMsg, 'assistant');
                    readAloud(errorMsg);
                } finally {
                    // FIX: Re-enable ALL controls after processing, regardless of how the command started.
                    techwhizInput.disabled = false;
                    sendBtn.disabled = false;
                    micBtn.disabled = false;
// Cleanup visual state
                    thinkingStatus.classList.add('hidden');
                    micBtn.classList.remove('speech-active');
                    listeningStatus.classList.add('hidden');

                    techwhizInput.focus();
                }
            }
            
            // Initialization
            // Ensure the initial filter is applied to render projects immediately on load
            applyProjectFilter('all'); 
            updateCart();
            // Start the skill tree render with an empty progress object initially
            renderSkillTree({});
            
            if (window.renderMathInElement) {
                renderMathInElement(document.body);
            }
        });
    </script>
</body>
</html>

