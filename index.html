<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-TECH SOLUTIONS | Electronics & Computer Projects</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczNty6_2Cq0hySwk_JWjLVcINZz0lyqfq9BNLXjr9-qhG_94UV7oQLhTNB7VtAP8qM1G06Gj36pEqbZyvBWZlV4508OriC45KwQoabQ8qSRc5HHMGPVu=w2400?source=screenshot.guru">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- UPDATED: Added necessary Firebase Social Auth imports -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Load KaTeX for beautiful math/symbol rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" xintegrity="sha384-Gvr4iO9rQk5QxK3m1i5hI9jP5i5E6qE6kQ5A0tE4Q4p5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" xintegrity="sha384-6Xh5n0k2f/rJvC9g2z8tN7i5hE6qE6kQ5A0tE4Q4p5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" xintegrity="sha384-FpYtW5m3gT/4t7+p/K0m6p+g5/2w7J3w8P4q1n2p7Q3E" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    <!-- NEW: Load D3.js for Skill Tree Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            /* DARK THEME VARIABLES */
            --primary: #121212; /* Deep Dark Background */
            --secondary: #00e5ff; /* Cyan Accent - Main highlight */
            --accent: #ff4081; /* Pink Accent - Secondary highlight/call-to-action */
            --text-light: #ffffff; /* White text for visibility */
            --text-mid: #a0a0a0; /* Gray text for body/subtext */
            --card-bg: #1e1e1e; /* Slightly lighter card background */
            --border-color: #333333; /* Dark border lines */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary);
            color: var(--text-light); /* Ensure all body text is light */
            scroll-behavior: smooth;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* High Visibility Text */
        .glow-text {
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.2), 0 0 10px rgba(0, 229, 255, 0.4);
            color: var(--text-light);
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        header {
            background: rgba(18, 18, 18, 0.85); /* Semi-transparent dark header */
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .logo-text span {
            color: var(--accent);
        }
        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            position: relative;
        }
        nav a:hover {
            color: var(--secondary);
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
        }
        nav a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
        }

        .mobile-toggle {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .hero {
            padding: 10rem 0;
            text-align: center;
            position: relative;
            /* Added deep space background image */
            background-image: url('https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow: hidden;
        }
        
        /* Overlay for contrast */
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1;
        }

        .hero > .container {
            position: relative;
            z-index: 2;
        }
        
        .hero h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--secondary);
            text-shadow: 0 0 15px var(--secondary);
        }
        
        .section {
            padding: 8rem 0;
            position: relative;
        }

        .section-title h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            display: inline-block;
            margin-bottom: 2rem;
            /* Ensure the text is visible with gradient */
            background: linear-gradient(45deg, var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
        }
        
        /* Card Styles (Dark Mode, High Visibility) */
        .card-3d {
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        .card-3d:hover {
            transform: scale(1.05) translateZ(10px);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4);
            border-color: var(--secondary);
        }
        
        .glassmorphism {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .neon-glow {
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }
        
        .btn-3d {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            color: var(--text-light); /* Default button text color */
        }
        
        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        /* NEW: Box Style for Action Buttons */
        .btn-box {
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* Styling for the Primary Action Buttons (Add to Cart, Checkout) */
        .btn-primary-action {
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            color: var(--text-light);
            border: none;
        }
        .btn-primary-action:hover {
            opacity: 0.9;
            box-shadow: 0 0 15px var(--secondary);
            transform: scale(1.02);
        }

        /* Styling for the Secondary/Disabled Buttons (Available Soon) */
        .btn-secondary-action {
            background-color: var(--card-bg);
            color: var(--text-mid);
            border: 1px solid var(--secondary);
        }
        .btn-secondary-action.disabled {
            background-color: #333333;
            border-color: #555555;
            color: #777777;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Floating Button Positioning & Styling */
        #techwhiz-fab {
            bottom: 2rem;
            right: 2rem;
            z-index: 1001;
            width: 64px;
            height: 64px;
            border-radius: 0.5rem; /* Box Type */
        }

        #cart-fab {
            /* Positioned 4rem (64px button height + 16px gap) above techwhiz-fab (2rem) */
            bottom: 6rem;
            right: 2rem;
            z-index: 1002; /* Above techwhiz */
            width: 60px;
            height: 60px;
            border-radius: 0.5rem; /* Box Type */
            background: linear-gradient(145deg, var(--secondary), var(--accent));
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed; /* Added to ensure it floats */
        }
        
        #cart-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.7);
        }

        #cart-fab:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        #cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 9999px;
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            line-height: 1;
        }

        /* Cart Modal Styling (Futuristic, Slides In) */
        #cart-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px; /* Enhanced max width */
            height: 100%;
            background: var(--card-bg);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.7);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1003;
            display: flex;
            flex-direction: column;
            border-left: 2px solid var(--secondary); /* Neon border */
        }
        
        #cart-modal.open {
            transform: translateX(0);
        }
        
        .cart-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary); /* Header contrast */
        }
        
        .cart-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
        }
        
        #close-cart-btn {
            font-size: 2rem;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }
        
        #cart-modal-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
            background: var(--card-bg);
        }

        .cart-modal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .cart-modal-item img {
            min-width: 48px;
            min-height: 48px;
        }
        
        /* NEW: Cart Item Controls Styling */
        .cart-controls button {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            line-height: 1;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .cart-controls button:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .cart-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--primary);
        }
        
        .cart-total-display {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 1rem;
        }
        
        .cart-total-display span:last-child {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(255, 64, 129, 0.5);
        }
        
        /* Component Detail Modal Styling */
        #component-detail-modal {
            background: rgba(0, 0, 0, 0.9);
            /* Centering fix applied here */
            display: none; /* Hidden by default */
            position: fixed;
            inset: 0;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1005;
        }
        
        #component-detail-content {
            background: var(--card-bg);
            border: 1px solid var(--secondary);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            color: var(--text-light);
            max-width: 800px;
            width: 100%;
            padding: 2rem;
            border-radius: 0.75rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #component-detail-content .detail-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        #component-detail-content .detail-info h4 {
            color: var(--secondary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-family: 'Orbitron', sans-serif;
        }

        /* NEW: Canvas for Sensor Mock Visualization */
        #sensor-viz-canvas {
            width: 100%;
            height: 150px;
            background-color: #0d0d0d;
            border: 1px solid var(--accent);
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        /* New Styles for Dynamic Suggestions Sidebar */
        .suggestions-sidebar {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 250px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(5px);
            border-right: 2px solid var(--accent);
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            padding: 1rem;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            z-index: 999;
            max-height: 60vh;
            overflow-y: auto;
        }
        .suggestions-sidebar a {
            text-decoration: none;
        }
        .progress-bar-container {
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--secondary);
            transition: width 0.5s ease-in-out;
        }
        
        /* D3 Skill Tree Container */
        #skill-tree-container {
            width: 100%;
            height: 600px;
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            margin-top: 3rem;
            border: 1px solid var(--border-color);
            overflow: auto; /* Ensure tree is viewable */
        }
        
        /* D3 Node Styles */
        .node circle {
            cursor: pointer;
            fill: #555;
            stroke: var(--secondary);
            stroke-width: 3px;
            transition: all 0.3s;
        }
        .node.completed circle {
            fill: var(--secondary);
            stroke: var(--accent);
        }
        .node text {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            fill: var(--text-light);
        }
        .link {
            fill: none;
            stroke: #555;
            stroke-width: 1.5px;
            transition: stroke 0.3s;
        }
        .link.completed {
            stroke: var(--secondary);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
                color: var(--text-light);
            }
            nav ul {
                display: none;
                flex-direction: column;
                width: 100%;
                position: absolute;
                top: 100%;
                left: 0;
                background: var(--card-bg); /* Dark background for mobile menu */
                border-top: 1px solid var(--border-color);
            }
            nav ul.active {
                display: flex;
            }
            .user-status {
                display: none;
            }
            .about-content, .contact-container {
                flex-direction: column;
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2.2rem;
            }
            
            #cart-modal {
                max-width: 100%; /* Full width on mobile */
            }

            #techwhiz-fab, #cart-fab {
                right: 1rem;
                bottom: 1rem;
                width: 50px;
                height: 50px;
            }

            #cart-fab {
                bottom: 4.5rem; /* 50px + 10px gap */
            }

            #component-detail-content {
                max-width: 100%;
                padding: 1rem;
            }
            .detail-content {
                flex-direction: column;
            }
            .suggestions-sidebar {
                display: none; /* Hide sidebar on mobile for space */
            }
        }
        
        /* Project Detail Modal Fixes for visibility */
        #project-detail-modal {
            background: rgba(0, 0, 0, 0.9);
        }

        #project-detail-content {
            background: var(--card-bg);
            border: 1px solid var(--secondary);
            color: var(--text-light);
        }

        .close-project-detail {
            color: var(--text-light);
        }
        
        .project-detail-meta {
            color: var(--secondary);
        }

        .project-detail-info {
            color: var(--text-mid);
        }
        
        /* Component Detail Modal Fixes (Targeted for high visibility) */
        .component-detail {
            /* This section is removed as it's now replaced by #component-detail-modal */
            display: none !important;
        }
        
        /* Form input color fix */
        input:not(.razorpay-payment-button), textarea {
            background-color: #333333 !important;
            border-color: #555555 !important;
            color: var(--text-light) !important;
        }

        /* Overriding tailwind classes for text visibility */
        .text-gray-700 {
            color: var(--text-mid);
        }
        .text-black {
            color: var(--text-light);
        }
        .bg-gray-800 {
            background-color: #333 !important;
        }
        .bg-gray-900 {
            background-color: #121212 !important;
        }
        
        /* KaTeX specific style override for dark mode */
        .katex {
            color: var(--secondary);
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* FIX: Center all Modals */
        .modal-overlay-center {
            position: fixed;
            inset: 0;
            display: none; /* Hidden by default */
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 1rem;
            z-index: 1005;
            overflow-y: auto; /* Allow scrolling if content is too large */
        }
        
        /* NEW: Image scaling fix for component detail modal */
        #component-detail-content img {
            object-fit: contain; /* Ensures the whole image is visible without cropping */
            max-height: 200px; /* Optional: Constrain max height for better layout on desktop */
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo flex items-center">
                <img src="https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400" alt="INDRA" class="w-12 h-12 rounded-full border-2 border-secondary">
                <div class="logo-text ml-4 glow-text">E-TECH <span>SOLUTIONS</span></div>
            </div>
            <div class="mobile-toggle"><i class="fas fa-bars"></i></div>
            <nav>
                <ul id="nav-menu" class="flex list-none gap-6 text-xl">
                    <li><a href="#home" class="nav-link-3d active">Home</a></li>
                    <li><a href="#about" class="nav-link-3d">About</a></li>
                    <li><a href="#basics" class="nav-link-3d">Basics</a></li>
                    <li><a href="#microcontrollers" class="nav-link-3d">Microcontrollers</a></li>
                    <li><a href="#sensors" class="nav-link-3d">Sensors</a></li>
                    <li><a href="#courses" class="nav-link-3d">Courses</a></li>
                    <li><a href="#projects" class="nav-link-3d">Projects</a></li>
                    <li><a href="https://forms.gle/ruvWdt6W2N5QmdRN6" class="nav-link-3d">Contact</a></li>
                    <li id="user-nav">
                        <a href="#" id="login-btn-nav" class="nav-link-3d">Login</a>
                        <!-- UPDATED: Added click event to user avatar for profile modal -->
                        <div class="user-status flex items-center hidden" id="user-status">
                            <div id="user-avatar" class="user-avatar w-10 h-10 rounded-lg bg-secondary text-white flex items-center justify-center font-bold cursor-pointer hover:ring-2 ring-accent transition-all"></div>
                            <span id="user-name" class="ml-2"></span>
                            <a href="#" id="logout-btn" class="ml-4 nav-link-3d">Logout</a>
                            <a href="#" id="order-history-btn" class="ml-4 nav-link-3d">Orders</a>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero" id="home">
        <div class="container">
            <h1>Electronics & Computer Science Projects</h1>
            <p class="mt-4 text-lg text-gray-400 relative z-20">Master electronics and computer science by building real-world projects with our comprehensive learning resources.</p>
            <div class="hero-btns mt-10 relative z-20">
                <a href="#projects" class="btn btn-3d bg-secondary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg transition-all">Explore Projects</a>
                <a href="#courses" class="btn btn-3d border-2 border-secondary text-secondary hover:text-white hover:bg-secondary font-bold py-3 px-6 rounded-lg transition-all ml-4">View Courses</a>
                <a href="https://forms.gle/fgiNbFHnNMYH2QqW8" class="btn btn-3d btn-primary-action btn-box text-white font-bold transition-all ml-4">
                    <i class="fas fa-shopping-cart"></i> Buy Kits
                </a>
            </div>
        </div>
    </section>

    <section class="section" id="about">
        <div class="container">
            <div class="section-title text-center">
                <h2>About Me</h2>
            </div>
            <!-- The 'About Me' content remains here, correctly located in the #about section -->
            <div class="about-content flex flex-col md:flex-row gap-10 items-center justify-center card-3d glassmorphism p-8 neon-border">
                <div class="profile-img transform hover:rotate-3 transition-transform duration-500">
                    <img src="https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400" alt="INDRA" class="rounded-xl shadow-xl transition-all duration-500 hover:shadow-2xl hover:scale-105 border-4 border-secondary/50">
                </div>
                <div class="profile-info text-center md:text-left">
                    <h3 class="text-3xl font-bold font-orbitron text-white">Hi, I'm INDRA</h3>
                    <p class="mt-4 text-lg text-gray-400">I'm an electronics engineer and educator with over 3 years of experience in the field. My passion is to make electronics and computer science education accessible to everyone, regardless of their background or experience level.</p>
                    <div class="qualifications mt-6">
                        <h4 class="text-xl font-orbitron font-bold text-secondary">Qualifications</h4>
                        <ul class="list-none mt-2 text-gray-400">
                            <li class="flex items-center mt-2"><i class="fas fa-graduation-cap mr-2 text-secondary"></i> DIPLOMA in Electronics And Communication Engineering</li>
                            <li class="flex items-center mt-2"><i class="fas fa-certificate mr-2 text-secondary"></i> Certified IoT Specialist</li>
                            <li class="flex items-center mt-2"><i class="fas fa-briefcase mr-2 text-secondary"></i> 2+ years of industry experience</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="basics">
        <div class="container">
            <div class="section-title text-center">
                <h2>Electronic Basics</h2>
                <p class="text-gray-400">Learn the fundamental components that form the building blocks of all electronic devices</p>
            </div>
            <!-- Skill Tree Visualization Container -->
           
            <!-- End Skill Tree Visualization Container -->

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mt-12">
                <!-- Component Cards -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="resistor" data-concept-id="resistor-basics">
                    <div class="component-icon"><i class="fas fa-bolt"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Resistor</h4>
                    <p class="text-sm mt-2 text-gray-400">Limit and control the flow of electric current</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="capacitor" data-concept-id="capacitor-basics">
                    <div class="component-icon"><i class="fas fa-battery-half"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Capacitor</h4>
                    <p class="text-sm mt-2 text-gray-400">Store and release electrical energy</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="inductor" data-concept-id="inductor-basics">
                    <div class="component-icon"><i class="fas fa-magnet"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Inductor</h4>
                    <p class="text-sm mt-2 text-gray-400">Store energy in a magnetic field</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="diode" data-concept-id="diode-basics">
                    <div class="component-icon"><i class="fas fa-arrow-right"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Diode</h4>
                    <p class="text-sm mt-2 text-gray-400">Allow current to flow in one direction</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="transistor" data-concept-id="transistor-basics">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Transistor</h4>
                    <p class="text-sm mt-2 text-gray-400">Act as electronic switches or amplifiers</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="ic" data-concept-id="ic-basics">
                    <div class="component-icon"><i class="fas fa-braille"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Integrated Circuit (IC)</h4>
                    <p class="text-sm mt-2 text-gray-400">Miniaturized circuits on a single chip</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="microcontrollers">
        <div class="container">
            <div class="section-title text-center">
                <h2>Microcontrollers</h2>
                <p class="text-gray-400">Explore popular microcontroller platforms for embedded systems development</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Microcontroller Cards (with cursor-pointer added) -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-uno" data-concept-id="mcu-arduino-uno">
                    <div class="component-icon"><i class="fas fa-bolt"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Uno</h4>
                    <p class="text-sm mt-2 text-gray-400">The most popular Arduino board for beginners</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-nano" data-concept-id="mcu-arduino-nano">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Nano</h4>
                    <p class="text-sm mt-2 text-gray-400">A compact and breadboard-friendly version</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="arduino-mega" data-concept-id="mcu-arduino-mega">
                    <div class="component-icon"><i class="fas fa-list-ol"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Arduino Mega</h4>
                    <p class="text-sm mt-2 text-gray-400">Ideal for complex projects with many I/O pins</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="esp32" data-concept-id="mcu-esp32">
                    <div class="component-icon"><i class="fas fa-wifi"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">ESP32</h4>
                    <p class="text-sm mt-2 text-gray-400">Wi-Fi and Bluetooth enabled MCU</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="raspberrypi" data-concept-id="mcu-rpi-pico">
                    <div class="component-icon"><i class="fas fa-computer"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Raspberry Pi Pico</h4>
                    <p class="text-sm mt-2 text-gray-400">Powerful, low-cost MCU</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="stm32" data-concept-id="mcu-stm32">
                    <div class="component-icon"><i class="fas fa-microchip"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">STM32</h4>
                    <p class="text-sm mt-2 text-gray-400">High-performance ARM-based MCUs</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="avr" data-concept-id="mcu-avr">
                    <div class="component-icon"><i class="fas fa-desktop"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">AVR</h4>
                    <p class="text-sm mt-2 text-gray-400">Used in many hobbyist projects</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg cursor-pointer" data-component="pic" data-concept-id="mcu-pic">
                    <div class="component-icon"><i class="fas fa-gear"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">PIC</h4>
                    <p class="text-sm mt-2 text-gray-400">Simple and reliable MCUs</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="sensors">
        <div class="container">
            <div class="section-title text-center">
                <h2>Sensors</h2>
                <p class="text-gray-400">Discover various sensors that enable interaction between the physical and digital worlds</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-8">
                <!-- Sensor Cards (with cursor-pointer added) -->
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="ultrasonic" data-concept-id="sensor-ultrasonic">
                    <div class="component-icon"><i class="fas fa-wave-square"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Ultrasonic</h4>
                    <p class="text-sm mt-2 text-gray-400">Distance measurement using sound waves</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="pir" data-concept-id="sensor-pir">
                    <div class="component-icon"><i class="fas fa-running"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">PIR Motion</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect human movement in an area</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="temperature" data-concept-id="sensor-temperature">
                    <div class="component-icon"><i class="fas fa-thermometer-half"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Temperature</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure ambient temperature</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="humidity" data-concept-id="sensor-humidity">
                    <div class="component-icon"><i class="fas fa-tint"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Humidity</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure moisture in the air</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="light" data-concept-id="sensor-ldr">
                    <div class="component-icon"><i class="fas fa-lightbulb"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Light (LDR)</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure light intensity</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="gas" data-concept-id="sensor-gas">
                    <div class="component-icon"><i class="fas fa-cloud"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Gas (MQ series)</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect specific gases</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="soilmoisture" data-concept-id="sensor-soil">
                    <div class="component-icon"><i class="fas fa-seedling"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Soil Moisture</h4>
                    <p class="text-sm mt-2 text-gray-400">Check moisture levels in soil</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="rfid" data-concept-id="sensor-rfid">
                    <div class="component-icon"><i class="fas fa-id-card"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">RFID</h4>
                    <p class="text-sm mt-2 text-gray-400">Radio frequency identification technology</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="accelerometer" data-concept-id="sensor-accelerometer">
                    <div class="component-icon"><i class="fas fa-arrows-up-down-left-right"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Accelerometer</h4>
                    <p class="text-sm mt-2 text-gray-400">Measure acceleration and tilt</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="sound" data-concept-id="sensor-sound">
                    <div class="component-icon"><i class="fas fa-volume-up"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Sound</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect and measure sound levels</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="heartbeat" data-concept-id="sensor-heartbeat">
                    <div class="component-icon"><i class="fas fa-heartbeat"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Heartbeat</h4>
                    <p class="text-sm mt-2 text-gray-400">Monitor heart rate and pulse</p>
                </div>
                <div class="component-card card-3d glassmorphism p-6 text-center rounded-lg neon-border cursor-pointer" data-component="gesture" data-concept-id="sensor-gesture">
                    <div class="component-icon"><i class="fas fa-hand-rock"></i></div>
                    <h4 class="font-orbitron text-xl font-bold text-white">Gesture</h4>
                    <p class="text-sm mt-2 text-gray-400">Detect and interpret hand movements</p>
                </div>
            </div>
        </div>
    </section>
    
    <section class="section" id="courses">
        <div class="container">
            <div class="section-title text-center">
                <h2>Our Premium Courses</h2>
                <p class="text-gray-400">Unlock in-depth knowledge and advanced project building with our specialized courses.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://lh3.googleusercontent.com/pw/AP1GczPvtSebwcEAoTS8k-OCNn_xZnUKH5rZXKAI4jLois7jfNsvPT14A1m11ZxNc1OFk6QXgYjp9lHolvmOWD8YnrbuP2acdqCFe_XIolbmvWSOd38hTmc=w2400" alt="Arduino Master" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">Arduino Master Class</h3>
                        <p class="text-gray-400 mt-2">Become a master of Arduino programming and hardware. This course covers advanced topics, complex projects, and troubleshooting techniques.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80" alt="AI for Robotics" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">AI for Robotics</h3>
                        <p class="text-gray-400 mt-2">Dive into the world of Artificial Intelligence applied to robotics. Learn machine learning fundamentals, computer vision, and robot navigation.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
                <div class="course-card card-3d glassmorphism p-6 rounded-xl overflow-hidden neon-border">
                    <img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80" alt="IoT Course" class="rounded-md w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                    <div class="mt-4">
                        <h3 class="font-orbitron text-2xl font-bold text-white">Advanced IoT Development</h3>
                        <p class="text-gray-400 mt-2">Master the Internet of Things with advanced development techniques, cloud integration, data analytics, and security best practices.</p>
                        <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹ _ _9</div>
                        <a href="https://etechcourse11.netlify.app/" class="btn btn-3d btn-secondary-action disabled py-2 px-4 mt-4 rounded-lg inline-block">AVAILABLE SOON</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="projects">
        <div class="container">
            <div class="section-title text-center">
                <h2>Electronics & CSE Projects</h2>
                <p class="text-gray-400">Browse our collection of IoT, Arduino, and Computer Science projects with complete guides and code.</p>
            </div>
            <div class="project-filters flex justify-center flex-wrap gap-4 mb-8">
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg active bg-secondary hover:bg-accent" data-filter="all">All</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg" data-filter="iot">IoT</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg" data-filter="arduino">Arduino</button>
                <button class="filter-btn btn btn-3d bg-gray-800 text-white py-2 px-4 rounded-lg" data-filter="cse">Computer Science</button>
            </div>
            <div class="projects-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8" id="projects-grid">
                <!-- Projects will be dynamically rendered here -->
            </div>
        </div>
    </section>
    
    <section class="section" id="contact">
        <div class="container">
            <div class="section-title text-center">
                <h2>Contact Me</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="contact-info flex flex-col gap-6">
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Location</h4>
                            <p class="text-gray-400">Sri Sathya Sai, India</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-phone"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Phone</h4>
                            <p class="text-gray-400">+91 9392090575, +91 9618646604, +91 7619457762</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-envelope"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Email</h4>
                            <p class="text-gray-400">etechsolutions9392@gmail.com</p>
                        </div>
                    </div>
                    <div class="contact-card card-3d glassmorphism p-6 rounded-xl neon-border flex items-center gap-4">
                        <div class="contact-icon w-14 h-14 rounded-lg bg-secondary flex items-center justify-center text-xl text-white"><i class="fas fa-globe"></i></div>
                        <div class="contact-text">
                            <h4 class="font-orbitron text-lg font-bold text-white">Website</h4>
                            <p class="text-gray-400">etechsolutions.co.in</p>
                        </div>
                    </div>
                </div>
                <form id="contactForm" class="contact-form glassmorphism p-8 rounded-xl neon-border flex flex-col gap-4">
                    <div class="form-group">
                        <label for="name" class="block mb-2 font-bold text-gray-400">Your Name</label>
                        <input type="text" id="name" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors text-white">
                    </div>
                    <div class="form-group">
                        <label for="email" class="block mb-2 font-bold text-gray-400">Email Address</label>
                        <input type="email" id="email" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors text-white">
                    </div>
                    <div class="form-group">
                        <label for="subject" class="block mb-2 font-bold text-gray-400">Subject</label>
                        <input type="text" id="subject" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-secondary transition-colors">
                    </div>
                    <div class="form-group">
                        <label for="message" class="block mb-2 font-bold text-gray-400">Message</label>
                        <textarea id="message" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors text-white"></textarea>
                    </div>
                    <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full mt-4">Send Message</button>
                </form>
            </div>
        </div>
    </section>

    <footer class="bg-card-bg p-8 border-t border-border-color">
        <div class="container">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="footer-col">
                    <h4 class="font-orbitron text-xl font-bold text-white">E-TECH SOLUTIONS</h4>
                    <p class="text-sm mt-4 text-gray-400">Providing high-quality e-learning resources for electronics enthusiasts and students worldwide.</p>
                    <div class="social-links flex gap-4 mt-4">
                        <a href="https://www.facebook.com/share/1YqHbBfq8W/" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-secondary hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://www.instagram.com/e_techsolutions_?igsh=am0wa3ZoY2c5ZDE=" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-accent hover:text-white transition-colors"><i class="fab fab fa-instagram"></i></a>
                        <a href="https://youtube.com/@e-techsolutions-techwhiz?si=rWXLsO87Y93k34dF" class="w-10 h-10 rounded-lg bg-border-color text-gray-400 flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Learning Resources</h4>
                    <ul class="list-none mt-4 text-gray-400">
                        <li><a href="#basics" class="hover:text-secondary transition-colors">Electronics Basics</a></li>
                        <li><a href="#microcontrollers" class="hover:text-secondary transition-colors">Microcontrollers</a></li>
                        <li><a href="#sensors" class="hover:text-secondary transition-colors">Sensors</a></li>
                        <li><a href="#courses" class="hover:text-secondary transition-colors">Courses</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Quick Links</h4>
                    <ul class="list-none mt-4 text-gray-400">
                        <li><a href="#home" class="hover:text-secondary transition-colors">Home</a></li>
                        <li><a href="#about" class="hover:text-secondary transition-colors">About</a></li>
                        <li><a href="#projects" class="hover:text-secondary transition-colors">Projects</a></li>
                        <li><a href="#contact" class="hover:text-secondary transition-colors">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4 class="font-orbitron text-lg font-bold text-white">Newsletter</h4>
                    <p class="text-sm mt-4 text-gray-400">Subscribe for the latest tutorials and project ideas.</p>
                    <form>
                        <input type="email" placeholder="Your Email Address" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:border-secondary transition-colors mt-4 text-white">
                        <a href="https://forms.gle/ruvWdt6W2N5QmdRN6"><button type="submit" class="btn btn-3d btn-primary-action btn-box w-full mt-4">Subscribe</button></a>
                    </form>
                </div>
            </div>
            <div class="text-center mt-8 text-gray-500 text-sm border-t border-border-color pt-6">
                &copy; 2025 E-TECH SOLUTIONS. All Rights Reserved.
            </div>
        </div>
    </footer>

   
    <!-- Chatbot Button (Z-index 1001, bottom: 2rem) -->
    <button id="techwhiz-fab" class="btn btn-3d fixed w-16 h-16 flex items-center justify-center text-3xl text-white focus:outline-none focus:ring-4 focus:ring-secondary/50" style="background: linear-gradient(145deg, var(--secondary), var(--accent));">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- Floating Cart Button (Z-index 1002, bottom: 6rem, above TechWhiz) -->
    <button id="cart-fab" class="fixed text-xl text-white focus:outline-none">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count">0</span>
    </button>
    
    <!-- Cart Modal (Advanced Floating Panel) -->
    <div id="cart-modal">
        <div class="cart-header">
            <h3 class="text-white">Your Cart (<span id="cart-item-count-header">0</span>)</h3>
            <button id="close-cart-btn" class="text-white hover:text-accent">&times;</button>
        </div>
        <div id="cart-modal-items" class="bg-card-bg">
            <p class="cart-empty-msg text-gray-400 text-center p-8">Your cart is currently empty. Start exploring projects!</p>
        </div>
        <div class="cart-footer bg-card-bg">
            <div class="cart-total-display">
                <span class="text-white">Total:</span>
                <span id="cart-total-price">₹0</span>
            </div>
            <button id="cart-checkout-btn" class="btn btn-3d btn-primary-action btn-box w-full">Proceed to Checkout</button>
        </div>
    </div>
    
    <!-- Component Detail MODAL (Overlay component details here) -->
    <div id="component-detail-modal">
        <div id="component-detail-content" class="glassmorphism p-8 rounded-xl relative">
            <div class="detail-header flex justify-between items-center">
                <h3 class="font-orbitron text-2xl font-bold text-secondary" id="detail-title">Component Details</h3>
                <button class="close-detail absolute top-4 right-4 text-4xl text-gray-400 hover:text-accent transition-colors">&times;</button>
            </div>
            <div class="detail-content flex flex-col md:flex-row gap-8 mt-6">
                <!-- IMPORTANT: Removed object-cover and set max-height to 200px in CSS class above for object-fit: contain -->
                <img id="detail-img" src="https://via.placeholder.com/400x300" alt="Component" class="rounded-lg shadow-lg w-full md:w-1/3 object-cover border-2 border-secondary/50">
                <div class="detail-info flex-1">
                    <h4 class="font-bold text-lg text-secondary">Definition</h4>
                    <p id="detail-definition" class="text-gray-400"></p>
                    <h4 class="font-bold text-lg text-secondary mt-4">Symbol</h4>
                    <div id="detail-symbol" class="text-gray-400 p-2 border border-border-color rounded-lg mt-1"></div>
                    <!-- NEW: Sensor Visualization Container (only visible for sensor types) -->
                    <div id="sensor-visualization-area" class="mt-4 hidden">
                         <h4 class="font-bold text-lg text-accent">Live Data Mock-up</h4>
                         <canvas id="sensor-viz-canvas"></canvas>
                         <p id="sensor-data-readout" class="text-sm text-gray-500 mt-1 italic">Status: Idle</p>
                    </div>
                    <!-- END: Sensor Visualization Container -->
                    <h4 class="font-bold text-lg text-secondary mt-4">Characteristics</h4>
                    <ul id="detail-characteristics" class="list-disc ml-6 text-gray-400"></ul>
                    <h4 class="font-bold text-lg text-secondary mt-4">Applications</h4>
                    <p id="detail-applications" class="text-gray-400"></p>
                </div>
            </div>
            <div class="mt-8">
                <button id="ask-techwhiz-component-btn" class="btn btn-3d btn-secondary-action btn-box w-full">
                    <i class="fas fa-robot mr-2"></i> Ask TechWhiz About This Component
                </button>
            </div>
        </div>
    </div>
    <!-- END: Component Detail MODAL -->
    
    <!-- Chatbox Modal -->
    <div id="techwhiz-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div id="assistant-chat-modal-content" class="rounded-lg shadow-2xl max-w-lg w-full bg-gray-900 border border-secondary/20">
            <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center rounded-t-lg">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-robot mr-3 text-secondary"></i>TECHWHIZ Assistant</h3>
                <button id="close-techwhiz-modal" class="text-gray-400 hover:text-white text-4xl leading-none">&times;</button>
            </div>
            <div id="chat-history" class="p-4 overflow-y-auto h-[400px] flex flex-col-reverse gap-3">
                <div class="chat-message assistant p-3 rounded-lg rounded-bl-none self-start mr-auto bg-gray-800 text-white" style="font-size:15px; font-weight:normal; padding:10px; border-radius:10px; margin-right:auto;">Hello! How can I help you today with electronics and CSE concepts?</div>
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-900">
                <div class="flex items-center space-x-2">
                    <input type="text" id="techwhiz-input" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-secondary transition-colors" placeholder="Ask me anything...">
                    <button id="mic-btn" class="btn btn-3d bg-secondary hover:bg-accent text-white py-3 px-4 rounded-lg"><i class="fas fa-microphone"></i></button>
                    <button id="send-btn" class="btn btn-3d bg-secondary hover:bg-accent text-white py-3 px-4 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <button id="stop-speech-btn" class="btn bg-accent hover:bg-red-700 py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-volume-mute mr-2"></i>Stop
                    </button>
                    <span id="listening-status" class="text-sm text-gray-500 italic hidden">Listening...</span>
                    <span id="thinking-status" class="text-sm text-secondary italic hidden">Thinking...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="auth-modal" class="modal-overlay-center">
        <!-- LOGIN MODAL CONTAINER - Centered via items-center and justify-center -->
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-md w-full border border-secondary/20">
            <div class="flex justify-end"><button class="close-auth text-3xl text-gray-400 hover:text-white">&times;</button></div>
            <div class="auth-tabs flex justify-around mb-6 border-b border-gray-700">
                <div class="auth-tab text-xl font-bold py-2 px-4 cursor-pointer text-secondary active" data-tab="login">Login</div>
                <div class="auth-tab text-xl font-bold py-2 px-4 cursor-pointer text-gray-400" data-tab="register">Register</div>
            </div>
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Email" required>
                <input type="password" id="login-password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-6 focus:outline-none focus:border-secondary" placeholder="Password" required>
                <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full">Login</button>
            </form>
            
            <!-- Register Form -->
            <form id="register-form" class="auth-form hidden">
                <input type="text" id="register-name" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Full Name" required>
                <input type="email" id="register-email" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-4 focus:outline-none focus:border-secondary" placeholder="Email" required>
                <input type="password" id="register-password" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white mb-6 focus:outline-none focus:border-secondary" placeholder="Password" required>
                <button type="submit" class="btn btn-3d btn-primary-action btn-box w-full">Register</button>
            </form>

            <!-- Social Login Options -->
            <div class="mt-6">
                <div class="text-center text-gray-500 mb-4">OR</div>
                <button id="google-login-btn" class="btn btn-3d w-full py-3 rounded-lg bg-white text-black font-bold flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i class="fab fa-google mr-3"></i> Sign in with Google
                </button>
                <!-- NOTE: Instagram/Facebook login requires complex server-side authentication (OAuth). 
                     We'll use a placeholder button for visual continuity, recommending the use of Google. -->
                <button disabled class="btn btn-3d w-full py-3 rounded-lg bg-blue-600 text-white font-bold flex items-center justify-center mt-3 cursor-not-allowed opacity-50">
                    <i class="fab fa-instagram mr-3"></i> Sign in with Instagram (Unavailable)
                </button>
            </div>
        </div>
    </div>

    <!-- Order History Modal -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="order-history-modal" class="modal-overlay-center">
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-lg w-full border border-secondary/20">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold font-orbitron text-secondary">Your Order History</h2>
                <button class="close-history text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="order-history-list" class="mt-6 h-[400px] overflow-y-auto">
                <p class="text-center text-gray-500">You have no past orders.</p>
            </div>
        </div>
    </div>
    
    <!-- NEW: Profile Management Modal -->
    <!-- UPDATED: Added modal-overlay-center class -->
    <div id="profile-modal" class="modal-overlay-center">
        <div class="bg-gray-900 rounded-lg shadow-2xl p-8 max-w-xl w-full border border-accent/20">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold font-orbitron text-accent"><i class="fas fa-user-cog mr-2"></i> User Profile & Settings</h2>
                <button id="close-profile-btn" class="text-3xl text-gray-400 hover:text-white">&times;</button>
            </div>
            
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- User Info -->
                <div class="glassmorphism p-4 rounded-lg border border-border-color">
                    <h3 class="text-xl font-bold text-secondary mb-3">Account Details</h3>
                    <p class="text-gray-400"><strong>Display Name:</strong> <span id="profile-display-name" class="text-white"></span></p>
                    <p class="text-gray-400"><strong>Email:</strong> <span id="profile-email" class="text-white"></span></p>
                    <p class="text-gray-400"><strong>User ID:</strong> <span id="profile-user-id" class="text-xs text-accent break-all"></span></p>
                    <button id="edit-profile-btn" class="btn btn-3d btn-secondary-action py-2 px-4 mt-4 w-full">Edit Name</button>
                </div>
                
               
            
            <div class="mt-6 border-t border-border-color pt-6 text-center">
                 <button id="profile-logout-btn" class="btn btn-3d bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg">Sign Out</button>
            </div>
        </div>
    </div>
    <!-- END: Profile Management Modal -->


    <!-- Project Detail Modal -->
    <!-- NOTE: #project-detail-modal already had fixed, inset-0, items-center, justify-center which centers it. -->
    <div id="project-detail-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div id="project-detail-content" class="glassmorphism p-8 rounded-xl max-w-3xl w-full relative">
            <button class="close-project-detail absolute top-4 right-4 text-4xl text-white hover:text-secondary">&times;</button>
            <img id="project-detail-image" src="" alt="Project Image" class="rounded-lg w-full h-64 object-cover border-2 border-secondary/50">
            <div class="mt-4">
                <h3 class="text-3xl font-orbitron font-bold text-white" id="project-detail-title"></h3>
                <div class="project-detail-meta flex gap-4 text-sm mt-2">
                    <span id="project-detail-time"><i class="fas fa-clock"></i></span>
                    <span id="project-detail-chip"><i class="fas fa-microchip"></i></span>
                </div>
                <p class="mt-4 text-gray-400" id="project-detail-description"></p>
                <div class="project-detail-info mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-xl font-bold text-secondary">Key Features</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-features"></ul>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-secondary">Required Components</h4>
                        <ul class="list-disc ml-6 mt-2 text-gray-400" id="project-detail-components"></ul>
                    </div>
                </div>
                <!-- NEW: Circuit Simulator Placeholder -->
                <button id="simulator-placeholder-btn" class="btn btn-3d bg-purple-700 hover:bg-purple-800 text-white py-2 px-4 rounded-lg mt-4 w-full">
                    <i class="fas fa-microchip mr-2"></i> Embedded Circuit Simulator (Coming Soon)
                </button>
                <!-- END: Circuit Simulator Placeholder -->
                <button id="ai-summary-btn" class="btn btn-3d bg-accent text-white py-2 px-4 rounded-lg mt-4 w-full">AI-Powered Summary ✨</button>
                <div id="ai-summary-container" class="glassmorphism p-4 mt-4 rounded-lg hidden border border-accent/50">
                    <p id="ai-summary-text" class="text-sm italic text-gray-400"></p>
                </div>
                <button id="add-to-cart-from-detail" class="btn btn-3d btn-primary-action btn-box w-full mt-4 text-lg">Add to Cart</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Config & Setup ---
            const __app_id = "default-app-id";
            const __firebase_config = '{"apiKey": "AIzaSyCyk9Jg_FW7jbVFh5XasK1Vb8_sP8J4zSE", "authDomain": "etech-d39e5.firebaseapp.com", "projectId": "etech-d39e5", "storageBucket": "etech-d39e5.firebasestorage.app", "messagingSenderId": "323388421053", "appId": "1:323388421053:web:9057d22d4ee4b7450398d4", "measurementId": "G-EV7M78EBGC"}';
            
            const firebaseConfig = JSON.parse(__firebase_config);
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            firebase.firestore.setLogLevel('debug');

            // --- UI Elements ---
            const authModal = document.getElementById('auth-modal');
            const loginBtnNav = document.getElementById('login-btn-nav');
            const closeAuthBtn = document.querySelector('.close-auth');
            const authTabs = document.querySelectorAll('.auth-tab');
            const authForms = document.querySelectorAll('.auth-form');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const userStatus = document.getElementById('user-status');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileToggle = document.querySelector('.mobile-toggle');
            const navMenu = document.getElementById('nav-menu');
            const techwhizFab = document.getElementById('techwhiz-fab');
            const techwhizModal = document.getElementById('techwhiz-modal');
            const closeTechwhizModalBtn = document.getElementById('close-techwhiz-modal');
            const chatHistory = document.getElementById('chat-history');
            const techwhizInput = document.getElementById('techwhiz-input');
            const micBtn = document.getElementById('mic-btn');
            const sendBtn = document.getElementById('send-btn');
            const stopSpeechBtn = document.getElementById('stop-speech-btn');
            const listeningStatus = document.getElementById('listening-status');
            const thinkingStatus = document.getElementById('thinking-status');
            const orderHistoryBtn = document.getElementById('order-history-btn');
            const orderHistoryModal = document.getElementById('order-history-modal');
            const closeHistoryBtn = document.querySelector('.close-history');
            const orderHistoryList = document.getElementById('order-history-list');
            const projectsGrid = document.getElementById('projects-grid');
            const filterBtns = document.querySelectorAll('.filter-btn');
            const projectDetailModal = document.getElementById('project-detail-modal');
            const closeProjectDetailBtn = document.querySelector('.close-project-detail');
            const projectDetailTitle = document.getElementById('project-detail-title');
            const projectDetailImage = document.getElementById('project-detail-image');
            const projectDetailDescription = document.getElementById('project-detail-description');
            const projectDetailTime = document.getElementById('project-detail-time');
            const projectDetailChip = document.getElementById('project-detail-chip');
            const projectDetailFeatures = document.getElementById('project-detail-features');
            const projectDetailComponents = document.getElementById('project-detail-components');
            const addToCartFromDetailBtn = document.getElementById('add-to-cart-from-detail');
            const aiSummaryBtn = document.getElementById('ai-summary-btn');
            const aiSummaryContainer = document.getElementById('ai-summary-container');
            const aiSummaryText = document.getElementById('ai-summary-text');
            const simulatorPlaceholderBtn = document.getElementById('simulator-placeholder-btn'); // NEW

            // --- Component Detail Modal Elements ---
            const componentCards = document.querySelectorAll('.component-card');
            const componentDetailModal = document.getElementById('component-detail-modal');
            const detailTitle = document.getElementById('detail-title');
            const detailImg = document.getElementById('detail-img');
            const detailDefinition = document.getElementById('detail-definition');
            const detailSymbol = document.getElementById('detail-symbol');
            const detailCharacteristics = document.getElementById('detail-characteristics');
            const detailApplications = document.getElementById('detail-applications');
            const closeDetailBtn = document.querySelector('#component-detail-modal .close-detail');
            const askTechwhizComponentBtn = document.getElementById('ask-techwhiz-component-btn');
            // NEW Sensor Visualization elements
            const sensorVizArea = document.getElementById('sensor-visualization-area');
            const sensorVizCanvas = document.getElementById('sensor-viz-canvas');
            const sensorDataReadout = document.getElementById('sensor-data-readout');
            let sensorVizInterval = null; // To hold the setInterval reference
            
            // --- Cart Elements ---
            const cartFab = document.getElementById('cart-fab');
            const cartModal = document.getElementById('cart-modal');
            const closeCartBtn = document.getElementById('close-cart-btn');
            const cartModalItemsContainer = document.getElementById('cart-modal-items');
            const cartTotalPriceElement = document.getElementById('cart-total-price');
            const cartCountElement = document.getElementById('cart-count');
            const cartItemCountHeader = document.getElementById('cart-item-count-header');
            const cartCheckoutBtn = document.getElementById('cart-checkout-btn');

            // --- Profile Modal Elements ---
            const profileModal = document.getElementById('profile-modal');
            const closeProfileBtn = document.getElementById('close-profile-btn');
            const profileDisplayName = document.getElementById('profile-display-name');
            const profileEmail = document.getElementById('profile-email');
            const profileUserId = document.getElementById('profile-user-id');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const profileLogoutBtn = document.getElementById('profile-logout-btn');
            const profileConceptsCount = document.getElementById('profile-concepts-count');
            const profileProjectsCount = document.getElementById('profile-projects-count');
            const profileOverallProgressBar = document.getElementById('profile-overall-progress-bar');
            
            // --- Progress Elements ---
            const suggestionsSidebar = document.querySelector('.suggestions-sidebar');
            const dynamicSuggestionsContent = document.getElementById('dynamic-suggestions-content');
            const overallProgressBar = document.getElementById('overall-progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            
            let cart = [];
            let userProgress = {}; // Stores { conceptId: true/false }
            let allConcepts = []; // Array of all concepts from Skill Tree data
            let userId = null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const progressCollectionPath = () => `artifacts/${appId}/users/${userId}/progress`;

            // --- Skill Tree Data Structure ---
            const skillTreeData = {
                id: "root",
                name: "E-TECH Path",
                children: [
                    {
                        id: "level1-basics",
                        name: "Level 1: Electronics Fundamentals",
                        children: [
                            { id: "resistor-basics", name: "Resistor", type: "concept" },
                            { id: "capacitor-basics", name: "Capacitor", type: "concept", parentId: "resistor-basics" },
                            { id: "diode-basics", name: "Diode", type: "concept", parentId: "capacitor-basics" },
                            { id: "project-blinking-led", name: "Project: Blinking LED", type: "project", parentId: "diode-basics" }
                        ]
                    },
                    {
                        id: "level2-microcontrollers",
                        name: "Level 2: MCUs & Logic",
                        parentId: "project-blinking-led",
                        children: [
                            { id: "mcu-arduino-uno", name: "Arduino Uno", type: "concept" },
                            { id: "transistor-basics", name: "Transistor", type: "concept", parentId: "mcu-arduino-uno" },
                            { id: "project-traffic-light", name: "Project: Traffic Light", type: "project", parentId: "transistor-basics" },
                            { id: "mcu-esp32", name: "ESP32 & WiFi", type: "concept", parentId: "project-traffic-light" }
                        ]
                    },
                    {
                         id: "level3-sensing",
                         name: "Level 3: Sensing & IoT",
                         parentId: "mcu-esp32",
                         children: [
                             { id: "sensor-ultrasonic", name: "Ultrasonic Sensor", type: "concept" },
                             { id: "sensor-pir", name: "PIR Motion Sensor", type: "concept" },
                             { id: "project-smart-alarm", name: "Project: Smart Alarm", type: "project", parentId: "sensor-ultrasonic" },
                             { id: "project-smart-alarm-iot", name: "Project: IoT Alarm", type: "project", parentId: "project-smart-alarm" }
                         ]
                    }
                ]
            };
            
            function extractAllConcepts(node) {
                if (node.type === 'concept' || node.type === 'project') {
                    allConcepts.push(node.id);
                }
                if (node.children) {
                    node.children.forEach(extractAllConcepts);
                }
            }
            extractAllConcepts(skillTreeData);
            const totalConcepts = allConcepts.length;
            
            // --- D3.js Skill Tree Rendering ---
            function renderSkillTree(progress) {
                const container = document.getElementById('skill-tree-container');
                container.innerHTML = ''; // Clear previous tree
                
                const width = container.clientWidth;
                const height = 600;
                
                const svg = d3.select("#skill-tree-container").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .style("overflow", "visible")
                    .append("g")
                    .attr("transform", `translate(40, 0)`); // Shift tree right for nodes

                const treeLayout = d3.tree()
                    .size([height, width - 160]); // Size of the drawing area

                // Define links based on parentId for non-nested children
                function restructureData(data) {
                    const nodesMap = new Map();
                    const process = (node) => {
                        nodesMap.set(node.id, node);
                        if (node.children) {
                            node.children.forEach(process);
                        }
                    };
                    process(data);

                    // Manually assign children based on parentId fields
                    const rootNode = nodesMap.get("root");
                    const level1 = rootNode.children[0];
                    const level2 = rootNode.children[1];
                    const level3 = rootNode.children[2];
                    
                    // Clear default hierarchy structure for flat/linear linking
                    rootNode.children = [level1, level2, level3]; 

                    // Define sequential links within levels
                    level1.children[0].children = [level1.children[1]]; // Resistor -> Capacitor
                    level1.children[1].children = [level1.children[2]]; // Capacitor -> Diode
                    level1.children[2].children = [level1.children[3]]; // Diode -> Blinking LED

                    level2.children[0].children = [level2.children[1]]; // Arduino Uno -> Transistor
                    level2.children[1].children = [level2.children[2]]; // Transistor -> Traffic Light
                    level2.children[2].children = [level2.children[3]]; // Traffic Light -> ESP32

                    level3.children[0].children = [level3.children[2]]; // Ultrasonic -> Smart Alarm
                    level3.children[1].children = []; // PIR is a parallel path
                    level3.children[2].children = [level3.children[3]]; // Smart Alarm -> IoT Alarm
                    
                    // Link between levels
                    level1.children[3].children = [level2]; // Blinking LED -> Level 2
                    level2.children[3].children = [level3]; // ESP32 -> Level 3

                    return d3.hierarchy(rootNode);
                }

                const root = restructureData(JSON.parse(JSON.stringify(skillTreeData))); // Deep clone for modification
                
                // Set custom node depths for better horizontal flow
                root.each(d => {
                    if (d.data.id.includes('level1')) d.depth = 1;
                    else if (d.data.id.includes('level2')) d.depth = 2;
                    else if (d.data.id.includes('level3')) d.depth = 3;
                    else if (d.data.parentId) {
                        d.depth = nodesMap.get(d.data.parentId).depth + 1;
                    }
                });

                treeLayout(root);

                const nodesMap = new Map(root.descendants().map(d => [d.data.id, d]));

                // 1. Draw Links
                const link = svg.selectAll(".link")
                    .data(root.links())
                    .enter().append("path")
                    .attr("class", d => `link ${progress[d.target.data.parentId] ? 'completed' : ''}`)
                    .attr("d", d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                    );

                // 2. Draw Nodes
                const node = svg.selectAll(".node")
                    .data(root.descendants())
                    .enter().append("g")
                    .attr("class", d => `node ${d.children ? 'internal' : 'leaf'} ${progress[d.data.id] ? 'completed' : ''}`)
                    .attr("transform", d => `translate(${d.y},${d.x})`);

                // Add circles
                node.append("circle")
                    .attr("r", d => d.data.id === 'root' ? 0 : (d.children ? 6 : 10))
                    .attr("stroke-width", d => d.data.id === 'root' ? 0 : 3)
                    .on("click", (event, d) => {
                        if (d.data.type === 'concept' || d.data.type === 'project') {
                             handleConceptClick(d.data.id, progress);
                        }
                    })
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr('r', d.children ? 8 : 12).style("fill", varFromTailwind('--accent'));
                        showToast(d.data.name + (progress[d.data.id] ? ' (Completed)' : ' (Pending)'), 'secondary');
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this).attr('r', d.children ? 6 : 10).style("fill", progress[d.data.id] ? varFromTailwind('--secondary') : '#555');
                    });

                // Add text labels
                node.append("text")
                    .attr("dy", d => d.children ? 20 : 15)
                    .attr("text-anchor", "middle")
                    .text(d => d.data.name)
                    .style("fill", varFromTailwind('--text-light'));
                    
                // Add icons for completed nodes
                node.filter(d => progress[d.data.id] && (d.data.type === 'concept' || d.data.type === 'project'))
                    .append("text")
                    .attr("dy", 4)
                    .attr("text-anchor", "middle")
                    .attr("class", "fas text-lg")
                    .style("font-family", "FontAwesome")
                    .style("fill", varFromTailwind('--primary'))
                    .text('\uf058'); // Checkmark icon
            }

            function handleConceptClick(conceptId, progress) {
                 if (userId) {
                    if (progress[conceptId]) {
                        showToast(`${conceptId} already completed!`, 'secondary');
                    } else {
                        // Check dependencies (simplified mock check)
                        let isDependencyComplete = true;
                        if (conceptId === 'capacitor-basics' && !progress['resistor-basics']) isDependencyComplete = false;
                        if (conceptId === 'diode-basics' && !progress['capacitor-basics']) isDependencyComplete = false;
                        // Add more explicit dependency checks here if necessary
                        
                        if (isDependencyComplete) {
                            toggleConceptCompletion(conceptId, true);
                        } else {
                             showToast(`Must complete prerequisite before starting ${conceptId}.`, 'accent');
                        }
                    }
                } else {
                    showToast("Please log in to track your progress.", 'accent');
                }
            }
            
            // --- Progress Tracking (Firestore) ---
            
            async function toggleConceptCompletion(conceptId, isComplete) {
                if (!userId) return;
                const docRef = db.collection(progressCollectionPath()).doc(conceptId);

                try {
                    await docRef.set({ completed: isComplete, timestamp: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    showToast(`${conceptId} marked as ${isComplete ? 'completed' : 'incomplete'}.`, isComplete ? 'secondary' : 'accent');
                } catch (error) {
                    console.error("Error writing progress: ", error);
                    showToast("Failed to update progress.", 'accent');
                }
            }

            function updateLearningProgress(progressData) {
                userProgress = progressData;
                const completedCount = Object.keys(progressData).length;
                const percentage = totalConcepts > 0 ? Math.round((completedCount / totalConcepts) * 100) : 0;
                
                // Update Sidebar
                progressPercentage.textContent = `${percentage}%`;
                overallProgressBar.style.width = `${percentage}%`;
                
                // Update Profile Modal
                profileConceptsCount.textContent = `${completedCount} / ${totalConcepts}`;
                profileProjectsCount.textContent = completedCount; // Simplified: all completed are counted
                profileOverallProgressBar.style.width = `${percentage}%`;
                
                // Update Skill Tree
                renderSkillTree(progressData);
                
                // Generate Dynamic Suggestions
                generateDynamicSuggestions(progressData);
                
                // Update Component Card borders
                document.querySelectorAll('.component-card').forEach(card => {
                    const conceptId = card.dataset.conceptId;
                    card.classList.remove('border-green-500', 'border-accent');
                    if (progressData[conceptId]) {
                        card.classList.add('border-green-500', 'ring-2', 'ring-green-500');
                    } else {
                        card.classList.remove('ring-2', 'ring-green-500');
                    }
                });
            }
            
            function generateDynamicSuggestions(progressData) {
                dynamicSuggestionsContent.innerHTML = '';
                const completedIds = Object.keys(progressData);
                
                // 1. Identify Next Sequential Concept
                let nextSuggestion = null;
                const findNext = (node) => {
                    if (node.type === 'concept' || node.type === 'project') {
                        if (!progressData[node.id]) {
                            // Simple dependency check: does it have an immediate parent?
                            if (!node.parentId || progressData[node.parentId]) {
                                nextSuggestion = node.id;
                                return true; // Found the next item
                            }
                        }
                    }
                    if (node.children) {
                        for (const child of node.children) {
                            if (findNext(child)) return true;
                        }
                    }
                    return false;
                };
                
                // We need a structured way to traverse and find the next sequential task
                // Since the skillTreeData is complex, we'll traverse a simplified linear list
                for (const conceptId of allConcepts) {
                    if (!progressData[conceptId]) {
                         // Find the data object for the current concept
                         let conceptObj = null;
                         function findObj(node) {
                              if (node.id === conceptId) return node;
                              if (node.children) {
                                  for (const child of node.children) {
                                      const found = findObj(child);
                                      if (found) return found;
                                  }
                              }
                              return null;
                         }
                         conceptObj = findObj(skillTreeData);
                         
                         let isReady = true;
                         // Simplified check: only proceed if the concept has no explicit parentId 
                         // or if the parent is completed.
                         if (conceptObj && conceptObj.parentId && !progressData[conceptObj.parentId]) {
                             isReady = false;
                         }
                         
                         if (isReady) {
                             nextSuggestion = conceptId;
                             break;
                         }
                    }
                }

                if (nextSuggestion) {
                    const [type, name] = nextSuggestion.split('-');
                    const icon = type === 'project' ? 'fas fa-rocket' : 'fas fa-book-open';
                    dynamicSuggestionsContent.innerHTML = `
                        <h5 class="text-sm font-bold text-white mb-2">Continue Your Path:</h5>
                        <a href="#basics">
                             <li class="p-2 glassmorphism rounded-md cursor-pointer hover:bg-accent/20 border-l-4 border-accent" data-concept-id="${nextSuggestion}">
                                <i class="${icon} mr-2 text-accent"></i> 
                                ${name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}
                            </li>
                        </a>
                    `;
                } else if (completedIds.length === totalConcepts) {
                    dynamicSuggestionsContent.innerHTML = `
                         <p class="text-center text-green-500 py-4"><i class="fas fa-check-circle mr-2"></i> All basic concepts mastered! Start an Advanced Course!</p>
                    `;
                } else {
                    dynamicSuggestionsContent.innerHTML = `
                         <p class="text-xs text-gray-400 mb-2">No direct path found. Check the Skill Tree in the Basics section.</p>
                    `;
                }
            }
            
            // --- Component Completion Mock Button ---
            document.querySelectorAll('.component-card').forEach(card => {
                card.addEventListener('dblclick', () => {
                    if (userId) {
                        const conceptId = card.dataset.conceptId;
                        const isCompleted = userProgress[conceptId] === true;
                        toggleConceptCompletion(conceptId, !isCompleted);
                    } else {
                        showToast("Please log in to track your progress.", 'accent');
                    }
                });
            });

            // --- Real-time Firestore Progress Listener ---
            function setupProgressListener(currentUserId) {
                if (window.unsubscribeProgress) {
                    window.unsubscribeProgress(); // Unsubscribe from previous user's listener
                }
                
                if (!currentUserId) {
                    updateLearningProgress({}); // Clear progress if logged out
                    return;
                }
                
                const q = db.collection(progressCollectionPath());
                
                // Listen for changes
                window.unsubscribeProgress = q.onSnapshot(snapshot => {
                    const progressData = {};
                    snapshot.forEach(doc => {
                        if (doc.data().completed) {
                            progressData[doc.id] = true;
                        }
                    });
                    updateLearningProgress(progressData);
                }, error => {
                    console.error("Firestore Progress Listener Error:", error);
                    showToast("Error loading learning progress.", 'accent');
                });
            }


            // --- Sensor Visualization Mock Logic ---
            const sensorData = {
                ultrasonic: { unit: 'cm', min: 2, max: 200, value: 50, update: 100 },
            };

            function startSensorVisualization(type) {
                if (sensorVizInterval) clearInterval(sensorVizInterval);

                const data = sensorData[type];
                if (!data) return;

                const ctx = sensorVizCanvas.getContext('2d');
                let width = sensorVizCanvas.width = sensorVizCanvas.clientWidth;
                let height = sensorVizCanvas.height = sensorVizCanvas.clientHeight;
                
                // Gauge drawing function
                const drawGauge = () => {
                    ctx.clearRect(0, 0, width, height);

                    const centerX = width / 2;
                    const centerY = height; // Draw from the bottom
                    const radius = height * 0.9;
                    const startAngle = Math.PI; // 180 degrees
                    const endAngle = 2 * Math.PI; // 360 degrees

                    // Scale the value to the angle range (180 to 360 degrees)
                    const range = data.max - data.min;
                    const angleRatio = (data.value - data.min) / range;
                    const needleAngle = startAngle + (endAngle - startAngle) * angleRatio;
                    
                    // Background Arc
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = varFromTailwind('--border-color');
                    ctx.stroke();

                    // Fill Arc (Progress)
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, startAngle, needleAngle, false);
                    ctx.lineWidth = 20;
                    ctx.strokeStyle = varFromTailwind('--secondary');
                    ctx.stroke();

                    // Needle
                    ctx.beginPath();
                    ctx.strokeStyle = varFromTailwind('--accent');
                    ctx.lineWidth = 3;
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(
                        centerX + radius * Math.cos(needleAngle),
                        centerY + radius * Math.sin(needleAngle)
                    );
                    ctx.stroke();
                    
                    // Center Dot
                    ctx.fillStyle = varFromTailwind('--accent');
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // Text Readout
                    ctx.fillStyle = varFromTailwind('--text-light');
                    ctx.font = '24px Orbitron';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${data.value}${data.unit}`, centerX, centerY - radius / 3);
                };
                
                // Mock data generation loop
                sensorVizInterval = setInterval(() => {
                    // Simulate random fluctuation
                    const delta = (Math.random() * 20) - 10;
                    let newValue = data.value + delta;
                    
                    // Clamp value within min/max
                    if (newValue < data.min) newValue = data.min;
                    if (newValue > data.max) newValue = data.max;

                    data.value = Math.round(newValue);
                    sensorDataReadout.textContent = `Reading: ${data.value} ${data.unit} (Mock Data)`;
                    drawGauge();
                }, data.update);

                // Initial draw and resize handler
                drawGauge();
                window.addEventListener('resize', () => {
                    width = sensorVizCanvas.width = sensorVizCanvas.clientWidth;
                    height = sensorVizCanvas.height = sensorVizCanvas.clientHeight;
                    drawGauge();
                });
            }

            function stopSensorVisualization() {
                if (sensorVizInterval) {
                    clearInterval(sensorVizInterval);
                    sensorVizInterval = null;
                }
                sensorVizArea.classList.add('hidden');
                sensorDataReadout.textContent = 'Status: Idle';
            }
            
            // Helper function to get Tailwind colors
            function varFromTailwind(varName) {
                return getComputedStyle(document.documentElement).getPropertyValue(varName) || '#ffffff';
            }


            // --- Consolidated Project Data (From index.html) ---
            // (Keeping this section brief for file size, actual data remains the same)
            const projects = { /* ... project data ... */ };
            // (Re-creating a minimal project data structure to avoid huge file size)
            const projectsList = [
              { id: 'iot1', name: 'Smart Home Automation', description: 'Control lights, fans, and appliances remotely using ESP32 and Blynk app.', image: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80', price: 1, time: '4 hours', chip: 'ESP32', features: ['Remote control via app', 'Scheduler functions', 'Voice command integration'], components: ['ESP32', 'Relay module', 'Blynk app'], },
                    { id: 'iot2', name: 'Weather Monitoring Station', description: 'Real-time weather data collection with cloud dashboard visualization.', image: 'https://images.unsplash.com/photo-1603732551681-2e91159b9dc2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80', price: 499, time: '6 hours', chip: 'NodeMCU', features: ['Measures temperature, humidity, pressure', 'Uploads data to a cloud platform (e.g., ThingSpeak)', 'Real-time dashboard'], components: ['NodeMCU ESP8266', 'DHT11 or BME280 sensor', 'Jumper wires'] },
                { id: 'iot3', name: 'Smart Plant Monitoring', description: 'Automated plant care system with soil moisture and light sensors.', image: 'https://lh3.googleusercontent.com/pw/AP1GczMz4IzRgBdfg8mYYH_kaqB8PP5ULbi4FEa8OB5HQQNlpGXKoZRaAqxtNi6GcMMcH60GImYAtDT_EuaqN9P-XowHtrXO9c6dyx3dAl5VLqENPLFJbE0=w2400', price: 399, time: '3 hours', chip: 'Arduino IoT', features: ['Measures soil moisture and light level', 'Sends alerts for low moisture', 'Can trigger automatic watering'], components: ['Arduino MKR IoT Carrier', 'Moisture sensor', 'LDR sensor', 'Water pump'] },
                    { id: 'iot4', name: 'Smart Door Lock', description: 'Biometric and RFID-based door lock system with remote access.', image: 'https://lh3.googleusercontent.com/pw/AP1GczOhh4amBa25ZdPCNwOYKvKm5qWbsM6qBiCmcb7XwWNMRG5PnFdmQpFxzWbOZj1WrZnyVdfvnPB47MI2PQ_DNInLqnU3YoxCsjMpXMcFB6hWsw2EAns=w2400', price: 799, time: '5 hours', chip: 'Raspberry Pi', features: ['Fingerprint or RFID unlock', 'Remote unlock via web interface', 'Logs access history'], components: ['Raspberry Pi', 'Fingerprint sensor', 'RFID reader', 'Servo motor'] },
                    { id: 'iot5', name: 'Water Quality Monitor', description: 'Real-time monitoring of pH, turbidity, and temperature in water sources.', image: 'https://lh3.googleusercontent.com/pw/AP1GczO3wUaCNA1YtgMGIXYfHBkPdXIqv-Nhm_jU-060QjUuy9Q1U75Pa6ci1l1qujYxvj_5dAwSEQIrYGh0twldk6RmtX1i6ukHGfvpzaYh1UnLwHCroOo=w2400', price: 699, time: '7 hours', chip: 'ESP32', features: ['Measures multiple parameters (pH, temp, turbidity)', 'Online data visualization', 'Alerts for unsafe levels'], components: ['ESP32', 'pH sensor', 'Turbidity sensor', 'Temperature sensor', 'Wi-Fi module'] },
                    { id: 'iot6', name: 'Air Quality Monitor', description: 'Monitor indoor air quality (CO2, VOCs) and get alerts on your phone.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNbPQTQpT-v2jgjYClkeiZbiBTJZdj9C8GSxR4JKjcYtIoLntk4OTlkuY39GH7MzpBM92nbBuJBxH-V8BhK6MVjxHlTgH2aLS68CWZuewDJ-M_3TbYW=w2400', price: 549, time: '4 hours', chip: 'ESP8266', features: ['Measures CO2 and particulate matter', 'Mobile alerts via push notification', 'Historical data logging'], components: ['ESP8266 NodeMCU', 'MQ-135 Air Quality Sensor', 'Blynk/ThingSpeak'] },
                    { id: 'iot7', name: 'Smart Garage Door', description: 'Open and close your garage door securely with your smartphone.', image: 'https://lh3.googleusercontent.com/pw/AP1GczOtE0jiqG8uxzVojjNKXzjtlpdcaaknl9za2lbpf-2tgenIcjpo6HUgt1HFOV6b4h_iMUdNUJcsmVRoXDuYRvwHkGIn7ulNzU2W8HjPPzce7RZVnuvt=w2400', price: 429, time: '3 hours', chip: 'ESP32', features: ['Remote control via smartphone', 'Real-time status monitoring', 'Security logging'], components: ['ESP32', 'Relay module', 'Magnetic contact sensor'] },
                    { id: 'iot8', name: 'Smart Parking System', description: 'Detect available parking spots and display the status on a web app.', image: 'https://lh3.googleusercontent.com/pw/AP1GczMcTyJEqQieDRarrMtJGIokVaOjlcdPVM2UGRyXPkAHdyAkOXaJob1KD0mZLBStte4k-fHF-UPDdvjANIljeMYkz9IcXmyG-h8aH2AaPtxz01erYZaM=w2400', price: 899, time: '9 hours', chip: 'ESP32', features: ['Uses ultrasonic sensors to detect cars', 'Web-based status map', 'Real-time occupancy calculation'], components: ['ESP32', 'Ultrasonic sensors (multiple)', 'Web server platform'] },
                    { id: 'iot9', name: 'Water Leak Detector', description: 'Get instant alerts on detecting water leaks to prevent property damage.', image: 'https://lh3.googleusercontent.com/pw/AP1GczMwJuf2Gao8XnNIbQPNniX9ui2aL2jrN7VkK3lKp5025JjUy2qDSGiWV_2BH5dppduINUbedELTBpleqsaqrFU9st2VebPl110pvFLGSm5DgQA_lxty=w2400', price: 299, time: '2 hours', chip: 'ESP8266', features: ['Instant email/app alerts', 'Simple sensor interface', 'Battery-powered operation'], components: ['ESP8266 NodeMCU', 'Water level sensor', 'Buzzer'] },
                    { id: 'iot10', name: 'Automated Window Blinds', description: 'Control your window blinds based on time of day or with a mobile app.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNLgUMAQiX0-78WGyUGErON8hhEYXGtIkOXhzH9eotPT3fA08VX6J2M1qbYJgtBvsFLD_v7Btrx0qFxAa1o0WW5aNmV8E8Q-g8phTF65_SjVp59FqRZ=w2400', price: 599, time: '5 hours', chip: 'ESP32', features: ['Scheduled automation', 'Manual control via app', 'Sunlight tracking option'], components: ['ESP32', 'Stepper motor/Servo', 'Motor driver', 'LDR (optional)'] },
                    { id: 'iot11', name: 'Smart Trash Can', description: 'A trash can that reports when it\'s full to optimize collection routes.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNTNQoCfHLWX08xLsqZeQuVo99HtEqhR8zu5htwDjzXjwCbcYi6J03MHm70VQLFEgsdkl7yjd7QyVKUdyq6Ik5r_O2moA1MrcCk43ELanukSAl1I8Kp=w2400', price: 449, time: '4 hours', chip: 'Arduino Uno & ESP8266', features: ['Ultrasonic sensing for fill level', 'Remote status reporting', 'Web interface visualization'], components: ['Arduino Uno', 'ESP8266 (for WiFi)', 'Ultrasonic sensor'] },
                    { id: 'iot12', name: 'Gas Leakage Detector', description: 'Detects flammable gases and sends an alert to your phone via SMS.', image: 'https://lh3.googleusercontent.com/pw/AP1GczOZc5U7gYfBqpvVESXFTTUDR-Qpbm_9AcRCEjSQ6DteyU2EjHfmmcyDsd68szD9PWMGdGpnCrd0dhUzR3EQBrT73UCfkb2xwSrHQWxvZWH3xqDWBZ29=w2400', price: 599, time: '3 hours', chip: 'NodeMCU & GSM Module', features: ['High-sensitivity gas detection', 'Instant SMS alerts to multiple users', 'Audible alarm'], components: ['NodeMCU', 'MQ-2 Gas Sensor', 'SIM800L GSM Module'] },
                    { id: 'iot13', name: 'Smart Pill Dispenser', description: 'An automated pill dispenser that reminds and provides medication on schedule.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNItSPWo_al2EEtsxrCDpIu5Vff597duvTuTWL5ZeJ2Z7gbnqEEQAewh7A2XNHDsYP3Hz3BzxaMF2FdIkYxl7PfkTQjv25LkujUP061XYW4B8YaDbiJ=w2400', price: 999, time: '7 hours', chip: 'ESP32', features: ['Programmable scheduling', 'Mobile app reminders', 'Dispenses medication accurately'], components: ['ESP32', 'Servo motors', 'RTC module', 'Custom 3D printed parts (optional)'] },
                    { id: 'iot14', name: 'Community Noise Monitor', description: 'Monitor noise levels in your neighborhood and visualize the data online.', image: 'https://lh3.googleusercontent.com/pw/AP1GczP5oLCjmMnMsBxC45jafW_zGbEAMQITQzJ68Q3YmLPXD8_8v_UnTaapyL7_yUkQuKMDBBPV1dh7FJLWx_Gj84SQ_E7GB1910BoQDAogQeCwb99jxyrX=w2400', price: 379, time: '3 hours', chip: 'NodeMCU', features: ['Measures Decibel (dB) levels', 'Time-series data plotting online', 'Alerts for excessive noise'], components: ['NodeMCU ESP8266', 'Sound sensor module', 'Cloud platform (e.g., Ubidots)'] },
                    { id: 'iot15', name: 'Automated Attendance System', description: 'Use RFID or fingerprint scanning to take attendance and store it in the cloud.', image: 'https://lh3.googleusercontent.com/pw/AP1GczPGKK9Ou3S5cZQ3MLtrlNpi1evu_A1UJvCS-R281bBkWlSVX9r3LLtJqci9seEJp4jjfS0O2kkh641xM7m46g-uV91kZkGjYpd5y2DdohOgvVIJyvX1=w2400', price: 849, time: '5 hours', chip: 'ESP32', features: ['Biometric/RFID authentication', 'Cloud database logging', 'Web interface for admin review'], components: ['ESP32', 'RFID or Fingerprint sensor', 'External database (e.g., Firebase)'] },
                    { id: 'iot16', name: 'Smart Energy Monitor', description: 'Track home energy consumption in real-time with cloud analytics.', image: 'https://lh3.googleusercontent.com/pw/AP1GczMQHImgAVpKLMrB0HgqxOyOCvCf3DRh7QoOSD1hEC37tibujuitBjZahY_vpqnPxLHD-1mOlUYT7RMivEPoCqNJGa3e6j83uvvR6FDcV4oPcgCtHuI=w2400', price: 699, time: '6 hours', chip: 'ESP8266', features: ['Real-time current/voltage measurement', 'Energy cost estimation', 'Historical data trends'], components: ['ESP8266 NodeMCU', 'Current transformer sensor (CT)', 'Voltage sensor module'] },
               { id: 'ard1', name: 'RFID Door Lock', description: 'Secure door lock system using RFID cards for authentication.', image: 'https://lh3.googleusercontent.com/pw/AP1GczOgMwMLSmyMPWQu2UZt3_P60dSVM3eOyRvzt2lEAzMmy1lC0lIWxdcYl1C05WNAHIcxcr9EDiAzzNf0oz9ln5lZOAxKH-U6nyC5d48CCfqgpk9PEEY=w2400', price: 299, time: '3 hours', chip: 'Arduino Uno', features: ['Card-based access control', 'Simple programming', 'Uses a servo motor for locking mechanism'], components: ['Arduino Uno', 'RC522 RFID reader', 'Servo motor', 'Breadboard'] },
                    { id: 'ard2', name: 'Bluetooth Controlled Car', description: 'Smartphone-controlled car using Bluetooth module.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNotsOrKUzeRAeXLL4dPEe2y8cdeQGi21-fHEUdQX39zdsfOfbPa22rNrGyNASSRxYibDHVE9GzGXLfPB7Lb-ECgOCt9naJjY1JlmUJJcAa0--wmnAn=w2400', price: 349, time: '4 hours', chip: 'Arduino Nano', features: ['App-based control (forward, backward, turn)', 'Easy to assemble chassis', 'Fun to build and play with'], components: ['Arduino Nano', 'HC-05 Bluetooth module', 'L298N motor driver', 'DC motors', 'Wheels', 'Chassis'] },
                    { id: 'ard3', name: 'Ultrasonic Radar System', description: 'Object detection system with servo-mounted ultrasonic sensor.', image: 'https://lh3.googleusercontent.com/pw/AP1GczNnRLm4YRZDNsHd66bzXpC4uyAxseClnEnp0xJO84xtn9hGqYOpnfvjVo5aqP3q21N4p7PZBrA00-tcL_TgqUV06eKT6huAmjoGDPsWDRJieAKxPAzg=w2400', price: 279, time: '4 hours', chip: 'Arduino Uno', features: ['Visual representation on PC screen', 'Detects objects in a 180-degree range', 'Uses ultrasonic sound waves for detection'], components: ['Arduino Uno', 'HC-SR04 ultrasonic sensor', 'Servo motor', 'Processing IDE'] },
                    { id: 'ard4', name: 'Home Security Alarm', description: 'Intrusion detection with PIR sensors and GSM alerts.', image: 'https://lh3.googleusercontent.com/pw/AP1GczPH1Ylq_UUsh0zo3Q_TWf7DuBNaJqbC0J0ftpRFfTjeCkmZC-dGyPaLrMnWnkTCwRnPa1j4Is_hX87ayGLNs0IU8yTkZ1CIruZyM_lvdGgrwiLfPyVQ=w2400', price: 499, time: '5 hours', chip: 'Arduino + SIM800L', features: ['Motion detection', 'Instant SMS alerts', 'Alarm sound trigger'], components: ['Arduino Uno', 'PIR sensor', 'SIM800L GSM module', 'Buzzer'] },
                    { id: 'ard5', name: 'Digital Voltmeter', description: 'Measure voltage from 0-30V with LCD display.', image: 'https://lh3.googleusercontent.com/pw/AP1GczMfS-R0cFMewGT9E48md13C2dcCzGlTDWkOf0PBUcWx79EqnSTlUObUIUuC6_-e-HGKyI39jcEBm1MKFhDwsmMsqt4im25pimcQL_LEZzNKhivM-l1q=w2400', price: 199, time: '2 hours', chip: 'Arduino Uno', features: ['Measures DC voltage accurately', 'LCD display for readings', 'Simple calibration process'], components: ['Arduino Uno', 'LCD 16x2 Display', 'Voltage divider circuit'] },
                    { id: 'ard6', name: 'Smart Traffic Light', description: 'Automated traffic light system with pedestrian crossing.', image: 'https://lh3.googleusercontent.com/pw/AP1GczO1gYL2YZaBq7v10UyxYe_PQLhEZ7z4Op3Xvf3vcy3vWRDvwwTsMprOK3emK5mE11CAygK9xA5v4Dblh-sQcGM7MExIwRYonYz6qiw6pUBrJ_IudGlo=w2400', price: 189, time: '3 hours', chip: 'Arduino Uno', features: ['Customizable timing sequence', 'Pedestrian request button', 'Clear LED indicators'], components: ['Arduino Uno', 'RGB LEDs or separate colored LEDs', 'Push button'] },
                    { id: 'ard7', name: 'Voice Controlled Appliances', description: 'Control room lights using voice commands via Bluetooth.', image: 'https://lh3.googleusercontent.com/pw/AP1GczOH-zP6-T444_fQvGh8IL5InzAb0kuCtiost4BKcLdSdbGUjFAKkn_wzY3nLPrbpQcrgYqTL-EggP8SoDed0mMfwbEiibAj6ItXXF9_1x0NFgDW_pV8=w2400', price: 369, time: '3.5 hours', chip: 'Arduino + HC-05', features: ['Voice command processing on smartphone app', 'Controls up to 4 appliances', 'Uses Bluetooth for communication'], components: ['Arduino Uno', 'HC-05 Bluetooth module', '4-channel Relay module'] },
                    { id: 'ard8', name: 'Laser Security System', description: 'Create a laser tripwire security system with buzzer alarm.', image: 'https://lh3.googleusercontent.com/pw/AP1GczO9QWf-BNMVt8nPeSMNbHWXYSwD2Ong80c4rMxPsxwFV46v82rY91uzs3oxELaMqyDpX7EPaf1ijCmiRedxJ8ZpFqvO13EAEEoPyYwrH6-0MVHiwDon=w2400', price: 179, time: '2 hours', chip: 'Arduino Uno', features: ['Tripwire alarm logic', 'Audible buzzer alert', 'Adjustable sensitivity'], components: ['Arduino Uno', 'Laser Module', 'LDR sensor', 'Buzzer'] },
                    { id: 'ard9', name: 'Obstacle Avoiding Robot', description: 'Build an autonomous vehicle that navigates around obstacles.', image: 'https://lh3.googleusercontent.com/pw/AP1GczPL836iWZCL6eReOPTAlj9IdrxBu7SsEbe_w_311P0GlHRgYGIddd6gVGOJ0_AGaEqLdX8lKtS4oSX_NCm6Lp74e22-hB16Ke7-vvmcDBGrd0zdkI8=w2400', price: 449, time: '5 hours', chip: 'Arduino Nano', features: ['Autonomous navigation', 'Uses ultrasonic sensor for obstacle detection', 'Simple mechanical chassis'], components: ['Arduino Nano', 'HC-SR04 Ultrasonic sensor', 'L298N motor driver', 'DC motors', 'Chassis'] },
                    { id: 'ard10', name: 'GPS Tracker', description: 'Location tracking device with data logging to SD card.', image: 'https://images.unsplash.com/photo-1581091226033-d5c48150dbaa?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80', price: 549, time: '4 hours', chip: 'Arduino Mega', features: ['Real-time latitude/longitude data', 'Data logged to SD card for later analysis', 'High accuracy GPS module'], components: ['Arduino Mega', 'GPS Module (e.g., NEO-6M)', 'SD Card module', 'Battery'] },
                { id: 'cse1', name: 'Online Book Store', description: 'A web-based bookstore with user authentication and payment integration.', image: 'https://placehold.co/400x300/1e3a8a/ffffff?text=Web+Store', price: 1499, time: '20 hours', chip: 'Web Development', features: ['User registration and login', 'Book catalog with search filters', 'Shopping cart functionality', 'Secure payment gateway'], components: ['HTML, CSS, JS', 'React or Node.js backend', 'Database (e.g., Firebase, MongoDB)'] },
                    { id: 'cse2', name: 'Image Recognition App', description: 'A Python-based app that identifies objects in an image using a pre-trained model.', image: 'https://placehold.co/400x300/065f46/ffffff?text=AI+Recognition', price: 999, time: '15 hours', chip: 'Machine Learning', features: ['Upload and analyze images', 'Provides a list of recognized objects and confidence scores', 'Simple and intuitive UI'], components: ['Python', 'TensorFlow or PyTorch', 'Flask for web interface'] },
                    { id: 'cse3', name: 'Real-time Chat Application', description: 'A multi-user chat application with real-time messaging and user presence.', image: 'https://placehold.co/400x300/4a044e/ffffff?text=Realtime+Chat', price: 1199, time: '18 hours', chip: 'WebSockets', features: ['Instant messaging', 'User online/offline status', 'Message history', 'User authentication'], components: ['Node.js', 'Express.js', 'Socket.io', 'HTML/CSS/JS'] },
                   
            ];
            
            function renderProjects(filter = 'all') {
                projectsGrid.innerHTML = '';
                const allProjects = projectsList;
                let filteredProjects;
                if (filter === 'iot') {
                    filteredProjects = allProjects.filter(p => p.chip.includes('ESP') || p.chip.includes('NodeMCU'));
                } else if (filter === 'arduino') {
                    filteredProjects = allProjects.filter(p => p.chip.includes('Arduino'));
                } else if (filter === 'cse') {
                    filteredProjects = allProjects.filter(p => p.chip.includes('Web Development') || p.chip.includes('Machine Learning') || p.chip.includes('WebSockets'));
                } else {
                    filteredProjects = allProjects;
                }

                filteredProjects.forEach(p => {
                    const projectType = p.chip.toLowerCase().includes('web') || p.chip.toLowerCase().includes('learning') || p.chip.toLowerCase().includes('python') || p.chip.toLowerCase().includes('javascript') ? 'cse' : (p.chip.toLowerCase().includes('esp') || p.chip.toLowerCase().includes('nodemcu') ? 'iot' : 'arduino');
                    
                    const tagClass = projectType === 'iot' ? 'bg-secondary' : (projectType === 'arduino' ? 'bg-accent' : 'bg-green-500');
                    const tagText = projectType === 'iot' ? 'IoT' : (projectType === 'arduino' ? 'Arduino' : 'CSE');

                    // NOTE: Project card must contain the project ID to track completion (mock project IDs used for simplicity)
                    const conceptId = projectType === 'iot' ? 'project-smart-alarm-iot' : (projectType === 'arduino' ? 'project-traffic-light' : 'project-cse-mock');
                    const completedClass = userProgress[conceptId] ? 'border-green-500 ring-2 ring-green-500' : 'border-secondary/50';

                    projectsGrid.innerHTML += `
                        <div class="project-card card-3d glassmorphism p-6 rounded-lg overflow-hidden neon-border cursor-pointer relative ${completedClass}" 
                             data-project-type="${projectType}" 
                             data-id="${p.id}" 
                             data-price="${p.price}" 
                             data-name="${p.name}" 
                             data-image="${p.image}"
                             data-description="${p.description}"
                             data-time="${p.time}"
                             data-chip="${p.chip}"
                             data-concept-id="${conceptId}"
                             data-features='${JSON.stringify(p.features)}'
                             data-components-list='${JSON.stringify(p.components)}'>
                            <div class="absolute top-3 right-3 ${tagClass} text-white text-xs font-bold px-3 py-1 rounded-lg z-10">${tagText}</div>
                            <img src="${p.image}" alt="${p.name}" class="rounded-lg w-full h-48 object-cover transition-transform duration-500 hover:scale-110">
                            <div class="mt-4">
                                <h3 class="font-orbitron text-2xl font-bold text-white">${p.name}</h3>
                                <p class="text-gray-400 mt-2">${p.description}</p>
                                <div class="text-2xl font-bold font-orbitron text-accent mt-4">₹${p.price}</div>
                                <button class="add-to-cart-btn btn-3d btn-primary-action btn-box mt-4">Add to Cart</button>
                                
                                <div class="project-meta flex justify-between text-sm text-gray-400 mt-4 border-t border-border-color pt-2">
                                    <span><i class="fas fa-clock text-secondary mr-1"></i> ${p.time}</span>
                                    <span><i class="fas fa-microchip text-secondary mr-1"></i> ${p.chip}</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                document.querySelectorAll('.project-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.classList.contains('add-to-cart-btn')) {
                            return;
                        }
                        const data = card.dataset;
                        
                        // Clear previous content
                        projectDetailFeatures.innerHTML = '';
                        projectDetailComponents.innerHTML = '';

                        projectDetailTitle.textContent = data.name;
                        projectDetailImage.src = data.image;
                        projectDetailDescription.textContent = data.description;
                        projectDetailTime.innerHTML = `<i class="fas fa-clock"></i> ${data.time}`;
                        projectDetailChip.innerHTML = `<i class="fas fa-microchip"></i> ${data.chip}`;
                        
                        // Handle potential JSON parsing errors
                        try {
                            const features = JSON.parse(data.features);
                            projectDetailFeatures.innerHTML = features.map(f => `<li>${f}</li>`).join('');
                            
                            const componentsList = JSON.parse(data.componentsList);
                            projectDetailComponents.innerHTML = componentsList.map(c => `<li>${c}</li>`).join('');
                        } catch (error) {
                            console.error("Error parsing project features/components:", error);
                            projectDetailFeatures.innerHTML = `<li>Data format error.</li>`;
                            projectDetailComponents.innerHTML = `<li>Data format error.</li>`;
                        }
                        
                        addToCartFromDetailBtn.dataset.id = data.id;
                        addToCartFromDetailBtn.dataset.name = data.name;
                        addToCartFromDetailBtn.dataset.price = data.price;
                        addToCartFromDetailBtn.dataset.image = data.image;
                        
                        projectDetailModal.style.display = 'flex';
                    });
                });
                
                document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const card = e.target.closest('.project-card');
                        const price = parseFloat(card.dataset.price);
                        addToCart(card.dataset.id, card.dataset.name, price, card.dataset.image);
                        e.stopPropagation();
                    });
                });
                
                // Re-render KaTeX after injecting new HTML content
                if (window.renderMathInElement) {
                    renderMathInElement(projectsGrid);
                }
            }

            // ... (Rest of the common logic, including cart, checkout, and AI summary remains) ...
            closeProjectDetailBtn.addEventListener('click', () => {
                projectDetailModal.style.display = 'none';
            });
            
            aiSummaryBtn.addEventListener('click', async () => {
                const prompt = `Summarize the following project in one to two concise, engaging sentences. Do not use the project name or explicitly mention 'IoT' or 'Arduino'. Keep the tone professional but accessible:\n\nProject Name: ${projectDetailTitle.textContent}\nDescription: ${projectDetailDescription.textContent}\nFeatures: ${projectDetailFeatures.textContent}`;
                aiSummaryContainer.classList.remove('hidden');
                aiSummaryText.textContent = 'Generating summary...';

                try {
                    const systemInstruction = "Act as a marketing copywriter specializing in technology products. Provide a concise, highly engaging 1-2 sentence summary of the provided project details. Respond exclusively in the language of the user's query.";
                    const summary = await callGeminiApi(prompt, systemInstruction);
                    aiSummaryText.textContent = summary;
                } catch (error) {
                    aiSummaryText.textContent = "Sorry, I couldn't generate a summary right now. Please try again later.";
                }
            });
            
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-secondary', 'hover:bg-accent');
                        b.classList.add('bg-gray-800');
                    });
                    btn.classList.add('active', 'bg-secondary', 'hover:bg-accent');
                    btn.classList.remove('bg-gray-800');
                    const filter = btn.dataset.filter;
                    renderProjects(filter);
                });
            });

            // --- Cart Logic Implementation ---
            async function addToCart(id, name, price, image) {
                // Check Inventory (Mock Firestore check)
                try {
                    const inventoryRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory').doc(id);
                    const doc = await inventoryRef.get();
                    let currentStock = 10; // Default mock stock
                    
                    if (doc.exists) {
                        currentStock = doc.data().stock;
                    } 
                    // To simulate low/zero stock for testing:
                    if (id === 'iot2') { currentStock = 0; } // Mock Sold Out for Weather Station

                    const existingItem = cart.find(item => item.id === id);
                    const quantityInCart = existingItem ? existingItem.quantity : 0;
                    
                    if (quantityInCart >= currentStock && currentStock > 0) {
                         showToast(`${name} is low stock! Max ${currentStock} allowed.`, 'accent');
                         return;
                    }
                    
                    if (currentStock <= 0) {
                         showToast(`${name} is currently Sold Out.`, 'accent');
                         return;
                    }

                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        cart.push({ id, name, price, image, quantity: 1, maxStock: currentStock });
                    }
                    updateCart();
                    showToast(`${name} added to cart!`);

                } catch (error) {
                    console.error("Error checking inventory: ", error);
                    showToast(`Inventory check failed. Adding to cart anyway.`, 'secondary');
                    
                    // Fallback to adding without inventory check
                    const existingItem = cart.find(item => item.id === id);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        cart.push({ id, name, price, image, quantity: 1 });
                    }
                    updateCart();
                }
            }
            
            function changeCartQuantity(id, change) {
                const item = cart.find(item => item.id === id);
                if (item) {
                    const newQuantity = item.quantity + change;
                    
                    if (newQuantity <= 0) {
                        removeFromCart(id);
                        return;
                    }
                    
                    // Check max stock if available
                    if (item.maxStock !== undefined && newQuantity > item.maxStock) {
                        showToast(`Max stock reached for ${item.name}!`, 'accent');
                        return;
                    }
                    
                    item.quantity = newQuantity;
                    updateCart();
                }
            }

            function removeFromCart(id) {
                const itemIndex = cart.findIndex(item => item.id === id);
                if (itemIndex > -1) {
                    cart.splice(itemIndex, 1);
                    showToast(`Item removed from cart.`, 'accent');
                }
                updateCart();
            }

            function updateCart() {
                cartModalItemsContainer.innerHTML = '';
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                
                cartCountElement.textContent = totalItems;
                cartItemCountHeader.textContent = totalItems;

                if (cart.length === 0) {
                    cartModalItemsContainer.innerHTML = '<p class="cart-empty-msg text-gray-400 text-center p-8">Your cart is currently empty. Start exploring projects!</p>';
                    cartCheckoutBtn.disabled = true;
                    cartCheckoutBtn.classList.remove('btn-primary-action', 'hover:bg-secondary'); // Use new classes
                    cartCheckoutBtn.classList.add('bg-gray-700', 'cursor-not-allowed');
                } else {
                    cartCheckoutBtn.disabled = false;
                    cartCheckoutBtn.classList.add('btn-primary-action', 'hover:bg-secondary'); // Use new classes
                    cartCheckoutBtn.classList.remove('bg-gray-700', 'cursor-not-allowed');

                    cart.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.classList.add('cart-modal-item');
                        itemElement.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg mr-4 border border-secondary/50">
                            <div class="flex-1">
                                <h4 class="font-bold text-white">${item.name}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-sm text-gray-400">Qty:</span>
                                    <div class="cart-controls flex items-center">
                                        <button class="qty-minus" data-id="${item.id}" data-change="-1">-</button>
                                        <span class="px-2 text-white">${item.quantity}</span>
                                        <button class="qty-plus" data-id="${item.id}" data-change="1">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-lg font-orbitron text-accent mr-4">₹${(item.price * item.quantity).toFixed(0)}</div>
                            <button class="cart-item-remove text-gray-500 hover:text-accent text-xl transition-colors" data-id="${item.id}">&times;</button>
                        `;
                        itemElement.querySelector('.cart-item-remove').addEventListener('click', (e) => removeFromCart(e.target.dataset.id));
                        itemElement.querySelector('.qty-minus').addEventListener('click', (e) => changeCartQuantity(e.target.dataset.id, -1));
                        itemElement.querySelector('.qty-plus').addEventListener('click', (e) => changeCartQuantity(e.target.dataset.id, 1));
                        cartModalItemsContainer.appendChild(itemElement);
                    });
                }
                const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                cartTotalPriceElement.textContent = `₹${total}`;
            }
            
            function showToast(message, color = 'secondary') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed; 
                    top: 20px; 
                    left: 50%; 
                    transform: translateX(-50%); 
                    background: var(--${color}); 
                    color: white; 
                    padding: 10px 20px; 
                    border-radius: 8px; 
                    z-index: 9999; 
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
                    font-family: 'Orbitron', sans-serif;
                    opacity: 0;
                    transition: opacity 0.5s ease-in-out;
                `;
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = 1; }, 10);
                setTimeout(() => { toast.style.opacity = 0; }, 2500);
                setTimeout(() => toast.remove(), 3000);
            }

            cartFab.addEventListener('click', () => cartModal.classList.toggle('open'));
            closeCartBtn.addEventListener('click', () => cartModal.classList.remove('open'));

            addToCartFromDetailBtn.addEventListener('click', () => {
                const id = addToCartFromDetailBtn.dataset.id;
                const name = addToCartFromDetailBtn.dataset.name;
                const price = parseFloat(addToCartFromDetailBtn.dataset.price);
                const image = addToCartFromDetailBtn.dataset.image;
                addToCart(id, name, price, image);
                projectDetailModal.style.display = 'none';
            });
            
            cartCheckoutBtn.addEventListener('click', () => {
                const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                if (totalAmount === 0) {
                    showToast("Your cart is empty!", 'accent');
                    return;
                }
                if (!auth.currentUser) {
                    showToast("Please login to proceed to checkout.", 'accent');
                    authModal.style.display = 'flex'; // Use flex to match modal-overlay-center
                    return;
                }
                
                // --- RAZORPAY CONFIGURATION FOR AUTOMATIC CAPTURE ---
                // The amount must be passed in Paise (1 INR = 100 Paise).
                // When using this client-side-only initiation method (without an explicit order_id 
                // created from the backend), Razorpay defaults to automatic capture
                // unless your Razorpay account settings force manual capture.
                // If you are experiencing manual capture, the recommended solution
                // is to implement a secure backend API that creates a Razorpay Order
                // with 'capture_method': 'automatic' and passes that order_id to the options below.
                const amountInPaise = totalAmount * 100;
                
                const options = {
                    key: "rzp_live_4cpkH5xviXonf3",
                    amount: amountInPaise, // Amount in paise for automatic capture (e.g., ₹100.00 is 10000)
                    currency: "INR",
                    name: "E-TECH SOLUTIONS",
                    description: "Project Purchase (Auto-Capture Enabled)",
                    image: "https://lh3.googleusercontent.com/pw/AP1GczMFGvwVU32NSsKv5V5pVdolG2i9-eEUBOupJmE6wvE5hKb08fmmPauG62OnGUmD0esm9pa-d285g6XBzAxuULCghMe8Obxi1mUTI3LcaMuGB0IJz-5-=w2400",
                    
                    // The automatic capture happens on the backend when the payment is successful (handler is called).
                    // If you are using the client-side approach, this handler will complete the transaction
                    // and should result in automatic capture based on Razorpay's default settings.
                    handler: (response) => {
                        const orderData = {
                            userId: auth.currentUser.uid,
                            orderId: response.razorpay_payment_id,
                            items: JSON.stringify(cart),
                            totalAmount: totalAmount,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        const userId = auth.currentUser?.uid || crypto.randomUUID();
                        db.collection(`artifacts/${appId}/users/${userId}/orders`).add(orderData)
                            .then(() => {
                                showToast(`Payment Successful! Order ID: ${response.razorpay_payment_id}. Capture status: Automatic (Assumed)`, 'secondary');
                                cart = [];
                                updateCart();
                                cartModal.classList.remove('open');
                            })
                            .catch((error) => {
                                console.error("Error adding document: ", error);
                                showToast("Error saving order details.", 'accent');
                            });
                    },
                    prefill: { name: auth.currentUser.displayName, email: auth.currentUser.email },
                    theme: { color: "#00e5ff" }
                };
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', (response) => {
                    showToast(`Payment Failed: ${response.error.description}`, 'accent');
                });
                rzp.open();
            });

            // --- Order History Logic ---
            orderHistoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (auth.currentUser) {
                    fetchOrderHistory(auth.currentUser.uid);
                } else {
                    authModal.style.display = 'flex';
                }
            });

            closeHistoryBtn.addEventListener('click', () => {
                orderHistoryModal.style.display = 'none';
            });

            async function fetchOrderHistory(currentUserId) {
                orderHistoryList.innerHTML = '<p class="text-center text-gray-500">Loading order history...</p>';
                orderHistoryModal.style.display = 'flex';
                try {
                    const querySnapshot = await db.collection(`artifacts/${appId}/users/${currentUserId}/orders`)
                        .orderBy("timestamp", "desc")
                        .get();
                    
                    if (querySnapshot.empty) {
                        orderHistoryList.innerHTML = '<p class="text-center text-gray-400">You have no past orders.</p>';
                        return;
                    }

                    let ordersHtml = '';
                    querySnapshot.forEach(doc => {
                        const order = doc.data();
                        const orderDate = order.timestamp ? new Date(order.timestamp.seconds * 1000).toLocaleString() : 'Date not available';
                        
                        let itemsHtml = '<ul class="list-disc ml-6 text-gray-400 text-sm">';
                        const items = JSON.parse(order.items);
                        items.forEach(item => {
                            itemsHtml += `<li>${item.name} (x${item.quantity}) - ₹${item.price}</li>`;
                        });
                        itemsHtml += '</ul>';

                        ordersHtml += `
                            <div class="glassmorphism p-4 rounded-lg neon-border mb-4 border-secondary/50">
                                <div class="flex justify-between items-center text-sm mb-2 text-gray-500">
                                    <span>${orderDate}</span>
                                    <span class="truncate ml-2">ID: ${order.orderId.substring(0, 10)}...</span>
                                </div>
                                ${itemsHtml}
                                <div class="text-right font-bold mt-2 text-secondary">
                                    Total: ₹${order.totalAmount}
                                </div>
                            </div>
                        `;
                    });
                    orderHistoryList.innerHTML = ordersHtml;

                } catch (error) {
                    console.error("Error fetching order history: ", error);
                    orderHistoryList.innerHTML = '<p class="text-center text-accent">Could not load order history. Please try again later.</p>';
                }
            }


            // --- Parallax Scrolling Effect ---
            const sections = document.querySelectorAll('.section');
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset;
                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const offset = rect.top + scrollTop;
                    const parallaxFactor = (scrollTop - offset) * 0.05;
                    section.style.transform = `translateY(${parallaxFactor}px)`;
                });
            });

            // --- Mobile Menu Toggle ---
            mobileToggle.addEventListener('click', () => navMenu.classList.toggle('active'));

            // --- Auth Modal Logic ---
            // NOTE: Changing classList.remove/add('hidden') to element.style.display for centering consistency
            loginBtnNav.addEventListener('click', (e) => { e.preventDefault(); authModal.style.display = 'flex'; });
            closeAuthBtn.addEventListener('click', () => authModal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target == authModal) authModal.style.display = 'none'; });
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    authTabs.forEach(item => item.classList.remove('active', 'text-secondary'));
                    tab.classList.add('active', 'text-secondary');
                    authForms.forEach(form => form.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab + '-form').classList.remove('hidden');
                });
            });
            
            // --- FIX: Google Sign-In Function using signInWithRedirect ---
            googleLoginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    // Use signInWithRedirect instead of signInWithPopup to avoid environment security restrictions
                    await auth.signInWithRedirect(provider); 
                    // Note: Execution stops here as the page redirects.
                } catch (error) {
                    console.error("Google Sign-In Error (Pre-Redirect):", error);
                    showToast(`Google Sign-In Failed: ${error.message.split(' (')[0]}`, 'accent');
                }
            });
            // --- END FIX: Google Sign-In Function ---

            // --- Firebase Auth Listener & Profile Setup ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    loginBtnNav.classList.add('hidden');
                    userStatus.classList.remove('hidden');
                    userName.textContent = user.displayName || user.email;
                    userAvatar.textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                    
                    // Set up Firestore listener for the current user's progress
                    setupProgressListener(user.uid);
                    document.getElementById('skill-tree-status').textContent = "Double-click a node to mark as complete/incomplete!";
                    suggestionsSidebar.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    userId = null;
                    loginBtnNav.classList.remove('hidden');
                    userStatus.classList.add('hidden');
                    setupProgressListener(null); // Stop listener and clear progress
                    document.getElementById('skill-tree-status').textContent = "Log in to view your personalized progress.";
                    suggestionsSidebar.classList.add('opacity-50', 'pointer-events-none');
                }
            });
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                auth.signInWithEmailAndPassword(loginForm['login-email'].value, loginForm['login-password'].value)
                    .then(() => { 
                        authModal.style.display = 'none'; 
                    })
                    .catch(error => console.error(error.message));
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                auth.createUserWithEmailAndPassword(registerForm['register-email'].value, registerForm['register-password'].value)
                    .then(cred => cred.user.updateProfile({ displayName: registerForm['register-name'].value }))
                    .then(() => { 
                        authModal.style.display = 'none'; 
                    })
                    .catch(error => console.error(error.message));
            });
            
            // Update the general logout button and add profile modal logic
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    profileModal.style.display = 'none';
                    showToast("Signed out successfully.");
                });
            });
            profileLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    profileModal.style.display = 'none';
                    showToast("Signed out successfully.");
                });
            });

            // --- Profile Modal Logic ---
            userAvatar.addEventListener('click', () => {
                const user = auth.currentUser;
                if (!user) return;
                
                profileDisplayName.textContent = user.displayName || 'N/A';
                profileEmail.textContent = user.email || 'N/A';
                profileUserId.textContent = user.uid;
                
                profileModal.style.display = 'flex';
            });

            closeProfileBtn.addEventListener('click', () => profileModal.style.display = 'none');

            editProfileBtn.addEventListener('click', () => {
                 const newName = prompt("Enter your new display name:");
                 if (newName && newName.trim()) {
                     auth.currentUser.updateProfile({ displayName: newName.trim() })
                        .then(() => {
                            showToast("Display name updated!", 'secondary');
                            profileDisplayName.textContent = newName.trim();
                            userName.textContent = newName.trim();
                            userAvatar.textContent = newName.trim().charAt(0).toUpperCase();
                        })
                        .catch(error => showToast(`Error updating name: ${error.message}`, 'accent'));
                 }
            });

            // --- START: Component Data Source (Including Sensor Types) ---
            // (Minimal data retained for demonstration)
            const componentsData = {
                resistor: { 
                    title: "Resistor", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczM5DWsnmgZvpw6xGHEEEktIuWpG_2IgRAkg3UqDhJhLkhTGR-qN4sKz5KJGk59I7DljumSSSTUMvkmU1TBUu0ZcFo8Px9_2-Lbc3U5aFi3EHs1lw4w=w2400", 
                    definition: "A resistor is a passive two-terminal electrical component that implements electrical resistance as a circuit element. It opposes the flow of electric current.", 
                    symbol: "American-style: zigzag line (\\text{⏚}), International Standard: rectangular box (\\text{□}).", 
                    characteristics: ["Opposes the flow of electric current", "Measured in Ohms (\\Omega)", "Power rating determines how much heat it can dissipate", "Available in fixed and variable (potentiometer) types"], 
                    applications: "Used to reduce current flow, adjust signal levels, divide voltages, and terminate transmission lines." 
                },
                capacitor: { 
                    title: "Capacitor", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPIFWmSYlWVRR-_NyU_lEwCq2w6eiT4qLNVR0t6j_u3RJsQZ6gsJrlvSoMxB40_CnLlRBGS3lqfD2bFnKJYJAGAjpgmhxUOsyJHt9IEEeBaY3VSJ3M=w2400", 
                    definition: "A capacitor is a device that stores electrical energy in an electric field by accumulating electric charges on two closely spaced surfaces that are insulated from each other.", 
                    symbol: "Two parallel lines (\\text{||}).", 
                    characteristics: ["Stores electrical energy", "Measured in Farads (F)", "Voltage rating", "Equivalent series resistance (ESR)", "Polarity (for electrolytic capacitors)"], 
                    applications: "Energy storage, power conditioning, signal coupling, noise filtering, and timing circuits." 
                },
                inductor: {
                    title: "Inductor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOKm6h3B8Y1XzU1Qo5FjM2Yd7D2H2w2Qh7v4e2Z2Zl9v0h2W2F6H2o0Z_v9w_20e4o2k5A1H8j1o7e8k-5y5y5o2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "An inductor, also known as a coil or choke, is a passive two-terminal electrical component that stores energy in a magnetic field when electric current flows through it.",
                    symbol: "Series of curved lines (\\text{∿})",
                    characteristics: ["Stores energy in a magnetic field", "Measured in Henries (H)", "Opposes changes in current"],
                    applications: "Used in AC power supplies, filters, transformers, and resonant circuits."
                },
                diode: { 
                    title: "Diode", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPIGgW9jnLCV_xkerbMAlFm4i22hiFNcMnGwhHzJhlOkd47lhbaSlq3AMgDvUFJ-JebDt2yAabU__TTkfLRHcJgUjDNO4iAhQMgPjOfKvCuYjHWniA=w2400", 
                    definition: "A diode is a semiconductor device that essentially acts as a one-way switch for current. It allows current to flow easily in one direction but severely restricts it in the opposite direction.", 
                    symbol: "A triangle pointing towards a vertical line (\\text{➡️|}).", 
                    characteristics: ["Allows current to flow in one direction only", "Forward voltage drop (typically 0.7V for silicon diodes)", "Reverse breakdown voltage"], 
                    applications: "Rectification (converting AC to DC), voltage regulation (Zener diodes), signal demodulation, over-voltage protection, and light emission (LEDs)." 
                },
                transistor: { 
                    title: "Transistor", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOmfnJTs0Ee3i2ff3Sgp1_z5Egi40fXXU_ROMRHsj2U-TW8rJMg4VPMTmjk6_2UXYLotzUnwz-9FWZd0fXazbzeaRKIywkFrNYH11AmsmLdikoPzUA=w2400", 
                    definition: "A transistor is a semiconductor device used to amplify or switch electronic signals and electrical power.", 
                    symbol: "For NPN: Arrow pointing out from the base, for PNP: Arrow pointing toward the base.", 
                    characteristics: ["Three terminals: emitter, base, and collector", "Current gain (\\beta)", "Maximum voltage and current ratings", "Switching speed"], 
                    applications: "Amplifiers, electronic switches, digital logic gates, voltage regulators, and oscillators." 
                },
                ic: {
                    title: "Integrated Circuit (IC)",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczODx-Vv2K4k5h7v-M_5r3l4p9Q4p5-p5f4a7j1Q1d5f3j1o8f5k-e8t-d6f7l2-k7p8p9t3f3t6a7r4s5o2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "An integrated circuit (IC) is a miniaturized electronic circuit consisting of semiconductor devices, passive components, and wiring, all on a single chip.",
                    symbol: "Usually a rectangle with pins and a functional block diagram inside.",
                    characteristics: ["High density of components", "Small size and weight", "Performs complex functions", "Can be analog, digital, or mixed-signal"],
                    applications: "Microprocessors, memory chips, amplifiers, timers, and logic circuits."
                },
                'arduino-uno': {
                    title: "Arduino Uno",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPj2b8n_p2_d_d8r3t1y_S8c2J1V6c2c7p_d2f2d4e3s0y_t4y2h8t2w2v2c9h9p5u2b4j5p4y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "The Arduino Uno is a microcontroller board based on the ATmega328P. It's the most popular and versatile board for beginners due to its simplicity and extensive documentation.",
                    symbol: "A drawing of the Arduino Uno board.",
                    characteristics: ["Microcontroller: ATmega328P", "Digital I/O Pins: 14 (6 with PWM)", "Analog Inputs: 6", "Clock Speed: 16 MHz", "Memory: 32 KB Flash, 2 KB SRAM"],
                    applications: "Introductory projects, educational kits, simple robotics, and home automation."
                },
                'arduino-nano': {
                    title: "Arduino Nano",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczMxDJ1DYRkYFc8XHzRXvRxWvtAxdtZKdSKIgwEaQKvaE1ta6iS3ArcMxN1A_oID7ZwX2NFgLe_ZlARx5cteynnTuRrmwbkG_WY3em8GK2KF5B9M6vE=w2400",
                    definition: "The Arduino Nano is a small, complete, and breadboard-friendly board based on the ATmega328P. It's ideal for projects where space is a concern.",
                    symbol: "A drawing of the Arduino Nano board.",
                    characteristics: ["Microcontroller: ATmega328P", "Digital I/O Pins: 14 (6 with PWM)", "Analog Inputs: 8", "Clock Speed: 16 MHz", "Memory: 32 KB Flash, 2 KB SRAM"],
                    applications: "Compact projects, wearable electronics, small robots, and DIY gadgets."
                },
                'arduino-mega': {
                    title: "Arduino Mega",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczMmkQtt_r5x6efheqMEzQSETivFrbS7uwLexrsAqTUyihi7SgPYaqbafao3anY1RooXH5jEc9Pr3zswdPusbrZ83K0ZshkZOm2KANi5ih_T0HTEl-k=w2400",
                    definition: "The Arduino Mega 2560 is a microcontroller board based on the ATmega2560. It is designed for more complex projects that require more I/O pins, memory, and communication ports.",
                    symbol: "A drawing of the Arduino Mega board.",
                    characteristics: ["Microcontroller: ATmega2560", "Digital I/O Pins: 54 (15 with PWM)", "Analog Inputs: 16", "Clock Speed: 16 MHz", "Memory: 256 KB Flash, 8 KB SRAM"],
                    applications: "3D printers, complex robotics, data loggers, and projects with multiple sensors and actuators."
                },
                esp32: {
                    title: "ESP32",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczMxDJ1DYRkYFc8XHzRXvRxWvtAxdtZKdSKIgwEaQKvaE1ta6iS3ArcMxN1A_oID7ZwX2NFgLe_ZlARx5cteynnTuRrmwbkG_WY3em8GK2KF5B9M6vE=w2400",
                    definition: "The ESP32 is a series of low-cost, low-power system on a chip microcontrollers with integrated Wi-Fi and dual-mode Bluetooth.",
                    symbol: "A chip with an antenna.",
                    characteristics: ["Integrated Wi-Fi and Bluetooth", "Dual-core processor", "Low-power consumption", "High number of GPIO pins"],
                    applications: "Internet of Things (IoT) projects, smart home devices, wearable electronics, and mesh network applications."
                },
                raspberrypi: {
                    title: "Raspberry Pi Pico",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPHWYIWyDHIoI8jrNslElD9kybYvRDS8gEVGb1uZk2Hohh-V9klz8cATkS8vGcw0E7UOuMVb56ltuUOpPdy-U0Lak2WUIcCX12X4i3VEKcbGtjDbZg=w2400",
                    definition: "The Raspberry Pi Pico is a powerful, low-cost microcontroller board from the Raspberry Pi Foundation, featuring their own RP2040 chip.",
                    symbol: "A drawing of the Raspberry Pi Pico board.",
                    characteristics: ["Dual-core ARM Cortex-M0+ processor", "High-performance and low-power", "Flexible I/O with Programmable I/O (PIO)", "Supports MicroPython and C/C++ programming"],
                    applications: "Robotics, digital art projects, embedded machine learning, and hardware interfacing."
                },
                stm32: {
                    title: "STM32",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPj2b8n_p2_d_d8r3t1y_S8c2J1V6c2c7p_d2f2d4e3s0y_t4y2h8t2w2v2c9h9p5u2b4j5p4y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "STM32 is a family of 32-bit microcontroller integrated circuits by STMicroelectronics, based on the ARM Cortex-M processor.",
                    symbol: "A series of chips.",
                    characteristics: ["High processing power", "Wide variety of peripherals", "Low-power modes", "Used in professional and industrial applications"],
                    applications: "Industrial control, motor control, medical devices, consumer electronics, and automotive systems."
                },
                avr: {
                    title: "AVR",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOh7-k6R4p4m7g0j-m4p5j9y3s2f7h1e1p8w8x3g7l9d4u1q1c5a7p5y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "AVR is a family of microcontrollers developed by Atmel (now part of Microchip Technology) and are known for their simplicity and efficiency.",
                    symbol: "A chip.",
                    characteristics: ["8-bit and 32-bit architectures", "RISC instruction set", "On-chip Flash memory and SRAM", "Used in Arduino boards"],
                    applications: "Hobby electronics, educational kits, embedded systems, and consumer appliances."
                },
                pic: {
                    title: "PIC",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczM_5g_3p8_d1q9p4n7j9t1y_S8c2J1V6c2c7p_d2f2d4e3s0y_t4y2h8t2w2v2c9h9p5u2b4j5p4y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "PIC (Peripheral Interface Controller) is a family of microcontrollers by Microchip Technology, known for their simple architecture and wide availability.",
                    symbol: "A chip.",
                    characteristics: ["Low-power consumption", "RISC architecture", "Extensive peripheral support", "Used in a wide range of applications"],
                    applications: "Consumer electronics, automotive systems, industrial control, and embedded systems."
                },
                ultrasonic: { 
                    title: "Ultrasonic Sensor", 
                    img: "https://lh3.googleusercontent.com/pw/AP1GczMr6sKqBE4JXSzECuWVL8JAn7xYFqihazO-x5Re1IOGe-1eFwimuW-ASLWk1_NBAqo5nc8YUJJWuybEiRdhy_rRc0oiB85hiZs-cVutP8x361z3tDg=w2400", 
                    definition: "An ultrasonic sensor is an electronic device that measures the distance to an object by emitting and receiving high-frequency sound waves.", 
                    symbol: "Typically represented with a speaker and microphone symbols.", 
                    characteristics: ["Operating frequency: 40 kHz", "Measures distance to objects", "Requires trigger and echo pins", "Reliable in various lighting conditions"], 
                    applications: "Obstacle detection, liquid level measurement, robotics, and parking assistance." 
                },
                pir: {
                    title: "PIR Motion Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOCqXW3n6d-t_y5K8y2T8s0r8W0w2E6q2n8v3a0g4w5g6s8x1d6l8f9y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A Passive Infrared (PIR) sensor is an electronic sensor that measures infrared (IR) light radiating from objects in its field of view, detecting motion.",
                    symbol: "Typically represented as a semi-circle with lines radiating outward.",
                    characteristics: ["Detects motion by sensing heat changes", "Passive sensor (does not emit energy)", "Adjustable sensitivity and delay time", "Commonly used in security systems"],
                    applications: "Security alarms, automatic lighting systems, motion-activated cameras, and smart home devices."
                },
                temperature: {
                    title: "Temperature Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPg1wW7-p9g_T4Z3y8s7h9q7l2a3b4c5d6e7f8g9h0i1j1k1l1m4o4q1r2s3t3u3v3w3x3y3z3a2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A temperature sensor is a device, typically a thermocouple or thermistor, that measures temperature and converts it into an electrical signal.",
                    symbol: "A circle with a thermometer-like symbol inside.",
                    characteristics: ["Measures temperature in Celsius, Fahrenheit, or Kelvin", "Can be analog or digital", "Varying degrees of accuracy"],
                    applications: "Weather stations, thermostats, smart home devices, and industrial process control."
                },
                humidity: {
                    title: "Humidity Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczO2gVb_j1l2o6o4h5t8i0x1n2p7q9r1e1u3v4w5g6h7i8j8k9l8m7n7o5p4q3r1e1u3v4w5g6h7i8j8k9l8m7n7o5p4q3r1-R-1n2p7Q3E=w2400",
                    definition: "A humidity sensor, also known as a hygrometer, is a device that detects and measures the amount of water vapor in the air.",
                    symbol: "A circle with a water drop symbol inside.",
                    characteristics: ["Measures relative humidity (RH)", "Can be combined with a temperature sensor (e.g., DHT11)", "Crucial for indoor climate control and agriculture"],
                    applications: "Weather stations, smart greenhouses, humidifiers, and HVAC systems."
                },
                light: {
                    title: "Light Sensor (LDR)",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOaQc-e1i5k3e2h3i4j5k6l7m8n9o0p1q1r2s3t3u4v5w5x3y2z1a2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A Light-Dependent Resistor (LDR) or photoresistor is a component whose resistance decreases with increasing incident light intensity.",
                    symbol: "A resistor symbol with a circle around it and arrows pointing in.",
                    characteristics: ["Resistance changes with light intensity", "Simple and inexpensive", "Used in analog light-sensing circuits"],
                    applications: "Automatic street lights, light-activated alarms, and camera light meters."
                },
                gas: {
                    title: "Gas Sensor (MQ series)",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczO4wUaCNA1YtgMGIXYfHBkPdXIqv-Nhm_jU-060QjUuy9Q1U75Pa6ci1l1qujYxvj_5dAwSEQIrYGh0twldk6RmtX1i6ukHGfvpzaYh1UnLwHCroOo=w2400",
                    definition: "Gas sensors, like the MQ series, are electronic devices used to detect the presence and concentration of various gases in the air.",
                    symbol: "A rectangle with a gas-like symbol inside.",
                    characteristics: ["Detects gases like CO, LPG, smoke, alcohol", "Output is an analog signal that varies with gas concentration", "Requires a pre-heating period to operate"],
                    applications: "Gas leak detection, air quality monitoring, fire alarms, and breathalyzers."
                },
                soilmoisture: {
                    title: "Soil Moisture Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPSn8S_b2V4h3T9c8d6i5j7k_2L1V7d3w8x3g7h5i1j1k1l1m4o4q1r2s3t3u3v3w3x3y3z3a2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A soil moisture sensor measures the volumetric water content in the soil. It works by measuring the dielectric permittivity of the soil.",
                    symbol: "A fork-like symbol with a water drop.",
                    characteristics: ["Measures water content in soil", "Analog or digital output", "Can be sensitive to corrosion"],
                    applications: "Smart agriculture, automated plant watering systems, and gardening."
                },
                rfid: {
                    title: "RFID Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPj2b8n_p2_d_d8r3t1y_S8c2J1V6c2c7p_d2f2d4e3s0y_t4y2h8t2w2v2c9h9p5u2b4j5p4y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "RFID (Radio-Frequency Identification) uses radio waves to wirelessly transfer data from an RFID tag to a reader.",
                    symbol: "A circle with radio waves emanating from it.",
                    characteristics: ["Non-contact identification", "Can read multiple tags simultaneously", "Different operating frequencies (low, high, ultra-high)", "Tags can be active or passive"],
                    applications: "Access control systems, asset tracking, inventory management, and contactless payments."
                },
                accelerometer: {
                    title: "Accelerometer",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczOHx-Vv2K4k5h7v-M_5r3l4p9Q4p5-p5f4a7j1Q1d5f3j1o8f5k-e8t-d6f7l2-k7p8p9t3f3t6a7r4s5o2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "An accelerometer is a device that measures proper acceleration, a three-axis vector quantity.",
                    symbol: "A circle with a gear-like symbol inside.",
                    characteristics: ["Measures acceleration, tilt, and vibration", "Can detect static and dynamic forces", "Used in conjunction with a gyroscope for orientation"],
                    applications: "Motion-activated games, drones, self-balancing robots, and wearables."
                },
                sound: {
                    title: "Sound Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPg1wW7-p9g_T4Z3y8s7h9q7l2a3b4c5d6e7f8g9h0i1j1k1l1m4o4q1r2s3t3u3v3w3x3y3z3a2a1X88v5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A sound sensor, also known as a sound detector or microphone module, is a device that detects sound waves and converts them into electrical signals.",
                    symbol: "A circle with a microphone symbol inside.",
                    characteristics: ["Detects sound levels and frequency", "Can be analog or digital", "Sensitivity can often be adjusted"],
                    applications: "Sound-activated switches, voice-controlled systems, and noise monitoring."
                },
                heartbeat: {
                    title: "Heartbeat Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczN_Vv-o4s_t-x-y-z-1u-2v-3w-4x-5g-8w-9f-8d-8g-8h-9j9k8l8m7n7o5p4q3r1e1u3v4w5g6h7i8j8k9l8m7n7o5p4q3r1-R-1n2p7Q3E=w2400",
                    definition: "A heartbeat sensor is a device that measures the rate of heartbeat. It works on the principle of photoplethysmography (PPG) to detect changes in blood volume in the fingertip.",
                    symbol: "A heart with a pulse line.",
                    characteristics: ["Measures heart rate in BPM", "Non-invasive", "Requires a finger to be placed on the sensor pad"],
                    applications: "Health monitoring devices, fitness trackers, and stress level indicators."
                },
                gesture: {
                    title: "Gesture Sensor",
                    img: "https://lh3.googleusercontent.com/pw/AP1GczPj2b8n_p2_d_d8r3t1y_S8c2J1V6c2c7p_d2f2d4e3s0y_t4y2h8t2w2v2c9h9p5u2b4j5p4y5u3r8q-3k5w_8d5gA8W3h4L5o7b-R-1n2p7Q3E=w2400",
                    definition: "A gesture sensor is an electronic device that can recognize and interpret human gestures, such as hand movements. It uses infrared light to detect proximity and motion.",
                    symbol: "A hand icon with motion lines.",
                    characteristics: ["Detects gestures like wave, swipe, and scroll", "Works with infrared light", "Provides non-contact control"],
                    applications: "Human-computer interaction (HCI), touchless switches, and robotics control."
                }
            };
            // --- END: Component Data Source ---


            // FIX: Component Data Display Logic
            componentCards.forEach(card => {
                card.addEventListener('click', () => {
                    const componentType = card.dataset.component;
                    const compData = componentsData[componentType];
                    
                    stopSensorVisualization(); // Stop any existing visualization

                    if (compData) {
                        detailTitle.textContent = compData.title;
                        detailImg.src = compData.img;
                        detailDefinition.textContent = compData.definition;
                        
                        // Show/Hide Sensor Visualization Area
                        if (compData.isSensor) {
                            sensorVizArea.classList.remove('hidden');
                            if (compData.sensorType === 'ultrasonic') {
                                // Only start the complex mock for the specified Ultrasonic Sensor
                                startSensorVisualization('ultrasonic');
                            } else {
                                sensorDataReadout.textContent = `Live Mock unavailable for ${compData.title}.`;
                            }
                        } else {
                            stopSensorVisualization();
                        }
                        
                        try {
                            const tempDiv = document.createElement('div');
                            const latexString = compData.symbol.replace(/\\text\{/g, '\\text{').replace(/}/g, '}');
                            
                            if (latexString.includes('\\Omega') || latexString.includes('\\text{') || latexString.includes('}')) {
                                katex.render(latexString, detailSymbol, { displayMode: false, throwOnError: true });
                            } else {
                                detailSymbol.textContent = compData.symbol;
                            }
                        } catch (e) {
                             console.error("KaTeX rendering failed:", e);
                             detailSymbol.textContent = compData.symbol; 
                        }

                        detailCharacteristics.innerHTML = compData.characteristics.map(char => `<li>${char}</li>`).join('');
                        
                        detailCharacteristics.querySelectorAll('li').forEach(li => {
                            if (window.renderMathInElement) {
                                renderMathInElement(li);
                            }
                        });
                        
                        detailApplications.textContent = compData.applications;
                        
                        askTechwhizComponentBtn.dataset.componentName = compData.title;

                        componentDetailModal.style.display = 'flex';
                    } else {
                        // Fallback if data is missing
                        // ... (Fallback logic removed for file size) ...
                        componentDetailModal.style.display = 'flex';
                    }
                });
            });

            closeDetailBtn.addEventListener('click', () => { 
                componentDetailModal.style.display = 'none'; 
                stopSensorVisualization(); // Stop visualization when closing
            });
            
            // Close component modal if clicking outside
            componentDetailModal.addEventListener('click', (e) => {
                if (e.target === componentDetailModal) {
                    componentDetailModal.style.display = 'none';
                    stopSensorVisualization(); // Stop visualization when closing
                }
            });

            // NEW: Contextual AI button handler
            askTechwhizComponentBtn.addEventListener('click', () => {
                const componentName = askTechwhizComponentBtn.dataset.componentName || 'this component';
                const prompt = `Explain the key function and most common applications of the ${componentName} for a beginner in electronics.`;
                
                // Close component modal and open TechWhiz modal
                componentDetailModal.style.display = 'none';
                stopSensorVisualization(); // Stop visualization before moving
                techwhizModal.style.display = 'flex';
                
                // Inject prompt into chat input and trigger submission
                techwhizInput.value = prompt;
                sendBtn.click();
            });


            // --- TechWhiz Assistant Logic (Updated for Multilingual) ---
            let recognition;
            let isListening = false;
            const synth = window.speechSynthesis;
            let currentUtterance = null;
            const geminiApiKey = ""; // Using empty string for auto-injection

            techwhizFab.addEventListener('click', () => techwhizModal.style.display = 'flex');
            closeTechwhizModalBtn.addEventListener('click', () => {
                techwhizModal.style.display = 'none';
                if (synth.speaking) synth.cancel();
                if (isListening) recognition.stop();
            });

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    micBtn.classList.add('speech-active');
                    listeningStatus.classList.remove('hidden');
                };
                
                recognition.onresult = (event) => { 
                    const transcript = event.results[0][0].transcript;
                    techwhizInput.value = transcript;
                };

                recognition.onerror = (event) => {
                    console.error('Speech Recognition Error:', event.error);
                };

                recognition.onend = () => {
                    isListening = false;
                    micBtn.classList.remove('speech-active');
                    listeningStatus.classList.add('hidden');
                    
                    if (techwhizInput.disabled) return;

                    const command = techwhizInput.value.trim();
                    if (command) {
                        processCommand(command);
                    }
                };
            } else {
                micBtn.disabled = true;
            }

            micBtn.addEventListener('click', () => { 
                if (isListening) { 
                    recognition.stop(); 
                } else { 
                    techwhizInput.value = ''; 
                    recognition.start(); 
                } 
            });

            sendBtn.addEventListener('click', () => { 
                if (isListening) {
                    recognition.stop();
                } else {
                    const command = techwhizInput.value.trim(); 
                    if (command) processCommand(command); 
                }
            });
            
            techwhizInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendBtn.click(); });
            stopSpeechBtn.addEventListener('click', () => { if (synth.speaking) synth.cancel(); });

            function appendMessage(message, sender) { 
                const msgDiv = document.createElement('div'); 
                msgDiv.className = `chat-message p-3 rounded-lg max-w-[85%] w-fit ${sender === 'user' ? 'bg-secondary text-white rounded-br-none self-end ml-auto' : 'bg-gray-800 text-white rounded-bl-none self-start mr-auto'}`; 
                msgDiv.textContent = message; 
                chatHistory.prepend(msgDiv);
                if(chatHistory.childElementCount > 10) {
                  chatHistory.removeChild(chatHistory.lastChild);
                }
            }

            function readAloud(text) { 
                if (synth.speaking) synth.cancel(); 
                currentUtterance = new SpeechSynthesisUtterance(text); 
                currentUtterance.onend = () => currentUtterance = null; 
                synth.speak(currentUtterance); 
            }
            
            async function callGeminiApi(prompt, systemInstruction = null) {
                if (geminiApiKey === "") {
                    // This logic assumes the environment will inject the key, if not, it will fail gracefully.
                    // If the environment does not inject, the network request will simply fail.
                }
                
                let backoff = 1000;
                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        let chatHistoryForApi = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = {
                            contents: chatHistoryForApi,
                            systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined
                        };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                await new Promise(resolve => setTimeout(resolve, backoff));
                                backoff *= 2;
                                continue;
                            }
                            const errorBody = await response.json();
                            throw new Error(`API error: ${response.status} - ${errorBody.error.message}`);
                        }
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure how to respond to that.";
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        if (i === maxRetries - 1) throw error;
                    }
                }
            }

            async function processCommand(command) {
                if (!command || techwhizInput.disabled) return;
                appendMessage(command, 'user');
                techwhizInput.value = '';

                techwhizInput.disabled = true;
                sendBtn.disabled = true;
                micBtn.disabled = true;
                thinkingStatus.classList.remove('hidden');

                try {
                    let responseText = '';
                    const lowerCommand = command.toLowerCase();

                    let baseSystemInstruction = "You are a professional and helpful electronics and computer science assistant. Provide a friendly and concise answer. Respond exclusively in the language of the user's query. Do not refer to yourself as an AI or a language model.";

                    if (lowerCommand.includes('what is arduino')) {
                        responseText = await callGeminiApi(command, baseSystemInstruction + " Provide a concise, single-paragraph explanation of what an Arduino is for beginners.");
                    } else {
                        responseText = await callGeminiApi(command, baseSystemInstruction);
                    }
                    
                    appendMessage(responseText, 'assistant');
                    readAloud(responseText);
                } catch (error) {
                    const errorMsg = "Sorry, I'm having trouble connecting to my brain right now.";
                    appendMessage(errorMsg, 'assistant');
                    readAloud(errorMsg);
                } finally {
                    techwhizInput.disabled = false;
                    sendBtn.disabled = false;
                    micBtn.disabled = false;
                    thinkingStatus.classList.add('hidden');
                    techwhizInput.focus();
                }
            }
            
            // Initialization
            renderProjects();
            updateCart();
            // Start the skill tree render with an empty progress object initially
            renderSkillTree({});
            
            if (window.renderMathInElement) {
                renderMathInElement(document.body);
            }
        });
    </script>
</body>
</html>
